<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 6 Dealing with covariates | Bayesian analysis of capture-recapture data with hidden Markov models</title>
<meta name="author" content="Olivier Gimenez">
<meta name="description" content="6.1 Introduction Capture–recapture models often aim not just to estimate demographic parameters, but also to understand what drives their variation as we have seen in Chapter 4. In this chapter,...">
<meta name="generator" content="bookdown 0.43 with bs4_book()">
<meta property="og:title" content="Chapter 6 Dealing with covariates | Bayesian analysis of capture-recapture data with hidden Markov models">
<meta property="og:type" content="book">
<meta property="og:url" content="https://oliviergimenez.github.io/banana-book/covariateschapter.html">
<meta property="og:description" content="6.1 Introduction Capture–recapture models often aim not just to estimate demographic parameters, but also to understand what drives their variation as we have seen in Chapter 4. In this chapter,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 6 Dealing with covariates | Bayesian analysis of capture-recapture data with hidden Markov models">
<meta name="twitter:description" content="6.1 Introduction Capture–recapture models often aim not just to estimate demographic parameters, but also to understand what drives their variation as we have seen in Chapter 4. In this chapter,...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Theory and case studies in R and NIMBLE">Bayesian analysis of capture-recapture data with hidden Markov models</a>:
        <small class="text-muted">Theory and case studies in R and NIMBLE</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></li>
<li><a class="" href="intronimble.html"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="" href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></li>
<li class="book-part">Transitions</li>
<li><a class="" href="introduction-4.html">Introduction</a></li>
<li><a class="" href="survival.html"><span class="header-section-number">4</span> Alive and dead</a></li>
<li><a class="" href="dispersal.html"><span class="header-section-number">5</span> Sites and states</a></li>
<li class="book-part">Case studies</li>
<li><a class="" href="introduction-7.html">Introduction</a></li>
<li><a class="active" href="covariateschapter.html"><span class="header-section-number">6</span> Dealing with covariates</a></li>
<li><a class="" href="lackoffit.html"><span class="header-section-number">7</span> Addressing model lack of fit</a></li>
<li><a class="" href="tradeoffs.html"><span class="header-section-number">8</span> Quantifying life history traits</a></li>
<li><a class="" href="conclusion.html">Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/oliviergimenez/banana-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="covariateschapter" class="section level1" number="6">
<h1>
<span class="header-section-number">6</span> Dealing with covariates<a class="anchor" aria-label="anchor" href="#covariateschapter"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-8" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-8"><i class="fas fa-link"></i></a>
</h2>
<p>Capture–recapture models often aim not just to estimate demographic parameters, but also to understand what drives their variation as we have seen in Chapter <a href="survival.html#survival">4</a>. In this chapter, we explore how to incorporate covariates – whether measured at the individual or temporal scale. We cover selecting covariates from a potentially large set, using an extension of standard MCMC algorithms known as reversible jump MCMC (RJMCMC), and handling uncertainty in key covariates, namely age or sex, when these are not perfectly known for all individuals.</p>
</div>
<div id="covariate-selection-with-reversible-jump-mcmc" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Covariate selection with Reversible Jump MCMC<a class="anchor" aria-label="anchor" href="#covariate-selection-with-reversible-jump-mcmc"><i class="fas fa-link"></i></a>
</h2>
<div id="motivation" class="section level3" number="6.2.1">
<h3>
<span class="header-section-number">6.2.1</span> Motivation<a class="anchor" aria-label="anchor" href="#motivation"><i class="fas fa-link"></i></a>
</h3>
<p>In Section <a href="survival.html#waic">4.6</a>, we used WAIC to figure our which model, among several candidates, was best supported by the data. Each model there represented a different ecological hypothesis. Now when you are in a situation where you have several individual or temporal covariates that might explain variation in some demographic parameters, say survival as in Section <a href="survival.html#covariates">4.8</a>, things can quickly become a bit more tedious.</p>
<p>Let’s look at a real-world example: The white stork (<em>Ciconia ciconia</em>) population in Baden-Württemberg, Germany. From the 1960s to the 1990s, all Western European stork populations were in decline. One leading hypothesis was that these declines were driven by reduced food availability, itself caused by severe droughts in the storks’ wintering grounds in the Sahel region (e.g. <span class="citation">Kanyamibwa et al. (<a href="references.html#ref-kanya90">1990</a>)</span>, <span class="citation">Grosbois et al. (<a href="references.html#ref-grosbois_assessing_2008">2008</a>)</span>).</p>
<p>To explore this idea, we’ll use rainfall measurements from 10 meteorological stations chosen to represent the storks’ wintering area: Diourbel, Gao, Kayes, Kita, Maradi, Mopti, Ouahigouya, Ségou, Tahoua, and Tombouctou. The data we have are the cumulative rainfall amounts (in mm) over June, July, August, and September – roughly the rainy season in the Sahel.</p>
<pre><code>##      Diourbel  Gao Kayes  Kita Maradi Mopti Ouahigouya
## [1,]     6770 1900  7130 11350   6970  6580       6220
## [2,]     6420 2690  6180 13690   5880  6470       6260
## [3,]     6890 3530  6480 11820   6100  5230       6730
## [4,]     5700 2710  8440  9590   5210  5670       5670
## [5,]     6760 2090  6910  9850   6020  4200       5630
## [6,]     5432 2100  6300  8960   6890  3900       7180
##      Ségou Tahoua Tombouctou
## [1,]  8380   3920       1390
## [2,]  7530   3200       2210
## [3,]  6340   5170       1760
## [4,]  7490   4370       2580
## [5,]  5920   3120       2340
## [6,]  6461   3891       2020</code></pre>
<p>Our question is: Which combination of these stations best explains variation in survival? If we tried to answer this by testing every possible model, we would have to consider every subset of the 10 stations and compare 1024 models (2^10 combinations). That’s far too many for a WAIC-based approach to be practical.</p>
<p>Instead of comparing all possible models one by one, we can use Reversible Jump MCMC (RJMCMC). RJMCMC is an extension of standard Bayesian inference that treats the model itself as an extra (discrete) parameter. In this framework, the posterior distribution spans both the parameter space (e.g. regression coefficients) and the model space (e.g. which covariates are included).</p>
<p>To work out the (marginal) posterior probability of each model, we integrate over the parameters using MCMC. Standard MCMC algorithms cannot handle this model-switching scenario, but RJMCMC is designed precisely for it and can explore parameters and models together within a single Markov chain. In other words, RJMCMC can ‘jump’ between models, turning covariates on or off. RJMCMC is like a hiker exploring different trails (models), stopping along each one to take measurements (parameters) before deciding whether to switch to another. From this, we can estimate the posterior probability that each covariate influences survival, as well as model-averaged regression coefficients and survival estimates that account for both parameter and model uncertainty.</p>
<p>We won’t dive into the mathematical details here but don’t worry, you can still follow the analysis without them. Check out Chapter 7 of <span class="citation">King et al. (<a href="references.html#ref-king_bayesian_2009">2009</a>)</span> (see also <span class="citation">Gimenez et al. (<a href="references.html#ref-gimenez2009winbugs">2009</a>)</span>) if you’re interested in.</p>
</div>
<div id="model-and-nimble-implementation" class="section level3" number="6.2.2">
<h3>
<span class="header-section-number">6.2.2</span> Model and NIMBLE implementation<a class="anchor" aria-label="anchor" href="#model-and-nimble-implementation"><i class="fas fa-link"></i></a>
</h3>
<p>For our example, we’ll work with data from 321 encounter histories of white storks ringed as chicks between 1956 and 1970. We’ll fit a Cormack–Jolly–Seber (CJS) model with time-dependent survival and constant detection probability, as described in Section <a href="survival.html#cjsderivatives">4.5</a>. We model the survival probability <code>phi</code> as a linear function of our covariates stored in <code>x</code>. To handle model selection inside the RJMCMC, we use a clever trick: for each covariate, we introduce an indicator variable <code>ksi</code> that can take the value 1 (covariate is included in the model) or 0 (covariate is excluded). We then combine the regression coefficients <code>beta</code> with these indicators into a single vector <code>betaksi</code>. This means that if <code>ksi[j] = 0</code>, the effect of covariate <code>j</code> is zero, effectively removing it from the model. Here’s how it works in the NIMBLE code:</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="cn">T</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gtools/man/logit.html">logit</a></span><span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">intercept</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html">inprod</a></span><span class="op">(</span><span class="va">betaksi</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="va">t</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>      <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>  <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>           <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>           <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For the indicators and regression coefficients:</p>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">betaksi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">ksi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>  <span class="va">ksi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span> <span class="co">## indicator variable associated with betaj</span></span>
<span><span class="op">}</span></span>
<span><span class="va">psi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="co">## hyperprior on inclusion probability</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">beta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="co"># prior slopes</span></span>
<span><span class="op">}</span></span>
<span><span class="va">intercept</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="co"># prior intercept</span></span></code></pre></div>
<p>The prior on <code>psi</code> controls the overall tendency to include covariates in the model. Setting it to <code>dbeta(1, 1)</code> makes all inclusion probabilities equally likely, so the data drive the selection. The priors on <code>beta</code> and the <code>intercept</code> (not consider in the selection) are weakly informative.</p>
<p>As we saw in Section <a href="intronimble.html#change-sampler">2.6.1</a>, NIMBLE allows you to change the default sampler. Here, we’re going to do something slightly different and use NIMBLE’s <code><a href="https://rdrr.io/pkg/nimble/man/configureRJ.html">configureRJ()</a></code> function to set up RJMCMC for variable selection. The function <code><a href="https://rdrr.io/pkg/nimble/man/configureRJ.html">configureRJ()</a></code> modifies an existing MCMC configuration so that RJMCMC is used to sample certain parameters, allowing covariates to be turned on or off during the run. It uses a univariate normal proposal distribution, and you can adjust the proposal mean and scale. The main arguments are:<br>
- <code>targetNodes</code>: The parameters you want to apply variable selection to (e.g. <code>beta</code>);<br>
- <code>indicatorNodes</code>: The indicator variables paired with the target nodes (e.g. <code>ksi</code>);<br>
- <code>control</code>: A list for fine-tuning the proposal with <code>mean</code> the mean of the proposal distribution (default is 0), <code>scale</code> the standard deviation of the proposal (default is 1) and <code>fixedValue</code> the value a variable takes when excluded (default is 0).</p>
<p>Here’s how we apply it to our white stork example:</p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Build the model and configure default MCMC</span></span>
<span><span class="va">RJsurvival</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">hmm.phirjmcmcp</span>, </span>
<span>                          constants <span class="op">=</span> <span class="va">my.constants</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">my.data</span>,</span>
<span>                          inits <span class="op">=</span> <span class="fu">initial.values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Csurvival</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="va">RJsurvival</span><span class="op">)</span></span>
<span></span>
<span><span class="va">RJsurvivalConf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html">configureMCMC</a></span><span class="op">(</span><span class="va">RJsurvival</span><span class="op">)</span></span>
<span><span class="va">RJsurvivalConf</span><span class="op">$</span><span class="fu">addMonitors</span><span class="op">(</span><span class="st">'ksi'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Switch to reversible jump sampling for the betas</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureRJ.html">configureRJ</a></span><span class="op">(</span>conf <span class="op">=</span> <span class="va">RJsurvivalConf</span>,</span>
<span>            targetNodes <span class="op">=</span> <span class="st">'beta'</span>,</span>
<span>            indicatorNodes <span class="op">=</span> <span class="st">'ksi'</span>,</span>
<span>            control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span>, scale <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then build, compile, and run the RJMCMC:</p>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survivalMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html">buildMCMC</a></span><span class="op">(</span><span class="va">RJsurvivalConf</span><span class="op">)</span></span>
<span><span class="va">CsurvivalMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html">compileNimble</a></span><span class="op">(</span><span class="va">survivalMCMC</span>, project <span class="op">=</span> <span class="va">RJsurvival</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/runMCMC.html">runMCMC</a></span><span class="op">(</span>mcmc <span class="op">=</span> <span class="va">CsurvivalMCMC</span>, </span>
<span>                   niter <span class="op">=</span> <span class="va">n.iter</span>,</span>
<span>                   nburnin <span class="op">=</span> <span class="va">n.burnin</span>,</span>
<span>                   nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span></span></code></pre></div>
<p>When we run this MCMC, <code><a href="https://rdrr.io/pkg/nimble/man/configureRJ.html">configureRJ()</a></code> takes care of proposing moves that either keep a covariate in the model or drop it out by setting its <code>ksi</code> value to 0. If a covariate is included (<code>ksi = 1</code>), the sampler updates its regression coefficient <code>beta</code> using the specified normal proposal distribution. If it’s excluded (<code>ksi = 0</code>), the coefficient is fixed at zero (our <code>fixedValue</code>). Over many iterations, the chain ‘jumps’ between different combinations of covariates, building up posterior probabilities for each one’s inclusion. This means we can later summarise which covariates are most likely to affect survival (via their inclusion probabilities), and model-averaged estimates of survival that incorporate the uncertainty about which covariates belong in the model. This is what we do in <code>R</code> in the next section.</p>
</div>
<div id="results-and-interpretation" class="section level3" number="6.2.3">
<h3>
<span class="header-section-number">6.2.3</span> Results and interpretation<a class="anchor" aria-label="anchor" href="#results-and-interpretation"><i class="fas fa-link"></i></a>
</h3>
<p>The RJMCMC run gives us the posterior probabilities of different models where each model corresponds to a specific combination of covariates. In our white stork example, the results clearly show that the model including only the rainfall at the Kita station (covariate #4) is best supported by the data.</p>
<p>To get these results, we first combine the MCMC samples from our two chains:</p>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gather two chains</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">samples</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">samples</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Next, we look at the inclusion indicators <code>ksi</code>, which take value 1 if a covariate is in the model and 0 if not. The posterior mean of each <code>ksi[j]</code> is simply the estimated probability that covariate j is included:</p>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Number of covariates</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Extract only ksi columns, in order ksi[1], ..., ksi[10]</span></span>
<span><span class="va">ksi</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"ksi["</span>, <span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Posterior inclusion probabilities for each covariate</span></span>
<span><span class="va">inclusion_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">ksi</span><span class="op">)</span></span>
<span><span class="va">inclusion_prob</span></span>
<span><span class="co">##  ksi[1]  ksi[2]  ksi[3]  ksi[4]  ksi[5]  ksi[6]  ksi[7] </span></span>
<span><span class="co">## 0.02575 0.01720 0.01560 0.96120 0.04430 0.05350 0.02025 </span></span>
<span><span class="co">##  ksi[8]  ksi[9] ksi[10] </span></span>
<span><span class="co">## 0.03360 0.02630 0.02965</span></span></code></pre></div>
<p>The posterior inclusion probabilities tell us how likely each covariate is to appear in the ‘true’ model given the data and priors. Here, <code>ksi[4]</code> – the Kita station – stands out, with an inclusion probability around 0.96.</p>
<p>We can also identify the most probable models visited by the RJMCMC. Each MCMC draw corresponds to a model, which we encode as a binary string (e.g., “0101001001”):</p>
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Encode each model draw as a string of 0s and 1s</span></span>
<span><span class="va">model_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">ksi</span>, <span class="fl">1</span>, <span class="va">paste0</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Empirical posterior model probabilities</span></span>
<span><span class="va">post_model_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">model_id</span><span class="op">)</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the top models</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">post_model_prob</span><span class="op">)</span>, </span>
<span>                prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">post_model_prob</span><span class="op">)</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">##         model    prob</span></span>
<span><span class="co">## 1  0001000000 0.75470</span></span>
<span><span class="co">## 2  0001010000 0.03965</span></span>
<span><span class="co">## 3  0001100000 0.02910</span></span>
<span><span class="co">## 4  0000000000 0.02310</span></span>
<span><span class="co">## 5  0001000001 0.02055</span></span>
<span><span class="co">## 6  0001000100 0.01710</span></span>
<span><span class="co">## 7  0001000010 0.01660</span></span>
<span><span class="co">## 8  1001000000 0.01575</span></span>
<span><span class="co">## 9  0001001000 0.01320</span></span>
<span><span class="co">## 10 0101000000 0.01045</span></span></code></pre></div>
<p>The posterior model probabilities rank the different combinations of covariates, and in our case, the model containing only the rainfall at Kita is clearly dominant.</p>
<p>In conclusion, a very high inclusion probability for Kita (covariate #4) and a dominant model containing only Kita indicate that this station’s rainfall is strongly linked to survival, while others are not.</p>
<p>Now turning to inference, we’d like to get model-averaged parameters. Each covariate’s effect is ‘on’ only when its indicator (<code>ksi</code>) is 1. Multiplying <code>beta</code> by <code>ksi</code> zeros out the effect when that covariate is excluded. Summarising <code>betaksi</code> across draws gives the model-averaged effect on the logit scale:</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pull posterior draws</span></span>
<span><span class="va">beta</span>  <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"beta["</span>, <span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Model-averaged coefficients on the logit scale</span></span>
<span><span class="va">betaksi</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">ksi</span></span>
<span></span>
<span><span class="co"># Summaries: mean, 95% credible intervals, and Pr(effect &gt; 0)</span></span>
<span><span class="va">df_betaksi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  mean  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">betaksi</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>  low  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">betaksi</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">2.5</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  high  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">betaksi</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">97.5</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  P_gt0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">betaksi</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">df_betaksi</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">##            mean    low  high P_gt0</span></span>
<span><span class="co">## beta[1]   0.003  0.000 0.000 0.023</span></span>
<span><span class="co">## beta[2]   0.000  0.000 0.000 0.009</span></span>
<span><span class="co">## beta[3]   0.000  0.000 0.000 0.010</span></span>
<span><span class="co">## beta[4]   0.348  0.000 0.545 0.961</span></span>
<span><span class="co">## beta[5]  -0.006 -0.123 0.000 0.003</span></span>
<span><span class="co">## beta[6]   0.007  0.000 0.144 0.051</span></span>
<span><span class="co">## beta[7]  -0.002  0.000 0.000 0.004</span></span>
<span><span class="co">## beta[8]   0.005  0.000 0.048 0.028</span></span>
<span><span class="co">## beta[9]   0.002  0.000 0.000 0.021</span></span>
<span><span class="co">## beta[10] -0.003 -0.020 0.000 0.003</span></span></code></pre></div>
<p>A large <code>P_gt0</code> (e.g., &gt; 0.95) suggests strong evidence that the covariate increases survival (on the logit scale), while values near 0.5 mean the direction is uncertain.</p>
<p>Now let’s get model-averaged survival estimates over time. For each MCMC draw, we build the linear predictor with all covariates using <code>beta * ksi</code>, add the intercept, then inverse-logit to get survival <code>phi</code>:</p>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">invlogit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Table of covariate values</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">rainfall</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">16</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Intercept MCMC draws</span></span>
<span><span class="va">intercept</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="st">"intercept"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Linear predictor for every time t (rows) and every MCMC draw (columns)</span></span>
<span><span class="va">eta</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">betaksi</span><span class="op">)</span> </span>
<span><span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">eta</span>, <span class="fl">2</span>, <span class="va">intercept</span>, <span class="st">"+"</span><span class="op">)</span>  <span class="co"># add intercept per draw</span></span>
<span></span>
<span><span class="co"># Back-transform to survival probabilities</span></span>
<span><span class="va">phi_draws</span> <span class="op">&lt;-</span> <span class="fu">invlogit</span><span class="op">(</span><span class="va">eta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summaries by time</span></span>
<span><span class="va">df_phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  mean  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">phi_draws</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>  low  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">phi_draws</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">2.5</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  high  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">phi_draws</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">97.5</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df_phi</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1956</span><span class="op">:</span><span class="fl">1970</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">low</span>, ymax <span class="op">=</span> <span class="va">high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Years (interval start)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Survival probability"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Model-averaged survival with 95% credible intervals"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-367-1.png" width="672"></div>
<p>Shaded ribbons show 95% credible intervals; the solid line is the posterior mean of survival, model-averaged over covariate inclusion.</p>
</div>
</div>
<div id="ageuncertainty" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Uncertainty in age<a class="anchor" aria-label="anchor" href="#ageuncertainty"><i class="fas fa-link"></i></a>
</h2>
<div id="motivation-1" class="section level3" number="6.3.1">
<h3>
<span class="header-section-number">6.3.1</span> Motivation<a class="anchor" aria-label="anchor" href="#motivation-1"><i class="fas fa-link"></i></a>
</h3>
<p>Survival and other demographic parameters often differ between young and older animals, so if we blur age classes we can end up telling the wrong story about population dynamics. In Section <a href="survival.html#agecov">4.8.5</a>, we incorporated age as a covariate in capture-recapture models, assuming it was perfectly known. With non-invasive genetics (Figure <a href="survival.html#fig:marking">4.1</a>), though, age is not observed: a DNA profile can identify who was there, but not how old they were. If we ignore that uncertainty, survival estimates can be biased. As we saw in Section <a href="dispersal.html#multievent">5.7</a>, HMM capture–recapture models can handle this kind of problem by treating age as a hidden state and separating it from what we actually observe in the field.</p>
<p>A neat example comes from Apennine brown bears in <span class="citation">Gervasi et al. (<a href="references.html#ref-Gervasi2017">2017</a>)</span> (see also <span class="citation">Gowan et al. (<a href="references.html#ref-gowan2021uncertainty">2021</a>)</span>). Because you cannot age a bear from its DNA, the authors paired genetics with field information to classify detections into two broad age classes, cubs (&lt;1 year) and adults (≥1 year). To do so, they used two criteria. First, classify a newly detected bear as a cub in that year if it was sampled at least once on the same date and site as a known adult female and they shared ≥1 allele at every locus (mother–offspring consistent). That’s the lenient criterion (P1). Second, apply a stricter criterion (P2): make the same mother–offspring call, but require two or more such co-sampling occasions with the same female, again on the same date and site each time.</p>
<p>Why two criteria? Because there’s a trade-off. P1 is better at catching real cubs (more sensitive) but risks misclassifying some adults as cubs; P2 is more conservative about calling ‘cub’, so it reduces false cubs but misses some true ones.</p>
<p>Instead of pretending these criteria are perfect, the authors model the misclassification explicitly: age is hidden, ‘cub/adult by P1/P2’ is what we observe, and their model estimates both classification accuracy and age-specific survival at the same time. That way, uncertainty is propagated into the demographic estimates rather than swept under the rug.</p>
<p>Here, I show how to encode that logic in an HMM with NIMBLE: define the hidden age states, write the transition (survival) and detection components, and add a classification step that links hidden age to the observed P1/P2 outcomes. We’ll also see how a small subset of known-age individuals (e.g., live-trapped or aged beforehand) anchors the classification step. The payoff is a set of age-specific survival estimates that are robust to imperfect age assignment, which is exactly what we need for sound ecological inference and management.</p>
</div>
<div id="model-and-nimble-implementation-1" class="section level3" number="6.3.2">
<h3>
<span class="header-section-number">6.3.2</span> Model and NIMBLE implementation<a class="anchor" aria-label="anchor" href="#model-and-nimble-implementation-1"><i class="fas fa-link"></i></a>
</h3>
<p>To estimate bear survival, we have at our disposal a 12-year time series of non-invasive genetic sampling data, collected between 2003 and 2014. To build up our model, we first define the states and observations:</p>
<ul>
<li>states
<ul>
<li>alive as cub (C)</li>
<li>alive as adult (A)</li>
<li>dead (D)</li>
</ul>
</li>
<li>observations
<ul>
<li>not detected (1)</li>
<li>detected and classified as cub by both criteria (2)</li>
<li>detected and classified as cub by P1 only (3)</li>
<li>detected and classified as adult by both criteria (4)</li>
</ul>
</li>
</ul>
<p>Now we turn to writing our model.</p>
<p>We start with the vector of initial states. Unknown-age individuals enter as a mixture of cub/adult with probabilities <span class="math inline">\(\pi\)</span> and <span class="math inline">\(1-\pi\)</span>:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\delta} =
  \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          z_t=C &amp; z_t=A &amp; z_t=D \\ \hdashline
          \pi &amp; 1 - \pi &amp; 0\\
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
\begin{matrix}
\end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\pi\)</span> is the probability of being alive as a cub, and <span class="math inline">\(1 - \pi\)</span> is the probability of being alive as an adult. For bears known-age at first detection, we fix the initial state accordingly. In NIMBLE we implement this with an individual-specific <span class="math inline">\(\delta_i\)</span> using <code>equals()</code> to pin known ages:</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initial state</span></span>
<span><span class="co"># age[i] == 0 → unknown → use probabilistic delta: pi, 1 - pi</span></span>
<span><span class="co"># age[i] == 1 → known cub → force delta to [1, 0, 0]</span></span>
<span><span class="co"># age[i] == 2 → known adult → force delta to [0, 1, 0]</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">equals</span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">+</span> <span class="fu">equals</span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># Pr(C)</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="fl">2</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">equals</span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="fu">equals</span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>  <span class="co"># Pr(A)</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="fl">3</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We proceed with the transition matrix that contains the survival probabilities. A cub either survives and becomes adult next year (<span class="math inline">\(\phi_C\)</span>), or dies; adults either survive in the same class (<span class="math inline">\(\phi_A\)</span>) or die:
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Gamma} =
  \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          z_t=C &amp; z_t=A &amp; z_t=D \\ \hdashline
          0  &amp; \phi_C &amp; 1 - \phi_C\\
          0 &amp; \phi_A &amp; 1 - \phi_A\\
          0 &amp; 0 &amp; 1
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1}=C \\ z_{t-1}=A \\ z_{t-1}=D
\end{matrix}
\end{matrix}\]</span></p>
<p>Following the paper, adult survival is sex-specific; cub survival is common to both sexes:</p>
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Transition matrix</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phiC</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phiC</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phiA</span><span class="op">[</span><span class="va">sex</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>   <span class="co"># sex-specific adult survival (1=f, 2=m)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phiA</span><span class="op">[</span><span class="va">sex</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Last step is about the observations, which arise in two steps: detection then classification. For the detection matrix, we need to introduce intermediate observations, say <span class="math inline">\(y'\)</span> for not detected (1), detected as cub (2) and detected as adult (2):
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Gamma_1} =
  \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          y'_t=1 &amp; y'_t=2 &amp; y'_t=3 \\ \hdashline
          1-p_C  &amp; p_C &amp; 0\\
          1-p_A &amp; 0 &amp; 1 - p_A\\
          1 &amp; 0 &amp; 0
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t}=C \\ z_{t}=A \\ z_{t}=D
\end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(p_C\)</span> is detection for cubs, and <span class="math inline">\(p_A\)</span> that for adults. Then the classification matrix is:
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Omega_2} =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=1 &amp; y_t=2 &amp; y_t=3 &amp; y_t=4\\ \hdashline
1 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; \beta_{C,CC} &amp; \beta_{C,CA} &amp; 1 - \beta_{C,CC} - \beta_{C,CA}\\
0 &amp; \beta_{A,CC} &amp; \beta_{A,CA} &amp; 1 - \beta_{A,CC} - \beta_{A,CA}\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    y'_{t}=1 \\ y'_{t}=2 \\ y'_{t}=3
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\beta_{C,CC}\)</span> is the probability that, being a cub, and individual is classified with both criteria, <span class="math inline">\(\beta_{C,CA}\)</span> is the probability that, being a cub, an individual is classified as cub with P1 and as adult with P2, <span class="math inline">\(\beta_{A,CC}\)</span> is the probability that, being an adult, an individual is classified as cub with both criteria, <span class="math inline">\(\beta_{A,CA}\)</span> is the probability that, being an adult, an individual is classified as cub with P1 and as adult with P2.</p>
<p>The observation matrix is the product of the two detection and classification matrices <span class="math inline">\(\mathbf{\Omega_1} \mathbf{\Omega_2}\)</span>:
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Omega} =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=1 &amp; y_t=2 &amp; y_t=3 &amp; y_t=4\\ \hdashline
1-p_C &amp; p_C \beta_{C,CC} &amp; p_C \beta_{C,CA} &amp; p_C (1 - \beta_{C,CC} - \beta_{C,CA})\\
1-p_A &amp; p_A \beta_{A,CC} &amp; p_A \beta_{A,CA} &amp; p_A (1 - \beta_{A,CC} - \beta_{A,CA})\\
1 &amp; 0 &amp; 0 &amp; 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=1 \\ z_{t}=2 \\ z_{t}=3
    \end{matrix}
\end{matrix}\]</span></p>
<p>In code, we write <span class="math inline">\(\mathbf{\Omega_1} \mathbf{\Omega_2}\)</span> directly (faster than doing the matrix multiplication at each iteration). For simplicity we use a single detection probability <span class="math inline">\(p\)</span> for both ages, but you can let <span class="math inline">\(p\)</span> vary by age/sex/year or sampling method, as in the paper:</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Observation matrix</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">betaCCC</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">betaCCA</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">betaCCC</span> <span class="op">-</span> <span class="va">betaCCA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">betaACC</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">betaACA</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">betaACC</span> <span class="op">-</span> <span class="va">betaACA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>At first detection, the event ‘not detected’ is impossible by construction (we condition on the first detection). We therefore use an initial observation matrix <span class="math inline">\(\mathbf{\Omega}_{\text{init}}\)</span> with <span class="math inline">\(p\)</span> set to 1 (not shown).</p>
<p>The likelihood and priors are handled as usual.</p>
</div>
<div id="results-and-interpretation-1" class="section level3" number="6.3.3">
<h3>
<span class="header-section-number">6.3.3</span> Results and interpretation<a class="anchor" aria-label="anchor" href="#results-and-interpretation-1"><i class="fas fa-link"></i></a>
</h3>
<p>Here are the raw results:</p>
<pre><code>##         mean   sd 2.5%  50% 97.5% Rhat n.eff
## betaACA 0.05 0.02 0.02 0.04  0.08 1.00  4114
## betaACC 0.02 0.01 0.00 0.02  0.05 1.00  4211
## betaCCA 0.57 0.12 0.33 0.58  0.79 1.00   966
## betaCCC 0.30 0.10 0.13 0.29  0.50 1.00   998
## p       0.71 0.04 0.63 0.71  0.79 1.00  3329
## phiA[1] 0.88 0.03 0.80 0.88  0.94 1.00  4195
## phiA[2] 0.82 0.06 0.69 0.82  0.92 1.00  3643
## phiC    0.53 0.13 0.28 0.53  0.78 1.00  3563
## pi      0.27 0.09 0.12 0.26  0.49 1.02  1416</code></pre>
<p>which we can arrange in a table to compare them with the results obtained by <span class="citation">Gervasi et al. (<a href="references.html#ref-Gervasi2017">2017</a>)</span>:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-372">Table 6.1: </span>Comparison of parameter estimates for the same HMM to account for age uncertainty: our NIMBLE fit vs. Gervasi et al. (2017, Table 3). Intervals are 95% credible intervals for NIMBLE and confidence intervals for Gervasi et al.. Detection in Gervasi et al. varies by design/year; we report their overall average.</caption>
<colgroup>
<col width="45%">
<col width="24%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th align="left">Quantity</th>
<th align="center">Our (NIMBLE)</th>
<th align="center">Gervasi et al. (2017)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
<span class="math inline">\(\phi_C\)</span> (cub survival)</td>
<td align="center">0.53 (0.28–0.78)</td>
<td align="center">0.51 (0.22–0.79)</td>
</tr>
<tr class="even">
<td align="left">
<span class="math inline">\(\phi_{A,f}\)</span> (adult female)</td>
<td align="center">0.88 (0.80–0.94)</td>
<td align="center">0.92 (0.87–0.95)</td>
</tr>
<tr class="odd">
<td align="left">
<span class="math inline">\(\phi_{A,m}\)</span> (adult male)</td>
<td align="center">0.82 (0.69–0.92)</td>
<td align="center">0.85 (0.76–0.91)</td>
</tr>
<tr class="even">
<td align="left">
<span class="math inline">\(p\)</span> (detection)</td>
<td align="center">0.71 (0.63–0.79)</td>
<td align="center">≈0.71 (0.62–0.79)</td>
</tr>
<tr class="odd">
<td align="left">
<span class="math inline">\(\pi\)</span> (cub at first detection)</td>
<td align="center">0.27 (0.12–0.49)</td>
<td align="center">0.062 (0.007–0.396)</td>
</tr>
<tr class="even">
<td align="left">
<span class="math inline">\(C_{c,cc}\)</span> (cub by both)</td>
<td align="center">0.30 (0.13–0.50)</td>
<td align="center">0.40 (0.15–0.72)</td>
</tr>
<tr class="odd">
<td align="left">
<span class="math inline">\(C_{c,ca}\)</span> (cub by P1 only)</td>
<td align="center">0.57 (0.33–0.79)</td>
<td align="center">0.60 (0.28–0.85)</td>
</tr>
<tr class="even">
<td align="left">
<span class="math inline">\(C_{a,cc}\)</span> (adult→cub by both)</td>
<td align="center">0.02 (0.00–0.05)</td>
<td align="center">0.067 (0.024–0.174)</td>
</tr>
<tr class="odd">
<td align="left">
<span class="math inline">\(C_{a,ca}\)</span> (adult→cub by P1 only)</td>
<td align="center">0.05 (0.02–0.08)</td>
<td align="center">0.191 (0.110–0.309)</td>
</tr>
</tbody>
</table></div>
<p>Our NIMBLE fit reproduces the main biological signals reported for the Apennine brown bear. Survival shows the expected ordering, that cubs &lt;&lt; adults, and adult females &gt; adult males – with estimates that closely match the published analysis. The credible/confidence intervals overlap broadly, indicating good agreement.</p>
<p>Our detection estimate aligns with the study’s average detection, even though their analysis lets detection vary by design and year rather than assuming a single constant value.</p>
<p>For age classification (linking the hidden age to P1/P2 outcomes), mapping our parameters to theirs, we found lower adult-as-cub misclassification than the paper (and thus a higher probability that detected adults are correctly called ‘adult by both’), which still matches their qualitative take: the stricter criterion (P2) performs very well for adults.</p>
<p>The main divergence is in the initial state mix. Intervals overlap, but the means differ. A likely explanation is model structure: we used a single, constant detection probability, while the published analysis allows detection to vary by sampling design and year – and detectability does vary meaningfully across methods and years. Collapsing this heterogeneity into one <span class="math inline">\(p\)</span> can nudge the mixture at first detection toward a higher cub fraction to explain patterns that the richer detection model attributes to design/year effects.</p>
<p>In conclusion, we managed to recover the core findings of the published study (age- and sex-specific survival and average detection). Small discrepancies appear mainly in adult misclassification rates and <span class="math inline">\(\pi\)</span>. To mirror <span class="citation">Gervasi et al. (<a href="references.html#ref-Gervasi2017">2017</a>)</span> even more closely, the natural next step is to let <span class="math inline">\(p\)</span> vary by sampling design/year (an information I did not have), as in their best supported model.</p>
</div>
</div>
<div id="uncertainty-in-sex" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> Uncertainty in sex<a class="anchor" aria-label="anchor" href="#uncertainty-in-sex"><i class="fas fa-link"></i></a>
</h2>
<div id="motivation-2" class="section level3" number="6.4.1">
<h3>
<span class="header-section-number">6.4.1</span> Motivation<a class="anchor" aria-label="anchor" href="#motivation-2"><i class="fas fa-link"></i></a>
</h3>
<p>Many species show sex differences in demographic parameters, so mislabeling sex or discarding uncertain cases can bias the very patterns we want to estimate. In monomorphic birds for example, field sexing relies on behaviour (e.g., copulation posture, courtship displays, relative body size), and those clues vary in reliability; in the Audouin’s gull (<em>Larus audouinii</em>) study that motivates this section, ~80% of individuals were never sexed in the field, making “known-sex only” analyses both wasteful and biased toward higher survival.</p>
<p><span class="citation">Pradel et al. (<a href="references.html#ref-pradel2008sex">2008</a>)</span> (see also <span class="citation">Genovart, Pradel, and Oro (<a href="references.html#ref-genovart_exploiting_2012">2012</a>)</span>) turned this problem into a HMM inference task: treat sex as a hidden state (male/female/dead) and model the sex-assignment process itself. The model developed by Pradel, Genovart and colleagues separates (i) the probability of attempting a sex judgment (with a time trend, because sexing effort increased) from (ii) criterion-specific accuracy for four behavioural clues (copulation, courtship feeding, begging for food, body size).</p>
<!-- Two practical findings drive their design: (1) even the least reliable clue (body size) adds information and improves precision when its error rate is estimated, and (2) a small anchor set of genetically sexed birds (24 individuals) is enough to break the model’s inherent dual-solution/label-switching symmetry and stabilize sex ratio and sex-specific survival estimates (Table 5). -->
<p>In brief, the message is: when field classifications are uncertain, exploit them rather than filter them out—use HMM to couple biological states to imperfect observations and propagate classification uncertainty into survival.</p>
<p>That philosophy mirrors the age-uncertainty Section <a href="covariateschapter.html#ageuncertainty">6.3</a> we just completed: there, age was hidden and P1/P2 provided noisy age labels; here, sex is hidden and multiple behavioural criteria provide noisy sex labels.</p>
</div>
<div id="model-and-nimble-implementation-2" class="section level3" number="6.4.2">
<h3>
<span class="header-section-number">6.4.2</span> Model and NIMBLE implementation<a class="anchor" aria-label="anchor" href="#model-and-nimble-implementation-2"><i class="fas fa-link"></i></a>
</h3>
<p>To estimate Audouin’s gull survival, we have at our disposal a dataset with 4093 marked birds from a colony at the Ebro Delta (Spain), collected over 10 years. To build up our model, we first define the states and observations:</p>
<ul>
<li>states
<ul>
<li>alive as male (M)</li>
<li>alive as female (F)</li>
<li>dead (D)</li>
</ul>
</li>
<li>observations
<ul>
<li>not seen (1)</li>
<li>judged from copulation to be male (2)</li>
<li>judged from begging food to be male (3)</li>
<li>judged from coutship feeding to be male (4)</li>
<li>judged from body size to be male (5)</li>
<li>judged from copulation to be female (6)</li>
<li>judged from begging food to be female (7)</li>
<li>judged from coutship feeding to be female (8)</li>
<li>judged from body size to be female (9)</li>
<li>not judged (10).</li>
</ul>
</li>
</ul>
<p>Now we turn to writing our model.</p>
<p>We start with the vector of initial states. Unknown-sex individuals enter as a mixture of male/female with probabilities <span class="math inline">\(\pi\)</span> and <span class="math inline">\(1-\pi\)</span>:
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\delta} =
  \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          z_t=M &amp; z_t=F &amp; z_t=D \\ \hdashline
          \pi &amp; 1 - \pi &amp; 0\\
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
\begin{matrix}
\end{matrix}
\end{matrix}\]</span></p>
<p>We proceed with the transition matrix that contains the survival probabilities. A male either survives next year as a male (<span class="math inline">\(\phi_M\)</span>), or dies; the same happens for females (with probability <span class="math inline">\(\phi_F\)</span>):
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Gamma} =
  \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          z_t=M &amp; z_t=F &amp; z_t=D \\ \hdashline
          \phi_M  &amp; 0 &amp; 1 - \phi_M\\
          0 &amp; \phi_F &amp; 1 - \phi_F\\
          0 &amp; 0 &amp; 1
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1}=M \\ z_{t-1}=F \\ z_{t-1}=D
\end{matrix}
\end{matrix}\]</span></p>
<p>The vector of initial states and the matrix of transition probabilities are written as usual in NIMBLE:</p>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">delta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pi</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">pi</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phiM</span>            </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>               </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phiM</span>        </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>               </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phiF</span>            </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phiF</span>        </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>               </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>               </span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>               </span></code></pre></div>
<p>Last step is the observation matrix, which we write as follows (its transposed for convenience):
<span class="math display">\[\begin{matrix}
&amp; \\
\mathbf{\Gamma'} =
  \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
          \end{matrix}
          \hspace{-1.2em}
          \begin{matrix}
          z_t=M &amp; z_t=F &amp; z_t=D \\ \hdashline
          1 - p  &amp; 1 - p &amp; 1\\
          p e (1-m_4) m_1 x_1 &amp; p e (1-m_4) m_1 (1-x_1) &amp; 0\\
          p e (1-m_4) m_2 x_2 &amp; p e (1-m_4) m_2 (1-x_2) &amp; 0\\
          p e (1-m_4) m_3 x_3 &amp; p e (1-m_4) m_3 (1-x_3) &amp; 0\\
          p e m_4 x_4 &amp; p e m_4 (1-x_4) &amp; 0\\
          p e (1-m_4) m_1 (1-x_1) &amp; p e (1-m_4) m_1 x_1 &amp; 0\\
          p e (1-m_4) m_2 (1-x_2) &amp; p e (1-m_4) m_2 x_2 &amp; 0\\
          p e (1-m_4) m_3 (1-x_3) &amp; p e (1-m_4) m_3 x_3 &amp; 0\\
          p e m_4 (1-x_4) &amp; p e m_4 x_4 &amp; 0\\
          p (1-e) &amp; p (1-e) &amp; 0\\
          \end{matrix}
          \hspace{-0.2em}
          \begin{matrix}
          &amp; \\
          \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12\end{matrix} } \right )
\begin{matrix}
y_{t}=1 \\ y_{t}=2 \\ y_{t}=3 \\ y_{t}=4 \\ y_{t}=5 \\ y_{t}=6 \\ y_{t}=7 \\ y_{t}=8 \\ y_{t}=9 \\ y_{t}=10
\end{matrix}
\end{matrix}\]</span></p>
<p>This matrix is a bit more complex than what we have encountered before, and needs some explanations. When an individual is encountered (with probability <span class="math inline">\(p\)</span>), there is some chance that it will be sexed (<span class="math inline">\(e\)</span>) based on its general appearance (body size: probability <span class="math inline">\(m_4\)</span>) or its behaviour (probability <span class="math inline">\(1 - m_4\)</span>). When behaviour is used, there are three different criteria (copulation, begging for food and courtship feeding), which occur with probabilities <span class="math inline">\(m_1\)</span>, <span class="math inline">\(m_2\)</span>, and <span class="math inline">\(m_3\)</span>, respectively. Finally, each criterion has its own reliability (probabilities <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>, <span class="math inline">\(x_3\)</span>, <span class="math inline">\(x_4\)</span>, where <span class="math inline">\(x_4\)</span> is the reliability of the body-size criterion).</p>
<p>I admit that this matrix representation can be difficult to grasp at once. It can be easier to split the observation matrix in several steps, like encountering, sexing, body size sexing, sex determination and correctness, then to sketch a decision treeMaybe a binary tree like in Figure 2 in <span class="citation">Genovart, Pradel, and Oro (<a href="references.html#ref-genovart_exploiting_2012">2012</a>)</span> (see also appendix S1 in <span class="citation">Genovart, Pradel, and Oro (<a href="references.html#ref-genovart_exploiting_2012">2012</a>)</span>).</p>
<p>In code, this gives:</p>
<div class="sourceCode" id="cb332"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p</span>                                  </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">9</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span>      </span>
<span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p</span>                                  </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>      </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>   </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">9</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">e</span> <span class="op">*</span> <span class="va">m</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>   </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">e</span><span class="op">)</span>      </span>
<span></span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>                                  </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">9</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span>
<span><span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>     </span></code></pre></div>
<p>At first detection, the observation ‘not detected’ is impossible by construction (we condition on the first detection). We therefore use an initial observation matrix <span class="math inline">\(\mathbf{\Omega}_{\text{init}}\)</span> with <span class="math inline">\(p\)</span> set to 1 (not shown).</p>
<p>The likelihood and priors are handled as usual.</p>
<!-- sm=b(1); % b(1) survie male -->
<!-- sf=b(2); % b(2) survie femelle -->
<!-- p=zeros(10,1); -->
<!-- p(1)=b(23); % b(23) capture occasion 1 %% oublie initialement -->
<!-- p(2)=b(3); % b(3) capture occasion 2 -->
<!-- p(3)=b(4); % b(4) capture occasion 3 -->
<!-- p(4)=b(5); % b(5) capture occasion 4 -->
<!-- p(5)=b(6); % b(6) capture occasion 5 -->
<!-- p(6)=b(7); % b(7) capture occasion 6 -->
<!-- p(7)=b(8); % b(8) capture occasion 7 -->
<!-- p(8)=b(9); % b(9) capture occasion 8 -->
<!-- p(9)=b(10); % b(10) capture occasion 9 -->
<!-- p(10)=b(11); % b(11) capture occasion 10 -->
<!-- sr=b(12); % b(12) sex-ratio = pourcentage de males -->
<!-- % sr=0.4+0.2*b(12); % b(12) sex-ratio = pourcentage de males -->
<!-- % sr=0.5; -->
<!-- ja=b(13); % b(13) intercept de la proba qu'un individu soit juge (tendance lineaire en fonction du temps) -->
<!-- jb=b(14); % b(14) pente de la proba qu'un individu soit juge (tendance lineaire en fonction du temps) -->
<!-- m4a=b(15); % b(15) intercept de la proba cdle (au jugement) d'un jugement par body size -->
<!-- m4b=b(16); % b(16) pente de la proba cdle (au jugement) d'un jugement par body size -->
<!-- m1=b(17); % b(17) proba cdle (au jugement autre que par body size) d'un jugement par copulation -->
<!-- % m1 proba cdle (au jugement autre que par body size) d'un jugement par copulation -->
<!-- m2=(1-m1)*b(18); % b(18) proba cdle (au jugement autre que par body size ou copulation) d'un jugement par begging food -->
<!-- % m2 proba cdle (au jugement autre que par body size) d'un jugement par begging food -->
<!-- m3=1-m1-m2; -->
<!-- % m3 proba cdle (au jugement autre que par body size) d'un jugement par courtship feeding -->
<!-- e1=b(19); % b(19) proba (cdtnt au jugement par copulation) d'une erreur -->
<!-- e2=b(20); % b(20) proba (cdtnt au jugement par begging food) d'une erreur -->
<!-- e3=b(21); % b(21) proba (cdtnt au jugement par courtship feeding) d'une erreur -->
<!-- e4=b(22); % b(122) proba (cdtnt au jugement par body size) d'une erreur -->
<!-- % e4=0; %TEMPO 11-10-04 -->
<!-- % probabilites des evenements (lignes) conditionnellement aux etats (colonnes) -->
<!-- % male femelle mort(male) mort(femelle) -->
<!-- % ------------------------------------------------------------------------------------ -->
<!-- % 0-pas vu -->
<!-- % 1-comportement copulatoire male -->
<!-- % 2-role male dans "beging food" -->
<!-- % 3-role male dans "courtship feeding" -->
<!-- % 4-grande taille relative -->
<!-- % 5-comportement copulatoire femelle -->
<!-- % 6-role femelle dans "beging food" -->
<!-- % 7-role femelle dans "courtship feeding" -->
<!-- % 8-petite taille relative -->
<!-- % 9-pas de jugement -->
</div>
<div id="results-and-interpretation-2" class="section level3" number="6.4.3">
<h3>
<span class="header-section-number">6.4.3</span> Results and interpretation<a class="anchor" aria-label="anchor" href="#results-and-interpretation-2"><i class="fas fa-link"></i></a>
</h3>
<p>Here are the raw results:</p>
<pre><code>##      mean   sd 2.5%  50% 97.5% Rhat n.eff
## e    0.07 0.00 0.07 0.07  0.07 1.01   589
## m[1] 0.29 0.02 0.26 0.29  0.32 1.00   913
## m[2] 0.60 0.02 0.56 0.60  0.63 1.00   892
## m[3] 0.11 0.01 0.09 0.11  0.14 1.00   817
## m[4] 0.17 0.01 0.14 0.17  0.19 1.01   949
## p    0.65 0.00 0.64 0.65  0.66 1.00   394
## phiF 0.90 0.01 0.89 0.90  0.91 1.01   205
## phiM 0.89 0.01 0.88 0.89  0.90 1.01   279
## pi   0.52 0.01 0.50 0.52  0.55 1.00   291
## x[1] 0.52 0.03 0.45 0.52  0.58 1.01   915
## x[2] 0.55 0.02 0.50 0.55  0.60 1.01   725
## x[3] 0.54 0.05 0.44 0.55  0.65 1.00   927
## x[4] 0.58 0.04 0.50 0.58  0.67 1.00   753</code></pre>
<p>which we can arrange in a table to compare them with the results obtained by <span class="citation">Pradel et al. (<a href="references.html#ref-pradel2008sex">2008</a>)</span>:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-376">Table 6.2: </span>Comparison with Pradel et al. (2007) Table 5, Model B (no genetically sexed anchors). Our error rates are 1 − x[i]. Pradel’s m4 is time-varying; the estimates provided by the main author for m4(t) were for t=1..10: 0.001, 0.002, 0.004, 0.007, 0.014, 0.026, 0.047, 0.084, 0.146, 0.242.</caption>
<colgroup>
<col width="5%">
<col width="30%">
<col width="20%">
<col width="43%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Quantity</th>
<th align="center">Our (NIMBLE)</th>
<th align="center">Pradel et al. (2007) Table 5, Model B</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pi</td>
<td align="left">
<span class="math inline">\(\mu\)</span> (proportion male)</td>
<td align="center">0.52 (0.50–0.55)</td>
<td align="center">0.5325 (SE 0.0286)</td>
</tr>
<tr class="even">
<td align="left">phiF</td>
<td align="left">
<span class="math inline">\(\phi_F\)</span> (female survival)</td>
<td align="center">0.90 (0.89–0.91)</td>
<td align="center">0.9122 (SE 0.0142)</td>
</tr>
<tr class="odd">
<td align="left">phiM</td>
<td align="left">
<span class="math inline">\(\phi_M\)</span> (male survival)</td>
<td align="center">0.89 (0.88–0.90)</td>
<td align="center">0.8597 (SE 0.0141)</td>
</tr>
<tr class="even">
<td align="left">m[1]</td>
<td align="left">
<span class="math inline">\(m_1\)</span> (Copulation)</td>
<td align="center">0.29 (0.26–0.32)</td>
<td align="center">0.2904 (const.)</td>
</tr>
<tr class="odd">
<td align="left">m[2]</td>
<td align="left">
<span class="math inline">\(m_2\)</span> (Begging)</td>
<td align="center">0.60 (0.56–0.63)</td>
<td align="center">0.5973 (const.)</td>
</tr>
<tr class="even">
<td align="left">m[3]</td>
<td align="left">
<span class="math inline">\(m_3\)</span> (Courtship feeding)</td>
<td align="center">0.11 (0.09–0.14)</td>
<td align="center">0.1123 (const.)</td>
</tr>
<tr class="odd">
<td align="left">m[4]</td>
<td align="left">
<span class="math inline">\(m_4\)</span> (Body size)</td>
<td align="center">0.17 (0.14–0.19)</td>
<td align="center">time-varying (see caption)</td>
</tr>
<tr class="even">
<td align="left">x[1]</td>
<td align="left">Error (Copulation)</td>
<td align="center">0.48 (0.42–0.55)</td>
<td align="center">0.0577 (SE 0.0407)</td>
</tr>
<tr class="odd">
<td align="left">x[2]</td>
<td align="left">Error (Begging)</td>
<td align="center">0.45 (0.40–0.50)</td>
<td align="center">0.0561 (SE 0.0308)</td>
</tr>
<tr class="even">
<td align="left">x[3]</td>
<td align="left">Error (Courtship feeding)</td>
<td align="center">0.46 (0.35–0.56)</td>
<td align="center">0.0000 (SE 0.1553)</td>
</tr>
<tr class="odd">
<td align="left">x[4]</td>
<td align="left">Error (Body size)</td>
<td align="center">0.42 (0.33–0.50)</td>
<td align="center">0.0928 (SE 0.0741)</td>
</tr>
</tbody>
</table></div>
<p>Our NIMBLE fit recovers the main biological signals reported for the Audouin’s gulls analysis. Survival shows the expected ordering – adult females ≥ adult males – with broadly overlapping intervals and means that are close to the published model. In our run, the female–male gap is a bit smaller (≈0.90 vs 0.89), but the direction matches the paper’s message (higher female survival).</p>
<p>We used a single, constant detection probability and obtained <span class="math inline">\(p≈0.65\)</span>, which sits near the middle of the year‐specific values reported in the paper.</p>
<p>The estimated probabilities of which clue is used align closely with the published analysis for the three ‘behavioural’ criteria: <span class="math inline">\(m_1 \approx 0.29\)</span> (copulation), <span class="math inline">\(m_2 \approx 0.60\)</span> (begging), <span class="math inline">\(m_3 \approx 0.11\)</span> (courtship feeding). The paper lets body size use vary over time; our constant estimate (<span class="math inline">\(m_4 \approx 0.17\)</span>) should be read as a pooled average across years—consistent with their finding of a low but increasing use of this criterion.</p>
<p>The main tension with lies in the error rates by criterion. The published analysis finds low misclassification (roughly 5–10% for most criteria, with a very imprecise estimate for courtship feeding). Our fit suggests substantially higher error across criteria. That discrepancy is where we expect sensitivity when there are no known‐sex anchors (and some components are simplified). Without anchors, the model can admit dual solutions (swapping sex labels and flipping error probabilities) that fit nearly equally well; small modelling choices or initial values can tip the chain toward one mode, see <span class="citation">Pradel et al. (<a href="references.html#ref-pradel2008sex">2008</a>)</span>.</p>
<p>Our estimate of the proportion of males at first encounter (<span class="math inline">\(\mu \approx 0.52\)</span>) agrees closely with the published result, reinforcing that the state mix is well constrained by the data even when sex is uncertain.</p>
<p>To conclude, the sex‐uncertainty HMM retrieves the core demographic pattern (female ≥ male survival) and matches the paper on overall detectability and the use of criteria. To mirror the published results more closely, one could add a small anchor set of genetically sexed individuals (an information used in <span class="citation">Pradel et al. (<a href="references.html#ref-pradel2008sex">2008</a>)</span> but that I did not have).</p>
<!-- ## Covariate selection with reversible jump MCMC -->
<!-- RJMCMC in @gimenez2009fitness on Common blackbirds or @gimenez2009winbugs on White stork. -->
<!-- As an illustration, we use data on the white stork *Ciconia ciconia* population in Baden Wurttemberg (Germany), consisting of 321 capture histories of individuals ringed as chicks between 1956 and 1971. From the 60's to the 90's, all Western European stork populations were declining @bair91. This trend was likely the result of reduced food availability @schau05 caused by severe droughts observed in the wintering ground of storks in the Sahel region. This hypothesis has been examined in several studies (@kanya90 and @barb99).  -->
<!-- Check out <https://r-nimble.org/nimbleExamples/RJMCMC_example.html> and <https://r-nimble.org/variable-selection-in-nimble-using-reversible-jump-mcmc>. -->
<!-- Somewhere explain how to use if-else in model code to consider alternative models, w/ some covariate in/out. Avoids rewriting all models, we see what's changed, and it avoids errors. Example: -->
<!-- ```{r eval = FALSE} -->
<!-- if(covariate){ -->
<!-- logit(survival[t]) <- beta[1] + beta[2] *x[t] -->
<!-- }else{ -->
<!-- logit(survival[t]) <- beta[1] -->
<!-- }#ifelse -->
<!-- ``` -->
<!-- then specify "covariate=TRUE/FALSE". -->
<!-- ## Missing values {#naincov} -->
<!-- Work on missing values by @bonner2006 (see @gimenez2009winbugs) and @langrock2013maximum and @worthington2015. See also @rose2018. -->
<!-- ## Nonlinearities -->
<!-- Splines à la @gimenez_semiparametric_2006, possibly w/ jagam <https://rdrr.io/cran/mgcv/src/R/jagam.r>.  -->
<!-- ## Spatial -->
<!-- 3D Splines as in @Peron2011. (I)CAR as in @saracco2010icar (see  (<https://github.com/Andrew9Lawson/Bayesian-DM-code-examples>, <https://github.com/Andrew9Lawson/Bayesian_DM_Nimble_code/tree/ICAR-and-other-code> and <https://r-nimble.org/html_manual/cha-spatial.html> for NIMBLE implementation). Add RSR @khan2022rsr (see Jags code at <https://gist.github.com/oliviergimenez/0d5519654adef09060581eb49e2128ce>).  -->

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="introduction-7.html">Introduction</a></div>
<div class="next"><a href="lackoffit.html"><span class="header-section-number">7</span> Addressing model lack of fit</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#covariateschapter"><span class="header-section-number">6</span> Dealing with covariates</a></li>
<li><a class="nav-link" href="#introduction-8"><span class="header-section-number">6.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#covariate-selection-with-reversible-jump-mcmc"><span class="header-section-number">6.2</span> Covariate selection with Reversible Jump MCMC</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#motivation"><span class="header-section-number">6.2.1</span> Motivation</a></li>
<li><a class="nav-link" href="#model-and-nimble-implementation"><span class="header-section-number">6.2.2</span> Model and NIMBLE implementation</a></li>
<li><a class="nav-link" href="#results-and-interpretation"><span class="header-section-number">6.2.3</span> Results and interpretation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ageuncertainty"><span class="header-section-number">6.3</span> Uncertainty in age</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#motivation-1"><span class="header-section-number">6.3.1</span> Motivation</a></li>
<li><a class="nav-link" href="#model-and-nimble-implementation-1"><span class="header-section-number">6.3.2</span> Model and NIMBLE implementation</a></li>
<li><a class="nav-link" href="#results-and-interpretation-1"><span class="header-section-number">6.3.3</span> Results and interpretation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#uncertainty-in-sex"><span class="header-section-number">6.4</span> Uncertainty in sex</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#motivation-2"><span class="header-section-number">6.4.1</span> Motivation</a></li>
<li><a class="nav-link" href="#model-and-nimble-implementation-2"><span class="header-section-number">6.4.2</span> Model and NIMBLE implementation</a></li>
<li><a class="nav-link" href="#results-and-interpretation-2"><span class="header-section-number">6.4.3</span> Results and interpretation</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/oliviergimenez/banana-book/blob/master/6-covariates.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/oliviergimenez/banana-book/edit/master/6-covariates.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian analysis of capture-recapture data with hidden Markov models</strong>: Theory and case studies in R and NIMBLE" was written by Olivier Gimenez. It was last built on 2025-08-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>

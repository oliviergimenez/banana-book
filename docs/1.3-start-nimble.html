<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="1.3 Getting started | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models" />
<meta property="og:type" content="book" />

<meta property="og:description" content="This is a textbook on the analysis of capture-recapture data with hidden Markov models (HMM) implemented in the Bayesian framework with R." />
<meta name="github-repo" content="oliviergimenez/banana-book" />

<meta name="author" content="Olivier Gimenez" />

<meta name="date" content="2022-12-23" />


<meta name="description" content="This is a textbook on the analysis of capture-recapture data with hidden Markov models (HMM) implemented in the Bayesian framework with R.">

<title>1.3 Getting started | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</title>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
/* show arrow before summary tag as in bootstrap
TODO: remove if boostrap in updated in html_document (rmarkdown#1485) */
details > summary {
  display: list-item;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#welcome" id="toc-welcome">Welcome</a>
<ul>
<li><a href="license.html#license" id="toc-license">License</a></li>
</ul></li>
<li class="has-sub"><a href="preface.html#preface" id="toc-preface">Preface</a>
<ul>
<li><a href="why-this-book.html#why-this-book" id="toc-why-this-book">Why this book?</a></li>
<li><a href="who-should-read-this-book.html#who-should-read-this-book" id="toc-who-should-read-this-book">Who should read this book?</a></li>
<li><a href="what-will-you-learn.html#what-will-you-learn" id="toc-what-will-you-learn">What will you learn?</a></li>
<li><a href="what-wont-you-learn.html#what-wont-you-learn" id="toc-what-wont-you-learn">What wonâ€™t you learn?</a></li>
<li><a href="prerequisites.html#prerequisites" id="toc-prerequisites">Prerequisites</a></li>
<li><a href="acknowledgements.html#acknowledgements" id="toc-acknowledgements">Acknowledgements</a></li>
<li><a href="how-this-book-was-written.html#how-this-book-was-written" id="toc-how-this-book-was-written">How this book was written</a></li>
</ul></li>
<li><a href="about-the-author.html#about-the-author" id="toc-about-the-author">About the author</a></li>
<li class="part"><span><b>I I. Fundations</b></span></li>
<li><a href="introduction.html#introduction" id="toc-introduction">Introduction</a></li>
<li class="has-sub"><a href="1-intronimble.html#intronimble" id="toc-intronimble"><span class="toc-section-number">1</span> NIMBLE tutorial</a>
<ul>
<li><a href="1.1-introduction-1.html#introduction-1" id="toc-introduction-1"><span class="toc-section-number">1.1</span> Introduction</a></li>
<li><a href="1.2-what-is-nimble.html#what-is-nimble" id="toc-what-is-nimble"><span class="toc-section-number">1.2</span> What is NIMBLE?</a></li>
<li><a href="1.3-start-nimble.html#start-nimble" id="toc-start-nimble"><span class="toc-section-number">1.3</span> Getting started</a></li>
<li class="has-sub"><a href="1.4-functions-in-nimble.html#functions-in-nimble" id="toc-functions-in-nimble"><span class="toc-section-number">1.4</span> Programming</a>
<ul>
<li><a href="1.4-functions-in-nimble.html#nimble-functions" id="toc-nimble-functions"><span class="toc-section-number">1.4.1</span> NIMBLE functions</a></li>
<li><a href="1.4-functions-in-nimble.html#callrfninnimble" id="toc-callrfninnimble"><span class="toc-section-number">1.4.2</span> Calling R/C++ functions</a></li>
<li><a href="1.4-functions-in-nimble.html#user-defined-distributions" id="toc-user-defined-distributions"><span class="toc-section-number">1.4.3</span> User-defined distributions</a></li>
</ul></li>
<li><a href="1.5-under-the-hood.html#under-the-hood" id="toc-under-the-hood"><span class="toc-section-number">1.5</span> Under the hood</a></li>
<li class="has-sub"><a href="1.6-mcmc-samplers.html#mcmc-samplers" id="toc-mcmc-samplers"><span class="toc-section-number">1.6</span> MCMC samplers</a>
<ul>
<li><a href="1.6-mcmc-samplers.html#change-sampler" id="toc-change-sampler"><span class="toc-section-number">1.6.1</span> Default samplers</a></li>
<li><a href="1.6-mcmc-samplers.html#user-defined-samplers" id="toc-user-defined-samplers"><span class="toc-section-number">1.6.2</span> User-defined samplers</a></li>
</ul></li>
<li class="has-sub"><a href="1.7-tips-and-tricks.html#tips-and-tricks" id="toc-tips-and-tricks"><span class="toc-section-number">1.7</span> Tips and tricks</a>
<ul>
<li><a href="1.7-tips-and-tricks.html#precision-vs-standard-deviation" id="toc-precision-vs-standard-deviation"><span class="toc-section-number">1.7.1</span> Precision vs standard deviation</a></li>
<li><a href="1.7-tips-and-tricks.html#indexing" id="toc-indexing"><span class="toc-section-number">1.7.2</span> Indexing</a></li>
<li><a href="1.7-tips-and-tricks.html#faster-compilation" id="toc-faster-compilation"><span class="toc-section-number">1.7.3</span> Faster compilation</a></li>
<li><a href="1.7-tips-and-tricks.html#updating-mcmc-chains" id="toc-updating-mcmc-chains"><span class="toc-section-number">1.7.4</span> Updating MCMC chains</a></li>
<li><a href="1.7-tips-and-tricks.html#reproducibility" id="toc-reproducibility"><span class="toc-section-number">1.7.5</span> Reproducibility</a></li>
<li><a href="1.7-tips-and-tricks.html#parallelization" id="toc-parallelization"><span class="toc-section-number">1.7.6</span> Parallelization</a></li>
<li><a href="1.7-tips-and-tricks.html#incomplete-initialization" id="toc-incomplete-initialization"><span class="toc-section-number">1.7.7</span> Incomplete initialization</a></li>
<li><a href="1.7-tips-and-tricks.html#vectorization" id="toc-vectorization"><span class="toc-section-number">1.7.8</span> Vectorization</a></li>
</ul></li>
<li><a href="1.8-summary.html#summary" id="toc-summary"><span class="toc-section-number">1.8</span> Summary</a></li>
<li><a href="1.9-suggested-reading.html#suggested-reading" id="toc-suggested-reading"><span class="toc-section-number">1.9</span> Suggested reading</a></li>
</ul></li>
<li><a href="faq.html#faq" id="toc-faq">FAQ</a></li>
<li><a href="references.html#references" id="toc-references">References</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="start-nimble" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Getting started</h2>

<div class="rmdnote">
To run NIMBLE, you will need to:<br />
1. Build a model consisting of a likelihood and priors.<br />
2. Read in some data.<br />
3. Specify parameters you want to make inference about.<br />
4. Pick initial values for parameters to be estimated (for each chain).<br />
5. Provide MCMC details namely the number of chains, the length of the burn-in period and the number of iterations following burn-in.
</div>
<p>First things first, letâ€™s not forget to load the <code>nimble</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="1.3-start-nimble.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span></code></pre></div>
<p>Note that before you can install <code>nimble</code> like any other R package, Windows users will need to install <code>Rtools</code>, and Mac users will need to install <code>Xcode</code>. More at <a href="https://r-nimble.org/download" class="uri">https://r-nimble.org/download</a>.</p>
<p>Now letâ€™s go back to our example on animal survival from the previous chapter. First step is to build our model by specifying the binomial likelihood and a uniform prior on survival probability <code>theta</code>. We use the <code>nimbleCode()</code> function and wrap code within curly brackets:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="1.3-start-nimble.html#cb3-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb3-2"><a href="1.3-start-nimble.html#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb3-3"><a href="1.3-start-nimble.html#cb3-3" aria-hidden="true" tabindex="-1"></a>  survived <span class="sc">~</span> <span class="fu">dbinom</span>(theta, released)</span>
<span id="cb3-4"><a href="1.3-start-nimble.html#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior</span></span>
<span id="cb3-5"><a href="1.3-start-nimble.html#cb3-5" aria-hidden="true" tabindex="-1"></a>  theta <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-6"><a href="1.3-start-nimble.html#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># derived quantity</span></span>
<span id="cb3-7"><a href="1.3-start-nimble.html#cb3-7" aria-hidden="true" tabindex="-1"></a>  lifespan <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(theta)</span>
<span id="cb3-8"><a href="1.3-start-nimble.html#cb3-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>You can check that the <code>model</code> R object contains your code:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="1.3-start-nimble.html#cb4-1" aria-hidden="true" tabindex="-1"></a>model</span>
<span id="cb4-2"><a href="1.3-start-nimble.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="do">## {</span></span>
<span id="cb4-3"><a href="1.3-start-nimble.html#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">##     survived ~ dbinom(theta, released)</span></span>
<span id="cb4-4"><a href="1.3-start-nimble.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="do">##     theta ~ dunif(0, 1)</span></span>
<span id="cb4-5"><a href="1.3-start-nimble.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">##     lifespan &lt;- -1/log(theta)</span></span>
<span id="cb4-6"><a href="1.3-start-nimble.html#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="do">## }</span></span></code></pre></div>
<p>In the code above, <code>survived</code> and <code>released</code> are known, only <code>theta</code> needs to be estimated. The line <code>survived ~ dbinom(theta, released)</code> states that the number of successes or animals that have survived over winter <code>survived</code> is distributed as (thatâ€™s the <code>~</code>) as a binomial with <code>released</code> trials and probability of success or survival <code>theta</code>. Then the line <code>theta ~ dunif(0, 1)</code> assigns a uniform between 0 and 1 as a prior distribution to the survival probability. This is all you need, a likelihood and priors for model parameters, NIMBLE knows the Bayes theorem. The last line <code>lifespan &lt;- - 1/log(theta)</code> calculates a quantity derived from <code>theta</code>, which is the expected lifespan assuming constant survival<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>A few comments:</p>
<ul>
<li><p>The most common distributions are available in NIMBLE. Among others, we will use later in the book <code>dbeta</code>, <code>dmultinom</code> and <code>dnorm</code>. If you cannot find what you need in NIMBLE, you can write your own distribution as illustrated in Section <a href="1.4-functions-in-nimble.html#functions-in-nimble">1.4</a>.</p></li>
<li><p>It does not matter in what order you write each line of code, NIMBLE uses what is called a declarative language for building models. In brief, you write code that tells NIMBLE what you want to achieve, and not how to get there. In contrast, an imperative language requires that you write what you want your program to do step by step.</p></li>
<li><p>You can think of models in NIMBLE as graphs as in Figure <a href="1.3-start-nimble.html#fig:dag-survival">1.2</a>. A graph is made of relations (or edges) that can be of two types. A stochastic relation is signaled by a <code>~</code> sign and defines a random variable in the model, such as <code>survived</code> or <code>theta</code>. A deterministic relation is signaled by a <code>&lt;-</code> sign, like <code>lifespan</code>. Relations define nodes on the left - the children - in terms of other nodes on the right - the parents, and relations are directed edges from parents to children. Such graphs are called directed acyclic graph or DAG.</p>
<div class="figure"><span style="display:block;" id="fig:dag-survival"></span>
<img src="banana-book_files/figure-html/dag-survival-1.png" alt="Graph of the animal survival model. Survived is a stochastic node defined by its parents `released` and `theta`, while `lifespan` is a deterministic node the value of which is defined exactly by the value of its parent `theta`." width="672" />
<p class="caption">
Figure 1.2: Graph of the animal survival model. Survived is a stochastic node defined by its parents <code>released</code> and <code>theta</code>, while <code>lifespan</code> is a deterministic node the value of which is defined exactly by the value of its parent <code>theta</code>.
</p>
</div></li>
</ul>
<p>Second step in our workflow is to read in some data. We use a list in which each component corresponds to a known quantity in the model:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="1.3-start-nimble.html#cb5-1" aria-hidden="true" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">released =</span> <span class="dv">57</span>, <span class="at">survived =</span> <span class="dv">19</span>)</span></code></pre></div>
<p>You can proceed with data passed this way, but you should know a little more about how NIMBLE sees data. NIMBLE distinguishes data and constants. Constants are values that do not change, e.g.Â vectors of known index values or the indices used to define for loops. Data are values that you might want to change, basically anything that only appears on the left of a <code>~</code>. Declaring relevant values as constants is better for computational efficiency, but it is easy to forget, and fortunately NIMBLE will by itself distinguish data and constants. I will not use the distinction between data and constants in this chapter, but in the next chapters it will become important.</p>
<!-- In passing say that full indexing is needed, you cannot let NIMBLE guess dimensions. -->
<!-- Ici on reprend le modÃ¨le simple du dessus, et on l'exprime un peu diffÃ©remment pour illustrer qqs autres features de NIMBLE: i) loops, ii) distinction between constants and data. The binomial is a sum of independent Bernoulli outcomes with same probability. the Like flipping a coin for each individual and get a survivor with prob theta. Here survived is. Going back to our animal survival example, it means that the likelihood can be written as a Bernoulli random variable taking value 1 if animal survived, and 0 otherwise. **Voir dans annexe Hobbs**. E.g. `survived[1] ~ dbern(theta)` up to `survived[59] ~ dbern(theta)`. Likelihood contribution of individuals. Loops is the product. Iid. Instead of duplicating the same line of code `survived[i] ~ dbern(theta)` we use a loop. -->
<!-- ```{r} -->
<!-- model <- nimbleCode({ -->
<!--   # likelihood -->
<!--   for (i in 1:released){ -->
<!--     survived[i] ~ dbern(theta) -->
<!--   } -->
<!--   # prior -->
<!--   theta ~ dunif(0, 1) -->
<!-- }) -->
<!-- ``` -->
<!-- **If you try nimbleMCMC it won't work. This is because we ned to distinguish data from constants. Uncomment code.** -->
<!-- Distinguih constants and data. To Nimble, not all "data" is data... -->
<!-- ```{r} -->
<!-- my.constants <- list(released = 57) -->
<!-- my.data <- list(survived = 19) -->
<!-- ``` -->
<!-- ```{r, eval = FALSE} -->
<!-- mcmc.output <- nimbleMCMC(code = model, -->
<!--                           data = my.data, -->
<!--                           constants = my.constants, -->
<!--                           inits = initial.values, -->
<!--                           monitors = parameters.to.save, -->
<!--                           niter = n.iter, -->
<!--                           nburnin = n.burnin, -->
<!--                           nchains = n.chains) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- my.data <- list(survived = c(rep(1,19), rep(0,57-19))) -->
<!-- my.constants <- list(released = 57) -->
<!-- ``` -->
<!-- The rest is the same. Steps 3, 4 and 5. -->
<!-- ```{r} -->
<!-- parameters.to.save <- c("theta", "life_expectancy") -->
<!-- initial.values <- function() list(theta = runif(1,0,1)) -->
<!-- n.iter <- 5000 -->
<!-- n.burnin <- 1000 -->
<!-- n.chains <- 3 -->
<!-- ``` -->
<!-- Run model, add argument `constants = my.constants`. -->
<!-- ```{r} -->
<!-- mcmc.output <- nimbleMCMC(code = model, -->
<!--                           data = my.data, -->
<!--                           constants = my.constants, -->
<!--                           inits = initial.values, -->
<!--                           monitors = parameters.to.save, -->
<!--                           niter = n.iter, -->
<!--                           nburnin = n.burnin, -->
<!--                           nchains = n.chains) -->
<!-- ``` -->
<p>Third step is to tell NIMBLE which nodes in your model you would like to keep track of, in other words the quantities youâ€™d like to do inference about. In our model we want survival <code>theta</code> and <code>lifespan</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="1.3-start-nimble.html#cb6-1" aria-hidden="true" tabindex="-1"></a>parameters.to.save <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;lifespan&quot;</span>)</span></code></pre></div>
<p>In general you have many quantities in your model, including some of little interest that are not worth monitoring, and having full control on verbosity will prove handy.</p>
<p>Fourth step is to specify initial values for all model parameters. To make sure that the MCMC algorithm explores the posterior distribution, we start different chains with different parameter values. You can specify initial values for each chain in a list and put them in yet another list:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="1.3-start-nimble.html#cb7-1" aria-hidden="true" tabindex="-1"></a>init1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fl">0.1</span>)</span>
<span id="cb7-2"><a href="1.3-start-nimble.html#cb7-2" aria-hidden="true" tabindex="-1"></a>init2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fl">0.5</span>)</span>
<span id="cb7-3"><a href="1.3-start-nimble.html#cb7-3" aria-hidden="true" tabindex="-1"></a>init3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fl">0.9</span>)</span>
<span id="cb7-4"><a href="1.3-start-nimble.html#cb7-4" aria-hidden="true" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="fu">list</span>(init1, init2, init3)</span>
<span id="cb7-5"><a href="1.3-start-nimble.html#cb7-5" aria-hidden="true" tabindex="-1"></a>initial.values</span>
<span id="cb7-6"><a href="1.3-start-nimble.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb7-7"><a href="1.3-start-nimble.html#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]$theta</span></span>
<span id="cb7-8"><a href="1.3-start-nimble.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.1</span></span>
<span id="cb7-9"><a href="1.3-start-nimble.html#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb7-10"><a href="1.3-start-nimble.html#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb7-11"><a href="1.3-start-nimble.html#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb7-12"><a href="1.3-start-nimble.html#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]$theta</span></span>
<span id="cb7-13"><a href="1.3-start-nimble.html#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.5</span></span>
<span id="cb7-14"><a href="1.3-start-nimble.html#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb7-15"><a href="1.3-start-nimble.html#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb7-16"><a href="1.3-start-nimble.html#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb7-17"><a href="1.3-start-nimble.html#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]$theta</span></span>
<span id="cb7-18"><a href="1.3-start-nimble.html#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.9</span></span></code></pre></div>
<p>Alternatively, you can write a simple R function that generates random initial values:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="1.3-start-nimble.html#cb8-1" aria-hidden="true" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">theta =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb8-2"><a href="1.3-start-nimble.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">initial.values</span>()</span>
<span id="cb8-3"><a href="1.3-start-nimble.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">## $theta</span></span>
<span id="cb8-4"><a href="1.3-start-nimble.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8595</span></span></code></pre></div>
<p>Firth and last step, you need to tell NIMBLE the number of chains to run, say <code>n.chain</code>, how long the burn-in period should be, say <code>n.burnin</code>, and the number of iterations following the burn-in period to be used for posterior inference. In NIMBLE, you specify the total number of iterations, say <code>n.iter</code>, so that the number of posterior samples per chain is <code>n.iter - n.burnin</code>. NIMBLE also allows discarding samples after burn-in, a procedure known as thinning, which I will not use in this book<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="1.3-start-nimble.html#cb9-1" aria-hidden="true" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb9-2"><a href="1.3-start-nimble.html#cb9-2" aria-hidden="true" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb9-3"><a href="1.3-start-nimble.html#cb9-3" aria-hidden="true" tabindex="-1"></a>n.chains <span class="ot">&lt;-</span> <span class="dv">3</span></span></code></pre></div>
<p>We now have all the ingredients to run model, that is to sample in the posterior distribution of model parameters using MCMC simulations. This is accomplished using function <code>nimbleMCMC()</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="1.3-start-nimble.html#cb10-1" aria-hidden="true" tabindex="-1"></a>mcmc.output <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> model,</span>
<span id="cb10-2"><a href="1.3-start-nimble.html#cb10-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> my.data,</span>
<span id="cb10-3"><a href="1.3-start-nimble.html#cb10-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">inits =</span> initial.values,</span>
<span id="cb10-4"><a href="1.3-start-nimble.html#cb10-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">monitors =</span> parameters.to.save,</span>
<span id="cb10-5"><a href="1.3-start-nimble.html#cb10-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">niter =</span> n.iter,</span>
<span id="cb10-6"><a href="1.3-start-nimble.html#cb10-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nburnin =</span> n.burnin,</span>
<span id="cb10-7"><a href="1.3-start-nimble.html#cb10-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nchains =</span> n.chains)</span>
<span id="cb10-8"><a href="1.3-start-nimble.html#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb10-9"><a href="1.3-start-nimble.html#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb10-10"><a href="1.3-start-nimble.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb10-11"><a href="1.3-start-nimble.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb10-12"><a href="1.3-start-nimble.html#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb10-13"><a href="1.3-start-nimble.html#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span></code></pre></div>
<p>NIMBLE goes through several steps that we will explain in Section <a href="1.5-under-the-hood.html#under-the-hood">1.5</a>. Function <code>nimbleMCMC()</code> takes other arguments that you might find useful. For example, you can suppress the progress bar if you find it too depressing when running long simulations with <code>progressBar = FALSE</code>. You can also get a summary of the outputs by specifying <code>summary = TRUE</code>. Check <code>?nimbleMCMC</code> for more details.</p>
<p>Now letâ€™s inspect what we have in <code>mcmc.output</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="1.3-start-nimble.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mcmc.output)</span>
<span id="cb11-2"><a href="1.3-start-nimble.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## List of 3</span></span>
<span id="cb11-3"><a href="1.3-start-nimble.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ chain1: num [1:4000, 1:2] 1.057 1.057 1.057 1.057 0.908 ...</span></span>
<span id="cb11-4"><a href="1.3-start-nimble.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, &quot;dimnames&quot;)=List of 2</span></span>
<span id="cb11-5"><a href="1.3-start-nimble.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : NULL</span></span>
<span id="cb11-6"><a href="1.3-start-nimble.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : chr [1:2] &quot;lifespan&quot; &quot;theta&quot;</span></span>
<span id="cb11-7"><a href="1.3-start-nimble.html#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ chain2: num [1:4000, 1:2] 0.879 0.879 0.879 0.879 0.879 ...</span></span>
<span id="cb11-8"><a href="1.3-start-nimble.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, &quot;dimnames&quot;)=List of 2</span></span>
<span id="cb11-9"><a href="1.3-start-nimble.html#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : NULL</span></span>
<span id="cb11-10"><a href="1.3-start-nimble.html#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : chr [1:2] &quot;lifespan&quot; &quot;theta&quot;</span></span>
<span id="cb11-11"><a href="1.3-start-nimble.html#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ chain3: num [1:4000, 1:2] 1.023 0.884 0.884 0.751 0.751 ...</span></span>
<span id="cb11-12"><a href="1.3-start-nimble.html#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, &quot;dimnames&quot;)=List of 2</span></span>
<span id="cb11-13"><a href="1.3-start-nimble.html#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : NULL</span></span>
<span id="cb11-14"><a href="1.3-start-nimble.html#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : chr [1:2] &quot;lifespan&quot; &quot;theta&quot;</span></span></code></pre></div>
<p>The R object <code>mcmc.output</code> is a list with three components, one for each MCMC chain. Letâ€™s have a look to <code>chain1</code> for example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="1.3-start-nimble.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(mcmc.output<span class="sc">$</span>chain1)</span>
<span id="cb12-2"><a href="1.3-start-nimble.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4000    2</span></span>
<span id="cb12-3"><a href="1.3-start-nimble.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mcmc.output<span class="sc">$</span>chain1)</span>
<span id="cb12-4"><a href="1.3-start-nimble.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="do">##      lifespan  theta</span></span>
<span id="cb12-5"><a href="1.3-start-nimble.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,]   1.0566 0.3881</span></span>
<span id="cb12-6"><a href="1.3-start-nimble.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,]   1.0566 0.3881</span></span>
<span id="cb12-7"><a href="1.3-start-nimble.html#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [3,]   1.0566 0.3881</span></span>
<span id="cb12-8"><a href="1.3-start-nimble.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [4,]   1.0566 0.3881</span></span>
<span id="cb12-9"><a href="1.3-start-nimble.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [5,]   0.9085 0.3326</span></span>
<span id="cb12-10"><a href="1.3-start-nimble.html#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [6,]   0.9085 0.3326</span></span></code></pre></div>
<p>Each component of the list is a matrix. In rows, you have 4000 samples from the posterior distribution of <code>theta</code>, which corresponds to <code>n.iter - n.burnin</code> iterations. In columns, you have the quantities we monitor, <code>theta</code> and <code>lifespan</code>. From there, you can compute the posterior mean of <code>theta</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="1.3-start-nimble.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mcmc.output<span class="sc">$</span>chain1[,<span class="st">&#39;theta&#39;</span>])</span>
<span id="cb13-2"><a href="1.3-start-nimble.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.3349</span></span></code></pre></div>
<p>You can also obtain the 95% credible interval for <code>theta</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="1.3-start-nimble.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(mcmc.output<span class="sc">$</span>chain1[,<span class="st">&#39;theta&#39;</span>], <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">97.5</span>)<span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb14-2"><a href="1.3-start-nimble.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   2.5%  97.5% </span></span>
<span id="cb14-3"><a href="1.3-start-nimble.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.2262 0.4533</span></span></code></pre></div>
<p>Letâ€™s visualise the posterior distribution of <code>theta</code> with a histogram:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="1.3-start-nimble.html#cb15-1" aria-hidden="true" tabindex="-1"></a>mcmc.output <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="1.3-start-nimble.html#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="1.3-start-nimble.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-4"><a href="1.3-start-nimble.html#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> chain1[,<span class="st">&quot;theta&quot;</span>]), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="1.3-start-nimble.html#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;survival probability&quot;</span>)</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>There are less painful ways of doing posterior inference. In this book, I will use the R package <code>MCMCvis</code><a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> to summarise and visualize MCMC outputs, but there are other perfectly valid options out there like <code>ggmcmc</code><a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> and <code>basicMCMCplots</code><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. <strong>Shall I demonstrate these other options?</strong></p>
<!-- Finally we want to look at our samples. NIMBLE returns samples as a simple matrix with named columns. There are numerous packages for processing MCMC output. If you want to use the coda package, you can convert a matrix to a coda mcmc object like this: -->
<!-- library(coda) -->
<!-- coda.samples <- as.mcmc(samples) -->
<!-- Alternatively, if you call nimbleMCMC with the argument samplesAsCodaMCMC = TRUE, the samples will be returned as a coda object. -->
<p>Letâ€™s load the package <code>MCMCvis</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="1.3-start-nimble.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCvis)</span></code></pre></div>
<p>To get the most common numerical summaries, the function <code>MCMCsummary()</code> does the job:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="1.3-start-nimble.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCsummary</span>(<span class="at">object =</span> mcmc.output, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb17-2"><a href="1.3-start-nimble.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">##          mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span id="cb17-3"><a href="1.3-start-nimble.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## lifespan 0.93 0.16 0.67 0.92  1.30    1  2542</span></span>
<span id="cb17-4"><a href="1.3-start-nimble.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## theta    0.34 0.06 0.23 0.34  0.46    1  2580</span></span></code></pre></div>
<p>You can use a caterpillar plot to visualise the posterior distributions of <code>theta</code> with <code>MCMCplot()</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="1.3-start-nimble.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCplot</span>(<span class="at">object =</span> mcmc.output, </span>
<span id="cb18-2"><a href="1.3-start-nimble.html#cb18-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">params =</span> <span class="st">&#39;theta&#39;</span>)</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<p>The point represents the posterior median, the thick line is the 50% credible interval and the thin line the 95% credible interval.</p>
<p>The trace and posterior density of theta can be obtained with <code>MCMCtrace()</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="1.3-start-nimble.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCtrace</span>(<span class="at">object =</span> mcmc.output,</span>
<span id="cb19-2"><a href="1.3-start-nimble.html#cb19-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">pdf =</span> <span class="cn">FALSE</span>, <span class="co"># no export to PDF</span></span>
<span id="cb19-3"><a href="1.3-start-nimble.html#cb19-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">ind =</span> <span class="cn">TRUE</span>, <span class="co"># separate density lines per chain</span></span>
<span id="cb19-4"><a href="1.3-start-nimble.html#cb19-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">params =</span> <span class="st">&quot;theta&quot;</span>)</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<p>You can also add the diagnostics of convergence we discussed in the previous chapter:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="1.3-start-nimble.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCtrace</span>(<span class="at">object =</span> mcmc.output,</span>
<span id="cb20-2"><a href="1.3-start-nimble.html#cb20-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">pdf =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-3"><a href="1.3-start-nimble.html#cb20-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">ind =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-4"><a href="1.3-start-nimble.html#cb20-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">Rhat =</span> <span class="cn">TRUE</span>, <span class="co"># add Rhat</span></span>
<span id="cb20-5"><a href="1.3-start-nimble.html#cb20-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">n.eff =</span> <span class="cn">TRUE</span>, <span class="co"># add eff sample size</span></span>
<span id="cb20-6"><a href="1.3-start-nimble.html#cb20-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">params =</span> <span class="st">&quot;theta&quot;</span>)</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>We calculated lifespan directly in our model with <code>lifespan &lt;- -1/log(theta)</code>. But you can also calculate this quantity from outside NIMBLE. This is a nice by-product of using MCMC simulations: you can obtain the posterior distribution of any quantity that is function of your model parameters by applying this function to samples from the posterior distribution of these parameters. In our example, all you need is samples from the posterior distribution of <code>theta</code>, which we pool between the three chains with:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="1.3-start-nimble.html#cb21-1" aria-hidden="true" tabindex="-1"></a>theta_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(mcmc.output<span class="sc">$</span>chain1[,<span class="st">&#39;theta&#39;</span>], </span>
<span id="cb21-2"><a href="1.3-start-nimble.html#cb21-2" aria-hidden="true" tabindex="-1"></a>                   mcmc.output<span class="sc">$</span>chain2[,<span class="st">&#39;theta&#39;</span>],</span>
<span id="cb21-3"><a href="1.3-start-nimble.html#cb21-3" aria-hidden="true" tabindex="-1"></a>                   mcmc.output<span class="sc">$</span>chain3[,<span class="st">&#39;theta&#39;</span>])</span></code></pre></div>
<p>To get samples from the posterior distribution of lifespan, we apply the function to calculate lifespan to the samples from the posterior distribution of survival:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="1.3-start-nimble.html#cb22-1" aria-hidden="true" tabindex="-1"></a>lifespan <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(theta_samples)</span></code></pre></div>
<p>As usual then, you can calculate the posterior mean and 95% credible interval:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="1.3-start-nimble.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(lifespan)</span>
<span id="cb23-2"><a href="1.3-start-nimble.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.9338</span></span>
<span id="cb23-3"><a href="1.3-start-nimble.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(lifespan, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">97.5</span>)<span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb23-4"><a href="1.3-start-nimble.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  2.5% 97.5% </span></span>
<span id="cb23-5"><a href="1.3-start-nimble.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.674 1.297</span></span></code></pre></div>
<p>You can also visualise the posterior distribution of lifespan:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="1.3-start-nimble.html#cb24-1" aria-hidden="true" tabindex="-1"></a>lifespan <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="1.3-start-nimble.html#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="1.3-start-nimble.html#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb24-4"><a href="1.3-start-nimble.html#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> value), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="1.3-start-nimble.html#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;lifespan&quot;</span>)</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>Now youâ€™re good to go. For convenience I have summarized the steps above in the box below. The NIMBLE workflow provided with <code>nimbleMCMC()</code> allows you to build models and make inference. This is what you can achieve with other software like WinBUGS or JAGS.</p>
<div class="rmdnote">
<p><strong>NIMBLE workflow:</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="1.3-start-nimble.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model building</span></span>
<span id="cb25-2"><a href="1.3-start-nimble.html#cb25-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb25-3"><a href="1.3-start-nimble.html#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb25-4"><a href="1.3-start-nimble.html#cb25-4" aria-hidden="true" tabindex="-1"></a>  survived <span class="sc">~</span> <span class="fu">dbinom</span>(theta, released)</span>
<span id="cb25-5"><a href="1.3-start-nimble.html#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior</span></span>
<span id="cb25-6"><a href="1.3-start-nimble.html#cb25-6" aria-hidden="true" tabindex="-1"></a>  theta <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-7"><a href="1.3-start-nimble.html#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># derived quantity</span></span>
<span id="cb25-8"><a href="1.3-start-nimble.html#cb25-8" aria-hidden="true" tabindex="-1"></a>  lifespan <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(theta)</span>
<span id="cb25-9"><a href="1.3-start-nimble.html#cb25-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-10"><a href="1.3-start-nimble.html#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># read in data</span></span>
<span id="cb25-11"><a href="1.3-start-nimble.html#cb25-11" aria-hidden="true" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">released =</span> <span class="dv">57</span>, <span class="at">survived =</span> <span class="dv">19</span>)</span>
<span id="cb25-12"><a href="1.3-start-nimble.html#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># specify parameters to monitor</span></span>
<span id="cb25-13"><a href="1.3-start-nimble.html#cb25-13" aria-hidden="true" tabindex="-1"></a>parameters.to.save <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;lifespan&quot;</span>)</span>
<span id="cb25-14"><a href="1.3-start-nimble.html#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># pick initial values</span></span>
<span id="cb25-15"><a href="1.3-start-nimble.html#cb25-15" aria-hidden="true" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">theta =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb25-16"><a href="1.3-start-nimble.html#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># specify MCMC details</span></span>
<span id="cb25-17"><a href="1.3-start-nimble.html#cb25-17" aria-hidden="true" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb25-18"><a href="1.3-start-nimble.html#cb25-18" aria-hidden="true" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb25-19"><a href="1.3-start-nimble.html#cb25-19" aria-hidden="true" tabindex="-1"></a>n.chains <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb25-20"><a href="1.3-start-nimble.html#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># run NIMBLE</span></span>
<span id="cb25-21"><a href="1.3-start-nimble.html#cb25-21" aria-hidden="true" tabindex="-1"></a>mcmc.output <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> model,</span>
<span id="cb25-22"><a href="1.3-start-nimble.html#cb25-22" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> my.data,</span>
<span id="cb25-23"><a href="1.3-start-nimble.html#cb25-23" aria-hidden="true" tabindex="-1"></a>                          <span class="at">inits =</span> initial.values,</span>
<span id="cb25-24"><a href="1.3-start-nimble.html#cb25-24" aria-hidden="true" tabindex="-1"></a>                          <span class="at">monitors =</span> parameters.to.save,</span>
<span id="cb25-25"><a href="1.3-start-nimble.html#cb25-25" aria-hidden="true" tabindex="-1"></a>                          <span class="at">niter =</span> n.iter,</span>
<span id="cb25-26"><a href="1.3-start-nimble.html#cb25-26" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nburnin =</span> n.burnin,</span>
<span id="cb25-27"><a href="1.3-start-nimble.html#cb25-27" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nchains =</span> n.chains)</span>
<span id="cb25-28"><a href="1.3-start-nimble.html#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate numerical summaries</span></span>
<span id="cb25-29"><a href="1.3-start-nimble.html#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCsummary</span>(<span class="at">object =</span> mcmc.output, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb25-30"><a href="1.3-start-nimble.html#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize parameter posterior distribution</span></span>
<span id="cb25-31"><a href="1.3-start-nimble.html#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCplot</span>(<span class="at">object =</span> mcmc.output, </span>
<span id="cb25-32"><a href="1.3-start-nimble.html#cb25-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">params =</span> <span class="st">&#39;theta&#39;</span>)</span>
<span id="cb25-33"><a href="1.3-start-nimble.html#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co"># check convergence</span></span>
<span id="cb25-34"><a href="1.3-start-nimble.html#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCtrace</span>(<span class="at">object =</span> mcmc.output,</span>
<span id="cb25-35"><a href="1.3-start-nimble.html#cb25-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">pdf =</span> <span class="cn">FALSE</span>, <span class="co"># no export to PDF</span></span>
<span id="cb25-36"><a href="1.3-start-nimble.html#cb25-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">ind =</span> <span class="cn">TRUE</span>, <span class="co"># separate density lines per chain</span></span>
<span id="cb25-37"><a href="1.3-start-nimble.html#cb25-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">params =</span> <span class="st">&quot;theta&quot;</span>)</span></code></pre></div>
</div>
<p>But NIMBLE is more than just another MCMC engine. It provides a programming environment so that you have full control when building models and estimating parameters. NIMBLE allows you to write your own functions and distributions to build models, and to choose alternative MCMC samplers or code new ones. This flexibility often comes with faster convergence.</p>
<p>I have to be honest, learning these improvements over other software takes some reading and experimentation, and it might well be that you do not need to use any of these features. And itâ€™s fine. In the next sections, I cover some of this advanced material. You may skip these sections and go back to this material later if you need it.</p>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p>Cook LM, Brower LP, Croze HJ (1967) The accuracy of a population estimation from multiple recapture data. J Anim Ecol 36:57â€“60<a href="1.3-start-nimble.html#fnref2" class="footnote-back">â†©ï¸Ž</a></p></li>
<li id="fn3"><p>Link, W.A. and Eaton, M.J. (2012), On thinning of chains in MCMC. Methods in Ecology and Evolution, 3: 112-115.<a href="1.3-start-nimble.html#fnref3" class="footnote-back">â†©ï¸Ž</a></p></li>
<li id="fn4"><p><a href="https://github.com/caseyyoungflesh/MCMCvis" class="uri">https://github.com/caseyyoungflesh/MCMCvis</a><a href="1.3-start-nimble.html#fnref4" class="footnote-back">â†©ï¸Ž</a></p></li>
<li id="fn5"><p>FernÃ¡ndez-i-MarÃ­n, X. (2016). ggmcmc: Analysis of MCMC Samples and Bayesian Inference. Journal of Statistical Software, 70(9), 1â€“20<a href="1.3-start-nimble.html#fnref5" class="footnote-back">â†©ï¸Ž</a></p></li>
<li id="fn6"><p><a href="https://cran.r-project.org/web/packages/basicMCMCplots/index.html" class="uri">https://cran.r-project.org/web/packages/basicMCMCplots/index.html</a><a href="1.3-start-nimble.html#fnref6" class="footnote-back">â†©ï¸Ž</a></p></li>
</ol>
</div>
<p style="text-align: center;">
<a href="1.2-what-is-nimble.html"><button class="btn btn-default">Previous</button></a>
<a href="1.4-functions-in-nimble.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>

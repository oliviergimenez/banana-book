<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="1.8 Marginalization | banana-book.knit" />
<meta property="og:type" content="book" />






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="1.8 Marginalization | banana-book.knit">

<title>1.8 Marginalization | banana-book.knit</title>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
/* show arrow before summary tag as in bootstrap
TODO: remove if bootstrap in updated in html_document (rmarkdown#1485) */
details > summary {
  display: list-item;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="1-hmmcapturerecapture.html#hmmcapturerecapture" id="toc-hmmcapturerecapture"><span class="toc-section-number">1</span> Hidden Markov models</a>
<ul>
<li><a href="1.1-introduction.html#introduction" id="toc-introduction"><span class="toc-section-number">1.1</span> Introduction</a></li>
<li><a href="1.2-longitudinal-data.html#longitudinal-data" id="toc-longitudinal-data"><span class="toc-section-number">1.2</span> Longitudinal data</a></li>
<li class="has-sub"><a href="1.3-a-markov-model-for-longitudinal-data.html#a-markov-model-for-longitudinal-data" id="toc-a-markov-model-for-longitudinal-data"><span class="toc-section-number">1.3</span> A Markov model for longitudinal data</a>
<ul>
<li><a href="1.3-a-markov-model-for-longitudinal-data.html#assumptions" id="toc-assumptions"><span class="toc-section-number">1.3.1</span> Assumptions</a></li>
<li><a href="1.3-a-markov-model-for-longitudinal-data.html#transition-matrix" id="toc-transition-matrix"><span class="toc-section-number">1.3.2</span> Transition matrix</a></li>
<li><a href="1.3-a-markov-model-for-longitudinal-data.html#initial-states" id="toc-initial-states"><span class="toc-section-number">1.3.3</span> Initial states</a></li>
<li><a href="1.3-a-markov-model-for-longitudinal-data.html#likelihood" id="toc-likelihood"><span class="toc-section-number">1.3.4</span> Likelihood</a></li>
<li><a href="1.3-a-markov-model-for-longitudinal-data.html#example" id="toc-example"><span class="toc-section-number">1.3.5</span> Example</a></li>
</ul></li>
<li><a href="1.4-bayesian-formulation.html#bayesian-formulation" id="toc-bayesian-formulation"><span class="toc-section-number">1.4</span> Bayesian formulation</a></li>
<li><a href="1.5-nimble-implementation.html#nimble-implementation" id="toc-nimble-implementation"><span class="toc-section-number">1.5</span> NIMBLE implementation</a></li>
<li class="has-sub"><a href="1.6-hidden-markov-models.html#hidden-markov-models" id="toc-hidden-markov-models"><span class="toc-section-number">1.6</span> Hidden Markov models</a>
<ul>
<li><a href="1.6-hidden-markov-models.html#capturerecapturedata" id="toc-capturerecapturedata"><span class="toc-section-number">1.6.1</span> Capture-recapture data</a></li>
<li><a href="1.6-hidden-markov-models.html#observation-matrix" id="toc-observation-matrix"><span class="toc-section-number">1.6.2</span> Observation matrix</a></li>
<li><a href="1.6-hidden-markov-models.html#hidden-markov-model" id="toc-hidden-markov-model"><span class="toc-section-number">1.6.3</span> Hidden Markov model</a></li>
<li><a href="1.6-hidden-markov-models.html#likelihoodhmm" id="toc-likelihoodhmm"><span class="toc-section-number">1.6.4</span> Likelihood</a></li>
</ul></li>
<li><a href="1.7-fittinghmmnimble.html#fittinghmmnimble" id="toc-fittinghmmnimble"><span class="toc-section-number">1.7</span> Fitting HMM with NIMBLE</a></li>
<li class="has-sub"><a href="1.8-marginalization.html#marginalization" id="toc-marginalization"><span class="toc-section-number">1.8</span> Marginalization</a>
<ul>
<li><a href="1.8-marginalization.html#brute-force-approach" id="toc-brute-force-approach"><span class="toc-section-number">1.8.1</span> Brute-force approach</a></li>
<li><a href="1.8-marginalization.html#forward-algorithm" id="toc-forward-algorithm"><span class="toc-section-number">1.8.2</span> Forward algorithm</a></li>
<li><a href="1.8-marginalization.html#nimblemarginalization" id="toc-nimblemarginalization"><span class="toc-section-number">1.8.3</span> NIMBLE implementation</a></li>
</ul></li>
<li><a href="1.9-pooled-likelihood.html#pooled-likelihood" id="toc-pooled-likelihood"><span class="toc-section-number">1.9</span> Pooled encounter histories</a></li>
<li class="has-sub"><a href="1.10-decoding.html#decoding" id="toc-decoding"><span class="toc-section-number">1.10</span> Decoding after marginalization</a>
<ul>
<li><a href="1.10-decoding.html#viterbi-theory" id="toc-viterbi-theory"><span class="toc-section-number">1.10.1</span> Theory</a></li>
<li><a href="1.10-decoding.html#implementation" id="toc-implementation"><span class="toc-section-number">1.10.2</span> Implementation</a></li>
<li><a href="1.10-decoding.html#compute-average" id="toc-compute-average"><span class="toc-section-number">1.10.3</span> Compute first, average after</a></li>
<li><a href="1.10-decoding.html#average-first-compute-after" id="toc-average-first-compute-after"><span class="toc-section-number">1.10.4</span> Average first, compute after</a></li>
</ul></li>
<li><a href="1.11-summary.html#summary" id="toc-summary"><span class="toc-section-number">1.11</span> Summary</a></li>
<li><a href="1.12-suggested-reading.html#suggested-reading" id="toc-suggested-reading"><span class="toc-section-number">1.12</span> Suggested reading</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="marginalization" class="section level2" number="1.8">
<h2><span class="header-section-number">1.8</span> Marginalization</h2>
<p>In some situations, you will not be interested in inferring the hidden states <span class="math inline">\(z_{i,t}\)</span>, so why bother estimating them? The good news is that you can get rid of the states, so that the marginal likelihood is a function of survival and detection probabilities <span class="math inline">\(\phi\)</span> and <span class="math inline">\(p\)</span> only.</p>
<div id="brute-force-approach" class="section level3" number="1.8.1">
<h3><span class="header-section-number">1.8.1</span> Brute-force approach</h3>
<p>Using the formula of total probability, you get the marginal likelihood by summing over all possible states in the complete likelihood:</p>
<p><span class="math display">\[\begin{align*}
\Pr(\mathbf{y}_i) &amp;= \Pr(y_{i,1}, y_{i,2}, \ldots, y_{i,T})\\
                &amp;= \sum_{\mathbf{z}_i} \Pr(\mathbf{y}_i, \mathbf{z}_i)\\
                &amp;= \sum_{z_{i,1}} \cdots \sum_{z_{i,T}} \Pr(y_{i,1}, y_{i,2}, \ldots, y_{i,T}, z_{i,1}, z_{i,2}, \ldots, z_{i,T})\\
\end{align*}\]</span></p>
<p>Going through the same steps as for deriving the complete likelihood, we obtain the marginal likelihood:</p>
<p><span class="math display">\[\begin{align*}
\Pr(\mathbf{y}_i) &amp;= \sum_{z_{i,1}} \cdots \sum_{z_{i,T}} \left(\prod_{t=1}^T{\omega_{z_{i,t}, y_{i,t}}}\right) \left(\Pr(z_{i,1}) \prod_{t=2}^T{\gamma_{z_{i,t-1},z_{i,t}}}\right)\\
\end{align*}\]</span></p>
<p>Let’s go through an example. Let’s imagine we have <span class="math inline">\(T = 3\)</span> winters, and we’d like to write the likelihood for an individual having the encounter history detected, detected then non-detected. Remember that non-detected is coded 1 and detected is coded 2, while alive is coded 1 and dead is coded 2. We need to calculate <span class="math inline">\(\Pr(y_1 = 2, y_2 = 2, y_3 = 1)\)</span> which, according to the formula above, is given by:</p>
<p><span class="math display">\[\begin{align*}
\begin{split}
\Pr(y_1 = 2, y_2 = 2, y_3 = 1) &amp;= \sum_{i=1}^{2} \sum_{j=1}^{2} \sum_{k=1}^{2} \Pr(y_1 = 2 | z_1 = i) \Pr(y_2 = 2 | z_2 = j) \Pr(y_3 = 1 | z_3 = k) \\
&amp; \qquad \Pr(z_1=i) \Pr(z_2 = j | z_1 = i) \Pr(z_3 = k | z_2 = j)\\
\end{split}
\end{align*}\]</span></p>
<p>Expliciting all the sums in <span class="math inline">\(\Pr(y_1 = 2, y_2 = 2, y_3 = 1)\)</span>, we get the long and ugly expression:</p>
<p><span class="math display">\[\begin{align*}
\begin{split}
\Pr(y_1 = 2, y_2 = 2, y_3 = 1) &amp;= \\
&amp; \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 1) \times \\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 1 | z_1 = 1) \Pr(z_3 = 1 | z_2 = 1) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 2) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 1) \times\\
&amp; \qquad \Pr(z_1 = 2) \Pr(z_2 = 1 | z_1 = 2) \Pr(z_3 = 1 | z_2 = 1) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 2) \Pr(y_3 = 1 | z_3 = 1) \times\\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 2 | z_1 = 1) \Pr(z_3 = 1 | z_2 = 2) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 2) \Pr(y_2 = 2 | z_2 = 2) \Pr(y_3 = 1 | z_3 = 1) \times\\
&amp; \qquad \Pr(z_1 = 2) \Pr(z_2 = 2 | z_1 = 2) \Pr(z_3 = 1 | z_2 = 2) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 2) \times\\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 1 | z_1 = 1) \Pr(z_3 = 2 | z_2 = 1) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 2) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 2) \times\\
&amp; \qquad \Pr(z_1 = 2) \Pr(z_2 = 1 | z_1 = 2) \Pr(z_3 = 2 | z_2 = 1) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 2) \Pr(y_3 = 1 | z_3 = 2) \times\\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 2 | z_1 = 1) \Pr(z_3 = 2 | z_2 = 2) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 2) \Pr(y_2 = 2 | z_2 = 2) \Pr(y_3 = 1 | z_3 = 2) \times\\
&amp; \qquad \Pr(z_1 = 2) \Pr(z_2 = 2 | z_1 = 2) \Pr(z_3 = 2 | z_2 = 2)\\
\end{split}
\end{align*}\]</span></p>
<p>You can simplify this expression by noticing that i) all individuals are alive for sure when marked and released in first winter, or <span class="math inline">\(\Pr(z_1=2) = 0\)</span> and ii) dead individuals are non-detected for sure, or <span class="math inline">\(\Pr(y_t = 2|z_t = 2) = 0\)</span>, which lead to:</p>
<p><span class="math display">\[\begin{align*}
\begin{split}
\Pr(y_1 = 2, y_2 = 2, y_3 = 1) &amp;= \\
&amp; \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 1) \times \\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 1 | z_1 = 1) \Pr(z_3 = 1 | z_2 = 1) +\\
&amp;  \Pr(y_1 = 2 | z_1 = 1) \Pr(y_2 = 2 | z_2 = 1) \Pr(y_3 = 1 | z_3 = 2) \times\\
&amp; \qquad \Pr(z_1 = 1) \Pr(z_2 = 1 | z_1 = 1) \Pr(z_3 = 2 | z_2 = 1)\\
\end{split}
\end{align*}\]</span></p>
<p>Because all individuals are captured in first winter, or <span class="math inline">\(\Pr(y_1 = 2 | z_1 = 1) = 1\)</span>, we get:</p>
<p><span class="math display">\[\begin{align*}
\Pr(y_1 = 2, y_2 = 2, y_3 = 1) =  1 (1-p) \times 1 \phi \phi + 1 p 1 \times 1 \phi (1-\phi)
\end{align*}\]</span></p>
<p>You end up with <span class="math inline">\(\Pr(y_1 = 2, y_2 = 2, y_3 = 1) = \phi p (1 - p\phi)\)</span>.</p>
<p>The latent states are no longer involved in the likelihood for this individual. However, even on a rather simple example, the marginal likelihood is quite complex to evaluate because it involves many operations. If <span class="math inline">\(T\)</span> is the length of our encounter histories and <span class="math inline">\(N\)</span> is the number of hidden states (two for alive and dead, but we will deal with more states in some chapters to come), then we need to calculate the sum of <span class="math inline">\(N^T\)</span> terms (the sums in the formula above), each of which has two products of <span class="math inline">\(T\)</span> factors (the products in the formula above), hence <span class="math inline">\(2TN^T\)</span> calculations in total. You can check that in the simple example above, we have <span class="math inline">\(T^N = 2^3 = 8\)</span> terms that are summed, each of which is a product of <span class="math inline">\(2T = 2 \times 3 = 6\)</span> terms. This means that the number of operations increases exponentially as the number of states increases. In most cases, this complexity precludes using this method to get rid of the states. Fortunately, we have another algorithm in the HMM toolbox that is useful to calculate the marginal likelihood efficiently.</p>
</div>
<div id="forward-algorithm" class="section level3" number="1.8.2">
<h3><span class="header-section-number">1.8.2</span> Forward algorithm</h3>
<p>In the brute-force approach, some products are computed several times to calculate the marginal likelihood. What if we could store these products and use them later while computing the probability of the observation sequence? This is precisely what the forward algorithm does.</p>
<p>We introduce <span class="math inline">\(\alpha_t(j)\)</span> the probability for the latent state <span class="math inline">\(z\)</span> of being in state <span class="math inline">\(j\)</span> at <span class="math inline">\(t\)</span> after seeing the first <span class="math inline">\(j\)</span> observations <span class="math inline">\(y_1, \ldots, y_t\)</span>, that is <span class="math inline">\(\alpha_t(j) = \Pr(y_1, \ldots, y_t, z_t = j)\)</span>.</p>
<p>Using the law of total probability, we can write the marginal likelihood as a function of <span class="math inline">\(\alpha_T(j)\)</span>, namely we have <span class="math inline">\(\Pr(\mathbf{y}) = \displaystyle{\sum_{j=1}^N\Pr(y_1, \ldots, y_t, z_t = j)} = \displaystyle{\sum_{j=1}^N\alpha_T(j)}\)</span>.</p>
<p>How to calculate the the <span class="math inline">\(\alpha_T(j)\)</span>s? This is where the magic of the forward algorithm happens. We use a recurrence relationship that saves us many computations.</p>
<p>The recurrence states that:</p>
<p><span class="math display">\[\begin{align*}
\alpha_t(j) &amp;= \sum_{i=1}^N \alpha_{t-1}(i) \gamma_{i,j} \omega_{j,y_t}
\end{align*}\]</span></p>
<p>How to obtain this recurrence? First, using the law of total probability with <span class="math inline">\(z_{t-1}\)</span>, we have that:
<span class="math display">\[\begin{align*}
\alpha_t(j) &amp;= \sum_{i=1}^N \Pr(y_1, \ldots, y_t, z_{t-1} = i, z_t = j)\\
\end{align*}\]</span></p>
<p>Second, using conditional probabilities, we get:
<span class="math display">\[\begin{align*}
\alpha_t(j) &amp;= \sum_{i=1}^N \Pr(y_t | z_{t-1} = i, z_t = j, y_1, \ldots, y_t) \Pr(z_{t-1} = i, z_t = j, y_1, \ldots, y_t)
\end{align*}\]</span></p>
<p>Third, using conditional probabilities again, on the second term of the product, we get:
<span class="math display">\[\begin{align*}
\alpha_t(j) &amp;= \sum_{i=1}^N \Pr(y_t | z_{t-1} = i, z_t = j, y_1, \ldots, y_t) \times \\ &amp; \Pr(z_t = j | z_{t-1} = i, y_1, \ldots, y_t) \Pr(z_{t-1} = i, y_1, \ldots, y_t)
\end{align*}\]</span></p>
<p>which, using conditional independence, simplifies into:</p>
<p><span class="math display">\[\begin{align*}
\alpha_t(j) &amp;= \sum_{i=1}^N \Pr(y_t | z_t = j) \Pr(z_t = j | z_{t-1} = i) \Pr(z_{t-1} = i, y_1, \ldots, y_t)
\end{align*}\]</span></p>
<p>Recognizing that <span class="math inline">\(\Pr(y_{t}|z_{t}=j)=\omega_{j,y_t}\)</span>, <span class="math inline">\(\Pr(z_{t} = j | z_{t-1} = i) = \gamma_{i,j}\)</span> and <span class="math inline">\(\Pr(z_{t-1} = i, y_1, \ldots, y_t) = \alpha_{t-1}(i)\)</span>, we obtain the recurrence.</p>
<p>In practice, the forward algorithm works as follows. First you initialize the procedure by calculating for the states <span class="math inline">\(j=1,\ldots,N\)</span> the quantities <span class="math inline">\(\alpha_1(j) = Pr(z_1 = j) \omega_{j,y_1}\)</span>. Then you compute for the states <span class="math inline">\(j=1,\ldots,N\)</span> the relationship <span class="math inline">\(\alpha_t(j) = \displaystyle{\sum_{i=1}^N \alpha_{t-1}(i) \gamma_{i,j} \omega_{j,y_t}}\)</span> for <span class="math inline">\(t = 2, \ldots, T\)</span>. Finally, you compute the marginal likelihood as <span class="math inline">\(\Pr(\mathbf{y}) = \displaystyle{\sum_{j=1}^N\alpha_T(j)}\)</span>. At each time <span class="math inline">\(t\)</span>, we need to calculate <span class="math inline">\(N\)</span> values of <span class="math inline">\(\alpha_t(j)\)</span>, and each <span class="math inline">\(\alpha_t(j)\)</span> is a sum of <span class="math inline">\(N\)</span> products of <span class="math inline">\(\alpha_{t-1}\)</span>, <span class="math inline">\(\gamma_{i,j}\)</span> and <span class="math inline">\(\omega_{j,y_t}\)</span>, hence <span class="math inline">\(TN^2\)</span> computations in total, which is much less than the <span class="math inline">\(2TN^T\)</span> calculations in the brute-force approach.</p>
<p>Going back to our example, we wish to calculate <span class="math inline">\(\Pr(y_1 = 2, y_2 = 2, y_3 = 1)\)</span>. First we initialize and compute <span class="math inline">\(\alpha_1(1)\)</span> and <span class="math inline">\(\alpha_1(2)\)</span>. We have:</p>
<p><span class="math display">\[\begin{align*}
\alpha_1(1) = \Pr(z_1=1) \omega_{1,y_1=2} = 1
\end{align*}\]</span></p>
<p>because all animals are alive and captured in first winter. We also have:</p>
<p><span class="math display">\[\begin{align*}
\alpha_1(2) = \Pr(z_1=2) \omega_{2,y_1=2} = 0
\end{align*}\]</span></p>
<p>Then we compute <span class="math inline">\(\alpha_2(1)\)</span> and <span class="math inline">\(\alpha_2(2)\)</span>. We have:</p>
<p><span class="math display">\[\begin{align*}
\alpha_2(1) &amp;= \sum_{i=1}^2 \alpha_1(i) \gamma_{i,1} \omega_{1,y_2=2}\\
            &amp;= \gamma_{1,1} \omega_{1,y_2=2}\\
            &amp;= \phi p
\end{align*}\]</span></p>
<p>because <span class="math inline">\(\alpha_1(2) = 0\)</span>. Also, we have:</p>
<p><span class="math display">\[\begin{align*}
\alpha_2(2) &amp;= \sum_{i=1}^2 \alpha_1(i) \gamma_{i,2} \omega_{2,y_2=2}\\
            &amp;= \gamma_{1,2} \omega_{2,y_2=2}\\
            &amp;= (1-\phi) 0
\end{align*}\]</span></p>
<p>Finally we compute <span class="math inline">\(\alpha_3(1)\)</span> and <span class="math inline">\(\alpha_3(2)\)</span>. We have:</p>
<p><span class="math display">\[\begin{align*}
\alpha_3(1) &amp;= \sum_{i=1}^2 \alpha_2(i) \gamma_{i,1} \omega_{1,y_3=1}\\
            &amp;= \alpha_2(1) \gamma_{1,1} \omega_{1,y_3=1}\\
            &amp;= \phi p \phi (1-p)
\end{align*}\]</span></p>
<p>and:</p>
<p><span class="math display">\[\begin{align*}
\alpha_3(2) &amp;= \sum_{i=1}^2 \alpha_2(i) \gamma_{i,2} \omega_{2,y_3=1}\\
            &amp;= \alpha_2(1) \gamma_{1,2} \omega_{2,y_3=1}\\
            &amp;= \phi p (1-\phi) 1
\end{align*}\]</span></p>
<p>Eventually, we compute <span class="math inline">\(\Pr(y_1=2,y_2=2,y_3=1)\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Pr(y_1=2,y_2=2,y_3=1) &amp;= \alpha_3(1) + \alpha_3(2)\\
            &amp;= \phi p (\phi) (1-p) + \phi p (1-\phi)\\
            &amp;= \phi p (1-\phi p)
\end{align*}\]</span></p>
<p>You can check that we did in total <span class="math inline">\(3 \times 2^2 = 12\)</span> operations.</p>
</div>
<div id="nimblemarginalization" class="section level3" number="1.8.3">
<h3><span class="header-section-number">1.8.3</span> NIMBLE implementation</h3>
<div id="diymarginalisation" class="section level4" number="1.8.3.1">
<h4><span class="header-section-number">1.8.3.1</span> Do it yourself</h4>
<p>In NIMBLE, we use functions to implement the forward algorithm. The only differences with the theory above is that i) we work on the log scale for numerical stability and ii) we use a matrix formulation of the recurrence.</p>
<p>First we write the density function:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="1.8-marginalization.html#cb33-1" tabindex="-1"></a>dHMMhomemade <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb33-2"><a href="1.8-marginalization.html#cb33-2" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>), </span>
<span id="cb33-3"><a href="1.8-marginalization.html#cb33-3" tabindex="-1"></a>                 <span class="at">probInit =</span> <span class="fu">double</span>(<span class="dv">1</span>), <span class="co"># vector of initial states</span></span>
<span id="cb33-4"><a href="1.8-marginalization.html#cb33-4" tabindex="-1"></a>                 <span class="at">probObs =</span> <span class="fu">double</span>(<span class="dv">2</span>), <span class="co"># observation matrix</span></span>
<span id="cb33-5"><a href="1.8-marginalization.html#cb33-5" tabindex="-1"></a>                 <span class="at">probTrans =</span> <span class="fu">double</span>(<span class="dv">2</span>), <span class="co"># transition matrix</span></span>
<span id="cb33-6"><a href="1.8-marginalization.html#cb33-6" tabindex="-1"></a>                 <span class="at">len =</span> <span class="fu">double</span>(<span class="dv">0</span>, <span class="at">default =</span> <span class="dv">0</span>), <span class="co"># number of sampling occasions</span></span>
<span id="cb33-7"><a href="1.8-marginalization.html#cb33-7" tabindex="-1"></a>                 <span class="at">log =</span> <span class="fu">integer</span>(<span class="dv">0</span>, <span class="at">default =</span> <span class="dv">0</span>)) {</span>
<span id="cb33-8"><a href="1.8-marginalization.html#cb33-8" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> probInit[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="co"># * probObs[1:2,x[1]] == 1 due to conditioning on first detection</span></span>
<span id="cb33-9"><a href="1.8-marginalization.html#cb33-9" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>len) {</span>
<span id="cb33-10"><a href="1.8-marginalization.html#cb33-10" tabindex="-1"></a>      alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> (alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%*%</span> probTrans[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">*</span> probObs[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,x[t]]</span>
<span id="cb33-11"><a href="1.8-marginalization.html#cb33-11" tabindex="-1"></a>    }</span>
<span id="cb33-12"><a href="1.8-marginalization.html#cb33-12" tabindex="-1"></a>    logL <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">sum</span>(alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb33-13"><a href="1.8-marginalization.html#cb33-13" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb33-14"><a href="1.8-marginalization.html#cb33-14" tabindex="-1"></a>    <span class="cf">if</span> (log) <span class="fu">return</span>(logL)</span>
<span id="cb33-15"><a href="1.8-marginalization.html#cb33-15" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">exp</span>(logL))</span>
<span id="cb33-16"><a href="1.8-marginalization.html#cb33-16" tabindex="-1"></a>  }</span>
<span id="cb33-17"><a href="1.8-marginalization.html#cb33-17" tabindex="-1"></a>)</span></code></pre></div>
<p>In passing, this is the function you would maximize in a frequentist approach (see Section <a href="#under-the-hood"><strong>??</strong></a>). Then we write a function to simulate values from a HMM:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="1.8-marginalization.html#cb34-1" tabindex="-1"></a>rHMMhomemade <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb34-2"><a href="1.8-marginalization.html#cb34-2" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="fu">integer</span>(),</span>
<span id="cb34-3"><a href="1.8-marginalization.html#cb34-3" tabindex="-1"></a>                 <span class="at">probInit =</span> <span class="fu">double</span>(<span class="dv">1</span>),</span>
<span id="cb34-4"><a href="1.8-marginalization.html#cb34-4" tabindex="-1"></a>                 <span class="at">probObs =</span> <span class="fu">double</span>(<span class="dv">2</span>),</span>
<span id="cb34-5"><a href="1.8-marginalization.html#cb34-5" tabindex="-1"></a>                 <span class="at">probTrans =</span> <span class="fu">double</span>(<span class="dv">2</span>),</span>
<span id="cb34-6"><a href="1.8-marginalization.html#cb34-6" tabindex="-1"></a>                 <span class="at">len =</span> <span class="fu">double</span>(<span class="dv">0</span>, <span class="at">default =</span> <span class="dv">0</span>)) {</span>
<span id="cb34-7"><a href="1.8-marginalization.html#cb34-7" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb34-8"><a href="1.8-marginalization.html#cb34-8" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">numeric</span>(len)</span>
<span id="cb34-9"><a href="1.8-marginalization.html#cb34-9" tabindex="-1"></a>    z[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rcat</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">prob =</span> probInit[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="co"># all individuals alive at t = 0</span></span>
<span id="cb34-10"><a href="1.8-marginalization.html#cb34-10" tabindex="-1"></a>    y <span class="ot">&lt;-</span> z</span>
<span id="cb34-11"><a href="1.8-marginalization.html#cb34-11" tabindex="-1"></a>    y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># all individuals are detected at t = 0</span></span>
<span id="cb34-12"><a href="1.8-marginalization.html#cb34-12" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>len){</span>
<span id="cb34-13"><a href="1.8-marginalization.html#cb34-13" tabindex="-1"></a>      <span class="co"># state at t given state at t-1</span></span>
<span id="cb34-14"><a href="1.8-marginalization.html#cb34-14" tabindex="-1"></a>      z[t] <span class="ot">&lt;-</span> <span class="fu">rcat</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">prob =</span> probTrans[z[t<span class="dv">-1</span>],<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) </span>
<span id="cb34-15"><a href="1.8-marginalization.html#cb34-15" tabindex="-1"></a>      <span class="co"># observation at t given state at t</span></span>
<span id="cb34-16"><a href="1.8-marginalization.html#cb34-16" tabindex="-1"></a>      y[t] <span class="ot">&lt;-</span> <span class="fu">rcat</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">prob =</span> probObs[z[t],<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) </span>
<span id="cb34-17"><a href="1.8-marginalization.html#cb34-17" tabindex="-1"></a>    }</span>
<span id="cb34-18"><a href="1.8-marginalization.html#cb34-18" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb34-19"><a href="1.8-marginalization.html#cb34-19" tabindex="-1"></a>  })</span></code></pre></div>
<p>We assign these functions to the global R environment:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="1.8-marginalization.html#cb35-1" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">&#39;dHMMhomemade&#39;</span>, dHMMhomemade, .GlobalEnv)</span>
<span id="cb35-2"><a href="1.8-marginalization.html#cb35-2" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">&#39;rHMMhomemade&#39;</span>, rHMMhomemade, .GlobalEnv)</span></code></pre></div>
<p>Now we resume our workflow:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="1.8-marginalization.html#cb36-1" tabindex="-1"></a><span class="co"># code</span></span>
<span id="cb36-2"><a href="1.8-marginalization.html#cb36-2" tabindex="-1"></a>hmm.survival <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb36-3"><a href="1.8-marginalization.html#cb36-3" tabindex="-1"></a>  phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior survival</span></span>
<span id="cb36-4"><a href="1.8-marginalization.html#cb36-4" tabindex="-1"></a>  p <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior detection</span></span>
<span id="cb36-5"><a href="1.8-marginalization.html#cb36-5" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb36-6"><a href="1.8-marginalization.html#cb36-6" tabindex="-1"></a>  delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb36-7"><a href="1.8-marginalization.html#cb36-7" tabindex="-1"></a>  delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb36-8"><a href="1.8-marginalization.html#cb36-8" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi      <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb36-9"><a href="1.8-marginalization.html#cb36-9" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi  <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb36-10"><a href="1.8-marginalization.html#cb36-10" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb36-11"><a href="1.8-marginalization.html#cb36-11" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb36-12"><a href="1.8-marginalization.html#cb36-12" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p    <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb36-13"><a href="1.8-marginalization.html#cb36-13" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> p        <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb36-14"><a href="1.8-marginalization.html#cb36-14" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb36-15"><a href="1.8-marginalization.html#cb36-15" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb36-16"><a href="1.8-marginalization.html#cb36-16" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb36-17"><a href="1.8-marginalization.html#cb36-17" tabindex="-1"></a>    y[i,<span class="dv">1</span><span class="sc">:</span>T] <span class="sc">~</span> <span class="fu">dHMMhomemade</span>(<span class="at">probInit =</span> delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb36-18"><a href="1.8-marginalization.html#cb36-18" tabindex="-1"></a>                            <span class="at">probObs =</span> omega[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="co"># observation matrix</span></span>
<span id="cb36-19"><a href="1.8-marginalization.html#cb36-19" tabindex="-1"></a>                            <span class="at">probTrans =</span> gamma[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="co"># transition matrix</span></span>
<span id="cb36-20"><a href="1.8-marginalization.html#cb36-20" tabindex="-1"></a>                            <span class="at">len =</span> T) <span class="co"># nb of sampling occasions</span></span>
<span id="cb36-21"><a href="1.8-marginalization.html#cb36-21" tabindex="-1"></a>  }</span>
<span id="cb36-22"><a href="1.8-marginalization.html#cb36-22" tabindex="-1"></a>})</span>
<span id="cb36-23"><a href="1.8-marginalization.html#cb36-23" tabindex="-1"></a><span class="co"># constants</span></span>
<span id="cb36-24"><a href="1.8-marginalization.html#cb36-24" tabindex="-1"></a>my.constants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), <span class="at">T =</span> <span class="dv">5</span>)</span>
<span id="cb36-25"><a href="1.8-marginalization.html#cb36-25" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb36-26"><a href="1.8-marginalization.html#cb36-26" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb36-27"><a href="1.8-marginalization.html#cb36-27" tabindex="-1"></a><span class="co"># initial values - no need to specify values for z anymore</span></span>
<span id="cb36-28"><a href="1.8-marginalization.html#cb36-28" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb36-29"><a href="1.8-marginalization.html#cb36-29" tabindex="-1"></a>                                  <span class="at">p =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb36-30"><a href="1.8-marginalization.html#cb36-30" tabindex="-1"></a><span class="co"># parameters to save</span></span>
<span id="cb36-31"><a href="1.8-marginalization.html#cb36-31" tabindex="-1"></a>parameters.to.save <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>)</span>
<span id="cb36-32"><a href="1.8-marginalization.html#cb36-32" tabindex="-1"></a><span class="co"># MCMC details</span></span>
<span id="cb36-33"><a href="1.8-marginalization.html#cb36-33" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb36-34"><a href="1.8-marginalization.html#cb36-34" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb36-35"><a href="1.8-marginalization.html#cb36-35" tabindex="-1"></a>n.chains <span class="ot">&lt;-</span> <span class="dv">2</span></span></code></pre></div>
<p>And run NIMBLE:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="1.8-marginalization.html#cb37-1" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb37-2"><a href="1.8-marginalization.html#cb37-2" tabindex="-1"></a>mcmc.output <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> hmm.survival,</span>
<span id="cb37-3"><a href="1.8-marginalization.html#cb37-3" tabindex="-1"></a>                          <span class="at">constants =</span> my.constants,</span>
<span id="cb37-4"><a href="1.8-marginalization.html#cb37-4" tabindex="-1"></a>                          <span class="at">data =</span> my.data,</span>
<span id="cb37-5"><a href="1.8-marginalization.html#cb37-5" tabindex="-1"></a>                          <span class="at">inits =</span> initial.values,</span>
<span id="cb37-6"><a href="1.8-marginalization.html#cb37-6" tabindex="-1"></a>                          <span class="at">monitors =</span> parameters.to.save,</span>
<span id="cb37-7"><a href="1.8-marginalization.html#cb37-7" tabindex="-1"></a>                          <span class="at">niter =</span> n.iter,</span>
<span id="cb37-8"><a href="1.8-marginalization.html#cb37-8" tabindex="-1"></a>                          <span class="at">nburnin =</span> n.burnin,</span>
<span id="cb37-9"><a href="1.8-marginalization.html#cb37-9" tabindex="-1"></a>                          <span class="at">nchains =</span> n.chains)</span>
<span id="cb37-10"><a href="1.8-marginalization.html#cb37-10" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb37-11"><a href="1.8-marginalization.html#cb37-11" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb37-12"><a href="1.8-marginalization.html#cb37-12" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb37-13"><a href="1.8-marginalization.html#cb37-13" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb37-14"><a href="1.8-marginalization.html#cb37-14" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb37-15"><a href="1.8-marginalization.html#cb37-15" tabindex="-1"></a>end_time <span class="sc">-</span> start_time</span>
<span id="cb37-16"><a href="1.8-marginalization.html#cb37-16" tabindex="-1"></a><span class="do">## Time difference of 26.68 secs</span></span></code></pre></div>
<p>The numerical summaries are similar to those we obtained with the complete likelihood, and effective samples sizes are larger denoting better mixing:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="1.8-marginalization.html#cb38-1" tabindex="-1"></a><span class="fu">MCMCsummary</span>(mcmc.output, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb38-2"><a href="1.8-marginalization.html#cb38-2" tabindex="-1"></a><span class="do">##     mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span id="cb38-3"><a href="1.8-marginalization.html#cb38-3" tabindex="-1"></a><span class="do">## p   0.61 0.06 0.49 0.61  0.72    1  1211</span></span>
<span id="cb38-4"><a href="1.8-marginalization.html#cb38-4" tabindex="-1"></a><span class="do">## phi 0.76 0.04 0.67 0.76  0.84    1  1483</span></span></code></pre></div>
</div>
<div id="do-it-with-nimbleecology" class="section level4" number="1.8.3.2">
<h4><span class="header-section-number">1.8.3.2</span> Do it with <code>nimbleEcology</code></h4>
<p>Writing NIMBLE functions is not easy. Fortunately, the NIMBLE folks got you covered. They developed the package <code>nimbleEcology</code> that implements some of the most popular ecological models with latent states.</p>
<p>We will use the function <code>dHMMo</code> which provides the distribution of a hidden Markov model with time-independent transition matrix and time-dependent observation matrix. Why time-dependent observation matrix? Because we need to tell NIMBLE that detection at first encounter is 1.</p>
<p>We load the package:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="1.8-marginalization.html#cb39-1" tabindex="-1"></a><span class="fu">library</span>(nimbleEcology)</span></code></pre></div>
<p>The NIMBLE code is:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="1.8-marginalization.html#cb40-1" tabindex="-1"></a>hmm.survival <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb40-2"><a href="1.8-marginalization.html#cb40-2" tabindex="-1"></a>  phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior survival</span></span>
<span id="cb40-3"><a href="1.8-marginalization.html#cb40-3" tabindex="-1"></a>  p <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior detection</span></span>
<span id="cb40-4"><a href="1.8-marginalization.html#cb40-4" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb40-5"><a href="1.8-marginalization.html#cb40-5" tabindex="-1"></a>  delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb40-6"><a href="1.8-marginalization.html#cb40-6" tabindex="-1"></a>  delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb40-7"><a href="1.8-marginalization.html#cb40-7" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi      <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb40-8"><a href="1.8-marginalization.html#cb40-8" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi  <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb40-9"><a href="1.8-marginalization.html#cb40-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb40-10"><a href="1.8-marginalization.html#cb40-10" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb40-11"><a href="1.8-marginalization.html#cb40-11" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(alive first -&gt; non-detected first)</span></span>
<span id="cb40-12"><a href="1.8-marginalization.html#cb40-12" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(alive first -&gt; detected first)</span></span>
<span id="cb40-13"><a href="1.8-marginalization.html#cb40-13" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead first -&gt; non-detected first)</span></span>
<span id="cb40-14"><a href="1.8-marginalization.html#cb40-14" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead first -&gt; detected first)</span></span>
<span id="cb40-15"><a href="1.8-marginalization.html#cb40-15" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>){</span>
<span id="cb40-16"><a href="1.8-marginalization.html#cb40-16" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p    <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb40-17"><a href="1.8-marginalization.html#cb40-17" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> p        <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb40-18"><a href="1.8-marginalization.html#cb40-18" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb40-19"><a href="1.8-marginalization.html#cb40-19" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb40-20"><a href="1.8-marginalization.html#cb40-20" tabindex="-1"></a>  }</span>
<span id="cb40-21"><a href="1.8-marginalization.html#cb40-21" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb40-22"><a href="1.8-marginalization.html#cb40-22" tabindex="-1"></a>    y[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">~</span> <span class="fu">dHMMo</span>(<span class="at">init =</span> delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="co"># vector of initial state probabilities</span></span>
<span id="cb40-23"><a href="1.8-marginalization.html#cb40-23" tabindex="-1"></a>                     <span class="at">probObs =</span> omega[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="co"># observation matrix</span></span>
<span id="cb40-24"><a href="1.8-marginalization.html#cb40-24" tabindex="-1"></a>                     <span class="at">probTrans =</span> gamma[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="co"># transition matrix</span></span>
<span id="cb40-25"><a href="1.8-marginalization.html#cb40-25" tabindex="-1"></a>                     <span class="at">len =</span> <span class="dv">5</span>, <span class="co"># nb of sampling occasions</span></span>
<span id="cb40-26"><a href="1.8-marginalization.html#cb40-26" tabindex="-1"></a>                     <span class="at">checkRowSums =</span> <span class="dv">0</span>) <span class="co"># skip validity checks</span></span>
<span id="cb40-27"><a href="1.8-marginalization.html#cb40-27" tabindex="-1"></a>  }</span>
<span id="cb40-28"><a href="1.8-marginalization.html#cb40-28" tabindex="-1"></a>})</span></code></pre></div>
<p>You may see that we no longer have the states in the code as we use the marginalized likelihood. The <code>dHMMo</code> takes several arguments, including <code>init</code> the vector of initial state probabilities, <code>probObs</code> the observation matrix, <code>probTrans</code> the transition matrix and <code>len</code> the number of sampling occasions.</p>
<p>Next steps are similar to the workflow we used before. The only difference is that we do not need to specify initial values for the latent states:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="1.8-marginalization.html#cb41-1" tabindex="-1"></a><span class="co"># constants</span></span>
<span id="cb41-2"><a href="1.8-marginalization.html#cb41-2" tabindex="-1"></a>my.constants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y))</span>
<span id="cb41-3"><a href="1.8-marginalization.html#cb41-3" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb41-4"><a href="1.8-marginalization.html#cb41-4" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb41-5"><a href="1.8-marginalization.html#cb41-5" tabindex="-1"></a><span class="co"># initial values - no need to specify values for z anymore</span></span>
<span id="cb41-6"><a href="1.8-marginalization.html#cb41-6" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb41-7"><a href="1.8-marginalization.html#cb41-7" tabindex="-1"></a>                                  <span class="at">p =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb41-8"><a href="1.8-marginalization.html#cb41-8" tabindex="-1"></a><span class="co"># parameters to save</span></span>
<span id="cb41-9"><a href="1.8-marginalization.html#cb41-9" tabindex="-1"></a>parameters.to.save <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>)</span>
<span id="cb41-10"><a href="1.8-marginalization.html#cb41-10" tabindex="-1"></a><span class="co"># MCMC details</span></span>
<span id="cb41-11"><a href="1.8-marginalization.html#cb41-11" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb41-12"><a href="1.8-marginalization.html#cb41-12" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb41-13"><a href="1.8-marginalization.html#cb41-13" tabindex="-1"></a>n.chains <span class="ot">&lt;-</span> <span class="dv">2</span></span></code></pre></div>
<p>Now we run NIMBLE:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="1.8-marginalization.html#cb42-1" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb42-2"><a href="1.8-marginalization.html#cb42-2" tabindex="-1"></a>mcmc.output <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> hmm.survival,</span>
<span id="cb42-3"><a href="1.8-marginalization.html#cb42-3" tabindex="-1"></a>                          <span class="at">constants =</span> my.constants,</span>
<span id="cb42-4"><a href="1.8-marginalization.html#cb42-4" tabindex="-1"></a>                          <span class="at">data =</span> my.data,</span>
<span id="cb42-5"><a href="1.8-marginalization.html#cb42-5" tabindex="-1"></a>                          <span class="at">inits =</span> initial.values,</span>
<span id="cb42-6"><a href="1.8-marginalization.html#cb42-6" tabindex="-1"></a>                          <span class="at">monitors =</span> parameters.to.save,</span>
<span id="cb42-7"><a href="1.8-marginalization.html#cb42-7" tabindex="-1"></a>                          <span class="at">niter =</span> n.iter,</span>
<span id="cb42-8"><a href="1.8-marginalization.html#cb42-8" tabindex="-1"></a>                          <span class="at">nburnin =</span> n.burnin,</span>
<span id="cb42-9"><a href="1.8-marginalization.html#cb42-9" tabindex="-1"></a>                          <span class="at">nchains =</span> n.chains)</span>
<span id="cb42-10"><a href="1.8-marginalization.html#cb42-10" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb42-11"><a href="1.8-marginalization.html#cb42-11" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb42-12"><a href="1.8-marginalization.html#cb42-12" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb42-13"><a href="1.8-marginalization.html#cb42-13" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span>
<span id="cb42-14"><a href="1.8-marginalization.html#cb42-14" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb42-15"><a href="1.8-marginalization.html#cb42-15" tabindex="-1"></a>end_time <span class="sc">-</span> start_time</span>
<span id="cb42-16"><a href="1.8-marginalization.html#cb42-16" tabindex="-1"></a><span class="do">## Time difference of 29.72 secs</span></span></code></pre></div>
<p>Now we display the numerical summaries of the posterior distributions:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="1.8-marginalization.html#cb43-1" tabindex="-1"></a><span class="fu">MCMCsummary</span>(mcmc.output, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb43-2"><a href="1.8-marginalization.html#cb43-2" tabindex="-1"></a><span class="do">##     mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span id="cb43-3"><a href="1.8-marginalization.html#cb43-3" tabindex="-1"></a><span class="do">## p   0.61 0.06 0.49 0.61  0.72    1  1453</span></span>
<span id="cb43-4"><a href="1.8-marginalization.html#cb43-4" tabindex="-1"></a><span class="do">## phi 0.76 0.04 0.67 0.76  0.84    1  1359</span></span></code></pre></div>
<p>The results are similar what we obtained previously with our home-made marginalized likelihood (Section <a href="1.8-marginalization.html#diymarginalisation">1.8.3.1</a>), or with the full likelihood (<a href="1.7-fittinghmmnimble.html#fittinghmmnimble">1.7</a>).</p>
</div>
</div>
</div>
<p style="text-align: center;">
<a href="1.7-fittinghmmnimble.html"><button class="btn btn-default">Previous</button></a>
<a href="1.9-pooled-likelihood.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>

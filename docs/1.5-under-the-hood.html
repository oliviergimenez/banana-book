<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="1.5 Under the hood | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models" />
<meta property="og:type" content="book" />

<meta property="og:description" content="This is a textbook on the analysis of capture-recapture data with hidden Markov models (HMM) implemented in the Bayesian framework with R." />
<meta name="github-repo" content="oliviergimenez/banana-book" />

<meta name="author" content="Olivier Gimenez" />

<meta name="date" content="2022-12-23" />


<meta name="description" content="This is a textbook on the analysis of capture-recapture data with hidden Markov models (HMM) implemented in the Bayesian framework with R.">

<title>1.5 Under the hood | Bayesian Analysis of Capture-Recapture Data with Hidden Markov Models</title>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
/* show arrow before summary tag as in bootstrap
TODO: remove if boostrap in updated in html_document (rmarkdown#1485) */
details > summary {
  display: list-item;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#welcome" id="toc-welcome">Welcome</a>
<ul>
<li><a href="license.html#license" id="toc-license">License</a></li>
</ul></li>
<li class="has-sub"><a href="preface.html#preface" id="toc-preface">Preface</a>
<ul>
<li><a href="why-this-book.html#why-this-book" id="toc-why-this-book">Why this book?</a></li>
<li><a href="who-should-read-this-book.html#who-should-read-this-book" id="toc-who-should-read-this-book">Who should read this book?</a></li>
<li><a href="what-will-you-learn.html#what-will-you-learn" id="toc-what-will-you-learn">What will you learn?</a></li>
<li><a href="what-wont-you-learn.html#what-wont-you-learn" id="toc-what-wont-you-learn">What wonâ€™t you learn?</a></li>
<li><a href="prerequisites.html#prerequisites" id="toc-prerequisites">Prerequisites</a></li>
<li><a href="acknowledgements.html#acknowledgements" id="toc-acknowledgements">Acknowledgements</a></li>
<li><a href="how-this-book-was-written.html#how-this-book-was-written" id="toc-how-this-book-was-written">How this book was written</a></li>
</ul></li>
<li><a href="about-the-author.html#about-the-author" id="toc-about-the-author">About the author</a></li>
<li class="part"><span><b>I I. Fundations</b></span></li>
<li><a href="introduction.html#introduction" id="toc-introduction">Introduction</a></li>
<li class="has-sub"><a href="1-intronimble.html#intronimble" id="toc-intronimble"><span class="toc-section-number">1</span> NIMBLE tutorial</a>
<ul>
<li><a href="1.1-introduction-1.html#introduction-1" id="toc-introduction-1"><span class="toc-section-number">1.1</span> Introduction</a></li>
<li><a href="1.2-what-is-nimble.html#what-is-nimble" id="toc-what-is-nimble"><span class="toc-section-number">1.2</span> What is NIMBLE?</a></li>
<li><a href="1.3-start-nimble.html#start-nimble" id="toc-start-nimble"><span class="toc-section-number">1.3</span> Getting started</a></li>
<li class="has-sub"><a href="1.4-functions-in-nimble.html#functions-in-nimble" id="toc-functions-in-nimble"><span class="toc-section-number">1.4</span> Programming</a>
<ul>
<li><a href="1.4-functions-in-nimble.html#nimble-functions" id="toc-nimble-functions"><span class="toc-section-number">1.4.1</span> NIMBLE functions</a></li>
<li><a href="1.4-functions-in-nimble.html#callrfninnimble" id="toc-callrfninnimble"><span class="toc-section-number">1.4.2</span> Calling R/C++ functions</a></li>
<li><a href="1.4-functions-in-nimble.html#user-defined-distributions" id="toc-user-defined-distributions"><span class="toc-section-number">1.4.3</span> User-defined distributions</a></li>
</ul></li>
<li><a href="1.5-under-the-hood.html#under-the-hood" id="toc-under-the-hood"><span class="toc-section-number">1.5</span> Under the hood</a></li>
<li class="has-sub"><a href="1.6-mcmc-samplers.html#mcmc-samplers" id="toc-mcmc-samplers"><span class="toc-section-number">1.6</span> MCMC samplers</a>
<ul>
<li><a href="1.6-mcmc-samplers.html#change-sampler" id="toc-change-sampler"><span class="toc-section-number">1.6.1</span> Default samplers</a></li>
<li><a href="1.6-mcmc-samplers.html#user-defined-samplers" id="toc-user-defined-samplers"><span class="toc-section-number">1.6.2</span> User-defined samplers</a></li>
</ul></li>
<li class="has-sub"><a href="1.7-tips-and-tricks.html#tips-and-tricks" id="toc-tips-and-tricks"><span class="toc-section-number">1.7</span> Tips and tricks</a>
<ul>
<li><a href="1.7-tips-and-tricks.html#precision-vs-standard-deviation" id="toc-precision-vs-standard-deviation"><span class="toc-section-number">1.7.1</span> Precision vs standard deviation</a></li>
<li><a href="1.7-tips-and-tricks.html#indexing" id="toc-indexing"><span class="toc-section-number">1.7.2</span> Indexing</a></li>
<li><a href="1.7-tips-and-tricks.html#faster-compilation" id="toc-faster-compilation"><span class="toc-section-number">1.7.3</span> Faster compilation</a></li>
<li><a href="1.7-tips-and-tricks.html#updating-mcmc-chains" id="toc-updating-mcmc-chains"><span class="toc-section-number">1.7.4</span> Updating MCMC chains</a></li>
<li><a href="1.7-tips-and-tricks.html#reproducibility" id="toc-reproducibility"><span class="toc-section-number">1.7.5</span> Reproducibility</a></li>
<li><a href="1.7-tips-and-tricks.html#parallelization" id="toc-parallelization"><span class="toc-section-number">1.7.6</span> Parallelization</a></li>
<li><a href="1.7-tips-and-tricks.html#incomplete-initialization" id="toc-incomplete-initialization"><span class="toc-section-number">1.7.7</span> Incomplete initialization</a></li>
<li><a href="1.7-tips-and-tricks.html#vectorization" id="toc-vectorization"><span class="toc-section-number">1.7.8</span> Vectorization</a></li>
</ul></li>
<li><a href="1.8-summary.html#summary" id="toc-summary"><span class="toc-section-number">1.8</span> Summary</a></li>
<li><a href="1.9-suggested-reading.html#suggested-reading" id="toc-suggested-reading"><span class="toc-section-number">1.9</span> Suggested reading</a></li>
</ul></li>
<li><a href="faq.html#faq" id="toc-faq">FAQ</a></li>
<li><a href="references.html#references" id="toc-references">References</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="under-the-hood" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> Under the hood</h2>
<p>So far, you have used <code>nimbleMCMC()</code> which runs the default MCMC workflow. This is perfecly fine for most applications. However, in some situations you need to customize the MCMC samplers to improve or fasten convergence. NIMBLE allows you to look under the hood by using a detailed workflow in several steps: <code>nimbleModel()</code>, <code>configureMCMC()</code>, <code>buildMCMC()</code>, <code>compileNimble()</code> and <code>runMCMC()</code>. Note that <code>nimbleMCMC()</code> does all of this at once.</p>
<p>We write the model code, read in data and pick initial values as before:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="1.5-under-the-hood.html#cb39-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb39-2"><a href="1.5-under-the-hood.html#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb39-3"><a href="1.5-under-the-hood.html#cb39-3" aria-hidden="true" tabindex="-1"></a>  survived <span class="sc">~</span> <span class="fu">dbinom</span>(theta, released)</span>
<span id="cb39-4"><a href="1.5-under-the-hood.html#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior</span></span>
<span id="cb39-5"><a href="1.5-under-the-hood.html#cb39-5" aria-hidden="true" tabindex="-1"></a>  theta <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb39-6"><a href="1.5-under-the-hood.html#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># derived quantity</span></span>
<span id="cb39-7"><a href="1.5-under-the-hood.html#cb39-7" aria-hidden="true" tabindex="-1"></a>  lifespan <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(theta)</span>
<span id="cb39-8"><a href="1.5-under-the-hood.html#cb39-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-9"><a href="1.5-under-the-hood.html#cb39-9" aria-hidden="true" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">survived =</span> <span class="dv">19</span>, <span class="at">released =</span> <span class="dv">57</span>)</span>
<span id="cb39-10"><a href="1.5-under-the-hood.html#cb39-10" aria-hidden="true" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p>First step is to create the model as an R object (uncompiled model) with <code>nimbleModel()</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="1.5-under-the-hood.html#cb40-1" aria-hidden="true" tabindex="-1"></a>survival <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(<span class="at">code =</span> model,</span>
<span id="cb40-2"><a href="1.5-under-the-hood.html#cb40-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> my.data,</span>
<span id="cb40-3"><a href="1.5-under-the-hood.html#cb40-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">inits =</span> initial.values)</span></code></pre></div>
<p>You can look at its nodes:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="1.5-under-the-hood.html#cb41-1" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span><span class="fu">getNodeNames</span>()</span>
<span id="cb41-2"><a href="1.5-under-the-hood.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] &quot;theta&quot;    &quot;lifespan&quot; &quot;survived&quot;</span></span></code></pre></div>
<p>You can look at the values stored at each node:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="1.5-under-the-hood.html#cb42-1" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span>theta</span>
<span id="cb42-2"><a href="1.5-under-the-hood.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.5</span></span>
<span id="cb42-3"><a href="1.5-under-the-hood.html#cb42-3" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span>survived</span>
<span id="cb42-4"><a href="1.5-under-the-hood.html#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 19</span></span>
<span id="cb42-5"><a href="1.5-under-the-hood.html#cb42-5" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span>lifespan </span>
<span id="cb42-6"><a href="1.5-under-the-hood.html#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1.443</span></span>
<span id="cb42-7"><a href="1.5-under-the-hood.html#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># this is -1/log(0.5)</span></span></code></pre></div>
<p>We can also calculate the log-likelihood at the initial value for <code>theta</code>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="1.5-under-the-hood.html#cb43-1" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb43-2"><a href="1.5-under-the-hood.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] -5.422</span></span>
<span id="cb43-3"><a href="1.5-under-the-hood.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this is dbinom(x = 19, size = 57, prob = 0.5, log = TRUE)</span></span></code></pre></div>
<p>The ability in NIMBLE to access the nodes of your model and to evaluate the model likelihood can help you in identifying bugs in your code. <strong>Give example? Provide negative initial value for theta, or released in data &lt; survived.</strong></p>
<p>You can obtain the graph of the model as in Figure <a href="1.3-start-nimble.html#fig:dag-survival">1.2</a> with:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="1.5-under-the-hood.html#cb44-1" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">$</span><span class="fu">plotGraph</span>()</span></code></pre></div>
<p><img src="banana-book_files/figure-html/unnamed-chunk-53-1.png" width="672" /></p>
<p>Second we compile the model with <code>compileNimble()</code>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="1.5-under-the-hood.html#cb45-1" aria-hidden="true" tabindex="-1"></a>Csurvival <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(survival)</span></code></pre></div>
<p>With <code>compileNimble()</code>, the C++ code is generated, compiled and loaded back into R so that it can be used in R (compiled model):</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="1.5-under-the-hood.html#cb46-1" aria-hidden="true" tabindex="-1"></a>Csurvival<span class="sc">$</span>theta</span>
<span id="cb46-2"><a href="1.5-under-the-hood.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.5</span></span></code></pre></div>
<p>Now you have two versions of the model, <code>survival</code> is in R and <code>Csurvival</code> in C++. Being able to separate the steps of model building and parameter estimation is a strength of NIMBLE. This gives you a lot of flexibility at both steps. For example, imagine you would like to fit your model with maximum likelihood, then you can do it by wrapping your model in an R function that gets the likelihood and maximise this function. Using the C version of the model, you can write:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="1.5-under-the-hood.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function for negative log-likelihood to minimize</span></span>
<span id="cb47-2"><a href="1.5-under-the-hood.html#cb47-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(par) {</span>
<span id="cb47-3"><a href="1.5-under-the-hood.html#cb47-3" aria-hidden="true" tabindex="-1"></a>    Csurvival[[<span class="st">&#39;theta&#39;</span>]] <span class="ot">&lt;-</span> par <span class="co"># assign par to theta </span></span>
<span id="cb47-4"><a href="1.5-under-the-hood.html#cb47-4" aria-hidden="true" tabindex="-1"></a>    ll <span class="ot">&lt;-</span> Csurvival<span class="sc">$</span><span class="fu">calculate</span>() <span class="co"># update log-likelihood with par value</span></span>
<span id="cb47-5"><a href="1.5-under-the-hood.html#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span>ll) <span class="co"># return negative log-likelihood</span></span>
<span id="cb47-6"><a href="1.5-under-the-hood.html#cb47-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-7"><a href="1.5-under-the-hood.html#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate function at 0.5 and 0.9</span></span>
<span id="cb47-8"><a href="1.5-under-the-hood.html#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="fl">0.5</span>)</span>
<span id="cb47-9"><a href="1.5-under-the-hood.html#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 5.422</span></span>
<span id="cb47-10"><a href="1.5-under-the-hood.html#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="fl">0.9</span>)</span>
<span id="cb47-11"><a href="1.5-under-the-hood.html#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 55.41</span></span>
<span id="cb47-12"><a href="1.5-under-the-hood.html#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># minimize function</span></span>
<span id="cb47-13"><a href="1.5-under-the-hood.html#cb47-13" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">optimize</span>(f, <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb47-14"><a href="1.5-under-the-hood.html#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(out<span class="sc">$</span>minimum, <span class="dv">2</span>)</span>
<span id="cb47-15"><a href="1.5-under-the-hood.html#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.33</span></span></code></pre></div>
<p>By maximising the likelihood (or minimising the negative log-likelihood), you obtain the maximum likelihood estimate of animal survival, which is exactly 19 surviving animals over 57 released animals or 0.33.</p>
<p>Third we create a MCMC configuration for our model with <code>configureMCMC()</code>:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="1.5-under-the-hood.html#cb48-1" aria-hidden="true" tabindex="-1"></a>survivalConf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(survival)</span>
<span id="cb48-2"><a href="1.5-under-the-hood.html#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== Monitors =====</span></span>
<span id="cb48-3"><a href="1.5-under-the-hood.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="do">## thin = 1: theta</span></span>
<span id="cb48-4"><a href="1.5-under-the-hood.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== Samplers =====</span></span>
<span id="cb48-5"><a href="1.5-under-the-hood.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="do">## RW sampler (1)</span></span>
<span id="cb48-6"><a href="1.5-under-the-hood.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   - theta</span></span></code></pre></div>
<p>This steps tells you the nodes that are monitored by default, and the MCMC samplers than have been assigned to them. Here <code>theta</code> is monitored, and samples from its posterior distribution are simulated with a random walk sampler similar to the Metropolis sampler we coded in the previous chapter in Section <a href="#metropolis-algorithm"><strong>??</strong></a>.</p>
<p>To monitor <code>lifespan</code> in addition to <code>theta</code>, you write:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="1.5-under-the-hood.html#cb49-1" aria-hidden="true" tabindex="-1"></a>survivalConf<span class="sc">$</span><span class="fu">addMonitors</span>(<span class="fu">c</span>(<span class="st">&quot;lifespan&quot;</span>))</span>
<span id="cb49-2"><a href="1.5-under-the-hood.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="do">## thin = 1: lifespan, theta</span></span>
<span id="cb49-3"><a href="1.5-under-the-hood.html#cb49-3" aria-hidden="true" tabindex="-1"></a>survivalConf</span>
<span id="cb49-4"><a href="1.5-under-the-hood.html#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== Monitors =====</span></span>
<span id="cb49-5"><a href="1.5-under-the-hood.html#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="do">## thin = 1: lifespan, theta</span></span>
<span id="cb49-6"><a href="1.5-under-the-hood.html#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== Samplers =====</span></span>
<span id="cb49-7"><a href="1.5-under-the-hood.html#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="do">## RW sampler (1)</span></span>
<span id="cb49-8"><a href="1.5-under-the-hood.html#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   - theta</span></span></code></pre></div>
<p>Third, we create a MCMC function with <code>buildMCMC()</code> and compile it with <code>compileNimble()</code>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="1.5-under-the-hood.html#cb50-1" aria-hidden="true" tabindex="-1"></a>survivalMCMC <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(survivalConf)</span>
<span id="cb50-2"><a href="1.5-under-the-hood.html#cb50-2" aria-hidden="true" tabindex="-1"></a>CsurvivalMCMC <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(survivalMCMC, <span class="at">project =</span> survival)</span></code></pre></div>
<p>Note that models and <code>nimbleFunctions</code> need to be compiled before they can be used to specify a project.</p>
<p>Fourth, we run NIMBLE with <code>runMCMC()</code>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="1.5-under-the-hood.html#cb51-1" aria-hidden="true" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb51-2"><a href="1.5-under-the-hood.html#cb51-2" aria-hidden="true" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb51-3"><a href="1.5-under-the-hood.html#cb51-3" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(<span class="at">mcmc =</span> CsurvivalMCMC, </span>
<span id="cb51-4"><a href="1.5-under-the-hood.html#cb51-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">niter =</span> n.iter,</span>
<span id="cb51-5"><a href="1.5-under-the-hood.html#cb51-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nburnin =</span> n.burnin)</span>
<span id="cb51-6"><a href="1.5-under-the-hood.html#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------|-------------|-------------|-------------|</span></span>
<span id="cb51-7"><a href="1.5-under-the-hood.html#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="do">## |-------------------------------------------------------|</span></span></code></pre></div>
<p>We run a single chain but <code>runMCMC()</code> allows you to use multiple chains as with <code>nimbleMCMC()</code>.</p>
<p>You can look into <code>samples</code> which contains values simulated from the posterior distribution of the parameters we monitor:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="1.5-under-the-hood.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(samples)</span>
<span id="cb52-2"><a href="1.5-under-the-hood.html#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="do">##      lifespan  theta</span></span>
<span id="cb52-3"><a href="1.5-under-the-hood.html#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,]   0.6391 0.2092</span></span>
<span id="cb52-4"><a href="1.5-under-the-hood.html#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,]   0.6391 0.2092</span></span>
<span id="cb52-5"><a href="1.5-under-the-hood.html#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [3,]   0.6770 0.2283</span></span>
<span id="cb52-6"><a href="1.5-under-the-hood.html#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [4,]   0.6770 0.2283</span></span>
<span id="cb52-7"><a href="1.5-under-the-hood.html#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [5,]   0.6770 0.2283</span></span>
<span id="cb52-8"><a href="1.5-under-the-hood.html#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [6,]   0.6770 0.2283</span></span></code></pre></div>
<p>From here, you can obtain numerical summaries with <code>samplesSummary()</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="1.5-under-the-hood.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">samplesSummary</span>(samples)</span>
<span id="cb53-2"><a href="1.5-under-the-hood.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="do">##            Mean Median St.Dev. 95%CI_low 95%CI_upp</span></span>
<span id="cb53-3"><a href="1.5-under-the-hood.html#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="do">## lifespan 0.9344 0.9202 0.15606    0.6649    1.2883</span></span>
<span id="cb53-4"><a href="1.5-under-the-hood.html#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="do">## theta    0.3384 0.3373 0.06006    0.2222    0.4601</span></span></code></pre></div>
<p>I have summarized the steps above in the box below.</p>
<div class="rmdnote">
<p><strong>Detailed NIMBLE workflow:</strong></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="1.5-under-the-hood.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model building</span></span>
<span id="cb54-2"><a href="1.5-under-the-hood.html#cb54-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb54-3"><a href="1.5-under-the-hood.html#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb54-4"><a href="1.5-under-the-hood.html#cb54-4" aria-hidden="true" tabindex="-1"></a>  survived <span class="sc">~</span> <span class="fu">dbinom</span>(theta, released)</span>
<span id="cb54-5"><a href="1.5-under-the-hood.html#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior</span></span>
<span id="cb54-6"><a href="1.5-under-the-hood.html#cb54-6" aria-hidden="true" tabindex="-1"></a>  theta <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb54-7"><a href="1.5-under-the-hood.html#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># derived quantity</span></span>
<span id="cb54-8"><a href="1.5-under-the-hood.html#cb54-8" aria-hidden="true" tabindex="-1"></a>  lifespan <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(theta)</span>
<span id="cb54-9"><a href="1.5-under-the-hood.html#cb54-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb54-10"><a href="1.5-under-the-hood.html#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># read in data</span></span>
<span id="cb54-11"><a href="1.5-under-the-hood.html#cb54-11" aria-hidden="true" tabindex="-1"></a>my.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">released =</span> <span class="dv">57</span>, <span class="at">survived =</span> <span class="dv">19</span>)</span>
<span id="cb54-12"><a href="1.5-under-the-hood.html#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co"># pick initial values</span></span>
<span id="cb54-13"><a href="1.5-under-the-hood.html#cb54-13" aria-hidden="true" tabindex="-1"></a>initial.values <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">theta =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb54-14"><a href="1.5-under-the-hood.html#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co"># create model as an R object (uncompiled model)</span></span>
<span id="cb54-15"><a href="1.5-under-the-hood.html#cb54-15" aria-hidden="true" tabindex="-1"></a>survival <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(<span class="at">code =</span> model,</span>
<span id="cb54-16"><a href="1.5-under-the-hood.html#cb54-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> my.data,</span>
<span id="cb54-17"><a href="1.5-under-the-hood.html#cb54-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">inits =</span> <span class="fu">initial.values</span>())</span>
<span id="cb54-18"><a href="1.5-under-the-hood.html#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># compile model</span></span>
<span id="cb54-19"><a href="1.5-under-the-hood.html#cb54-19" aria-hidden="true" tabindex="-1"></a>Csurvival <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(survival)</span>
<span id="cb54-20"><a href="1.5-under-the-hood.html#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co"># create a MCMC configuration</span></span>
<span id="cb54-21"><a href="1.5-under-the-hood.html#cb54-21" aria-hidden="true" tabindex="-1"></a>survivalConf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(survival)</span>
<span id="cb54-22"><a href="1.5-under-the-hood.html#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co"># add lifespan to list of parameters to monitor</span></span>
<span id="cb54-23"><a href="1.5-under-the-hood.html#cb54-23" aria-hidden="true" tabindex="-1"></a>survivalConf<span class="sc">$</span><span class="fu">addMonitors</span>(<span class="fu">c</span>(<span class="st">&quot;lifespan&quot;</span>))</span>
<span id="cb54-24"><a href="1.5-under-the-hood.html#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co"># create a MCMC function and compile it</span></span>
<span id="cb54-25"><a href="1.5-under-the-hood.html#cb54-25" aria-hidden="true" tabindex="-1"></a>survivalMCMC <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(survivalConf)</span>
<span id="cb54-26"><a href="1.5-under-the-hood.html#cb54-26" aria-hidden="true" tabindex="-1"></a>CsurvivalMCMC <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(survivalMCMC, <span class="at">project =</span> survival)</span>
<span id="cb54-27"><a href="1.5-under-the-hood.html#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co"># specify MCMC details</span></span>
<span id="cb54-28"><a href="1.5-under-the-hood.html#cb54-28" aria-hidden="true" tabindex="-1"></a>n.iter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb54-29"><a href="1.5-under-the-hood.html#cb54-29" aria-hidden="true" tabindex="-1"></a>n.burnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb54-30"><a href="1.5-under-the-hood.html#cb54-30" aria-hidden="true" tabindex="-1"></a>n.chains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb54-31"><a href="1.5-under-the-hood.html#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="co"># run NIMBLE</span></span>
<span id="cb54-32"><a href="1.5-under-the-hood.html#cb54-32" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(<span class="at">mcmc =</span> CsurvivalMCMC, </span>
<span id="cb54-33"><a href="1.5-under-the-hood.html#cb54-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">niter =</span> n.iter,</span>
<span id="cb54-34"><a href="1.5-under-the-hood.html#cb54-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nburnin =</span> n.burnin,</span>
<span id="cb54-35"><a href="1.5-under-the-hood.html#cb54-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nchain =</span> n.chains)</span>
<span id="cb54-36"><a href="1.5-under-the-hood.html#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate numerical summaries</span></span>
<span id="cb54-37"><a href="1.5-under-the-hood.html#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCsummary</span>(<span class="at">object =</span> samples, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb54-38"><a href="1.5-under-the-hood.html#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize parameter posterior distribution</span></span>
<span id="cb54-39"><a href="1.5-under-the-hood.html#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCplot</span>(<span class="at">object =</span> samples, </span>
<span id="cb54-40"><a href="1.5-under-the-hood.html#cb54-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">params =</span> <span class="st">&#39;theta&#39;</span>)</span>
<span id="cb54-41"><a href="1.5-under-the-hood.html#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="co"># check convergence</span></span>
<span id="cb54-42"><a href="1.5-under-the-hood.html#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="fu">MCMCtrace</span>(<span class="at">object =</span> samples,</span>
<span id="cb54-43"><a href="1.5-under-the-hood.html#cb54-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">pdf =</span> <span class="cn">FALSE</span>, <span class="co"># no export to PDF</span></span>
<span id="cb54-44"><a href="1.5-under-the-hood.html#cb54-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">ind =</span> <span class="cn">TRUE</span>, <span class="co"># separate density lines per chain</span></span>
<span id="cb54-45"><a href="1.5-under-the-hood.html#cb54-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">params =</span> <span class="st">&quot;theta&quot;</span>)</span></code></pre></div>
</div>
<p>At first glance, using several steps instead of doing all these at once with <code>nimbleMCMC()</code> seems odds. Why is it useful? Mastering the whole sequence of steps allows you to play around with samplers, by changing the samplers NIMBLE picks by default, or even writing your own samplers.</p>
</div>
<p style="text-align: center;">
<a href="1.4-functions-in-nimble.html"><button class="btn btn-default">Previous</button></a>
<a href="1.6-mcmc-samplers.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>

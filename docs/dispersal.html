<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Sites and states | Bayesian analysis of capture-recapture data with hidden Markov models</title>
<meta name="author" content="Olivier Gimenez">
<meta name="description" content="5.1 Introduction In this fifth chapter, you will learn about the Arnason-Schwarz model that allows estimating transitions between sites and states based on capture-recapture data. You will also...">
<meta name="generator" content="bookdown 0.43 with bs4_book()">
<meta property="og:title" content="Chapter 5 Sites and states | Bayesian analysis of capture-recapture data with hidden Markov models">
<meta property="og:type" content="book">
<meta property="og:url" content="https://oliviergimenez.github.io/banana-book/dispersal.html">
<meta property="og:description" content="5.1 Introduction In this fifth chapter, you will learn about the Arnason-Schwarz model that allows estimating transitions between sites and states based on capture-recapture data. You will also...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Sites and states | Bayesian analysis of capture-recapture data with hidden Markov models">
<meta name="twitter:description" content="5.1 Introduction In this fifth chapter, you will learn about the Arnason-Schwarz model that allows estimating transitions between sites and states based on capture-recapture data. You will also...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Theory and case studies in R and NIMBLE">Bayesian analysis of capture-recapture data with hidden Markov models</a>:
        <small class="text-muted">Theory and case studies in R and NIMBLE</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="crashcourse.html"><span class="header-section-number">1</span> Bayesian statistics &amp; MCMC</a></li>
<li><a class="" href="intronimble.html"><span class="header-section-number">2</span> NIMBLE tutorial</a></li>
<li><a class="" href="hmmcapturerecapture.html"><span class="header-section-number">3</span> Hidden Markov models</a></li>
<li class="book-part">Transitions</li>
<li><a class="" href="introduction-4.html">Introduction</a></li>
<li><a class="" href="survival.html"><span class="header-section-number">4</span> Alive and dead</a></li>
<li><a class="active" href="dispersal.html"><span class="header-section-number">5</span> Sites and states</a></li>
<li class="book-part">Case studies</li>
<li><a class="" href="introduction-7.html">Introduction</a></li>
<li><a class="" href="covariateschapter.html"><span class="header-section-number">6</span> Dealing with covariates</a></li>
<li><a class="" href="lackoffit.html"><span class="header-section-number">7</span> Addressing model lack of fit</a></li>
<li><a class="" href="tradeoffs.html"><span class="header-section-number">8</span> Quantifying life history traits</a></li>
<li><a class="" href="conclusion.html">Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/oliviergimenez/banana-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="dispersal" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Sites and states<a class="anchor" aria-label="anchor" href="#dispersal"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-6" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-6"><i class="fas fa-link"></i></a>
</h2>
<p>In this fifth chapter, you will learn about the Arnason-Schwarz model that allows estimating transitions between sites and states based on capture-recapture data. You will also see how to deal with uncertainty in the assignment of states to individuals.</p>
</div>
<div id="ASmodel" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> The Arnason-Schwarz (AS) model<a class="anchor" aria-label="anchor" href="#ASmodel"><i class="fas fa-link"></i></a>
</h2>
<p>In Chapter <a href="survival.html#survival">4</a>, we got acquainted with the Cormack-Jolly-Seber (CJS) model which accommodates transitions between the states alive and dead while accounting for imperfect detection. It is often the case that besides being alive, more detailed information is collected on the state of animals when they are detected. For example, if the study area is split into several discrete sites, you may record where an animal is detected, the state being now alive in this particular site. The Arnason-Schwarz (AS) model can be viewed as an extension to the CJS model in which we estimate movements between sites on top of survival. The AS model is named after the two statisticians – Neil Arnason and Carl Schwarz – who came up with the idea.</p>
<div id="theory" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Theory<a class="anchor" aria-label="anchor" href="#theory"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s assume for now that we have two sites, say 1 and 2. The way we usually think of analyzing the data is to start from the detections and non-detections and infer the transitions between sites and movements. Schematically, when a animal is detected in site 1 or site 2, it obviously means that it is alive in that site, whereas when it is not detected, it may be dead or alive in either site. Schematically, we have:</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-300-1.png" width="672"></div>
<p>Observations and states are indeed closely related, but we do not have a perfect states to observations correspondence, and the HMM framework will help you make the distinction clear, which in turn will make the modelling easier. Usually, we focus our energy on the observations but what we’d really like is to spend time thinking of the ecological processes that we observed imperfectly. In the HMM framework, when we are to build a model, we think of the states and their dynamic over time, and these states emit the observations we’re given to make. Going back to the our example, when an animal is alive in either site, it may get detected in that site or go undetected. When an animal is dead, then it goes undetected for sure. Schematically, we obtain:</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-301-1.png" width="672"></div>
<p>We have <span class="math inline">\(z = 1\)</span> for alive in site 1, <span class="math inline">\(z = 2\)</span> for alive in site 2 and <span class="math inline">\(z = 3\)</span> for dead. We will code <span class="math inline">\(y = 1\)</span> for non-detected, <span class="math inline">\(y = 2\)</span> for detected in site 1 and <span class="math inline">\(y = 3\)</span> for detected in site 2. The parameters are:<br>
- <span class="math inline">\(\pi^r\)</span> is the probability the a newly encountered individual is in state <span class="math inline">\(r\)</span>;<br>
- <span class="math inline">\(p_t^r\)</span> is the probability of detection at <span class="math inline">\(t\)</span> for a bird in site <span class="math inline">\(r\)</span> at <span class="math inline">\(t\)</span>;<br>
- <span class="math inline">\(\phi_t^r\)</span> is the survival probability for birds in site <span class="math inline">\(r\)</span> at between <span class="math inline">\(t\)</span> and <span class="math inline">\(t+1\)</span>;<br>
- <span class="math inline">\(\psi_t^{rs}\)</span> is the probability of being in site <span class="math inline">\(s\)</span> at time <span class="math inline">\(t+1\)</span> for animals that were in site <span class="math inline">\(r\)</span> at <span class="math inline">\(t\)</span> and have survived to <span class="math inline">\(t+1\)</span>, in short movement conditional on survival.</p>
<p>These parameters can be modelled as functions of covariates as in Section <a href="survival.html#covariates">4.8</a>. But for now we will drop the time index for simplicity.</p>
<p>We follow the presentation of HMM as in Chapter <a href="hmmcapturerecapture.html#hmmcapturerecapture">3</a>. Let’s start with the vector of initial states. At first encounter, an animal may be alive in site 1 with probability <span class="math inline">\(\pi^1\)</span> or in site 2 with the complementary probability <span class="math inline">\(1 - \pi^{1}\)</span>, but it cannot be dead. Therefore, we have:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\delta =
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=1 &amp; z_t=2 &amp; z_t=3 \\[0.3em] \hdashline
\pi^1 &amp; 1 - \pi^{1} &amp; 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}\]</span></p>
<p>We move on to the transition matrix which connects the states at <span class="math inline">\(t-1\)</span> in rows to the states at <span class="math inline">\(t\)</span> in columns. For example, the probability of moving from site 1 at <span class="math inline">\(t-1\)</span> to site <span class="math inline">\(2\)</span> at <span class="math inline">\(t\)</span> is the product of the survival probability in site 1 over that time interval, times the probability of moving from site 1 to 2 for those animals who survived. We have:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Gamma =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_{t}=1 &amp; z_{t}=2 &amp; z_{t}=3 \\[0.3em] \hdashline
\phi^1 (1-\psi^{12}) &amp; \phi^1 \psi^{12} &amp; 1 - \phi^1\\
\phi^2 \psi^{21} &amp; \phi^2 (1-\psi^{21}) &amp; 1 - \phi^2\\
0 &amp; 0 &amp; 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=1 \\ z_{t-1}=2 \\ z_{t-1}=3
    \end{matrix}
\end{matrix}\]</span></p>
<p>Finally, the observation matrix relates the states an animal is in at <span class="math inline">\(t\)</span> in rows to the observations at <span class="math inline">\(t\)</span> in columns. If an animal is dead (<span class="math inline">\(z_t=3\)</span>), it cannot be detected (<span class="math inline">\(\Pr(y_t=1|z_t=3)=\Pr(y_t=2|z_t=3)=0\)</span> and <span class="math inline">\(\Pr(y_t=3|z_t=3)=1\)</span>), whereas when it is alive in either site, it can be detected or not. We have:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Omega =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=1 &amp; y_t=2 &amp; y_t=3 \\[0.3em] \hdashline
1 - p^1 &amp; p^1 &amp; 0\\
1 - p^2 &amp; 0 &amp; p^2\\
1 &amp; 0 &amp; 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t}=1 \\ z_{t}=2 \\ z_{t}=3
    \end{matrix}
\end{matrix}\]</span></p>
<p>The vector of initial state probabilities sums up to one, as well as the rows of the transition and observation matrices.</p>
</div>
</div>
<div id="ASmodelfitting" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Fitting the AS model<a class="anchor" aria-label="anchor" href="#ASmodelfitting"><i class="fas fa-link"></i></a>
</h2>
<div id="geese-data" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Geese data<a class="anchor" aria-label="anchor" href="#geese-data"><i class="fas fa-link"></i></a>
</h3>
<p>To introduce this chapter, we will use data on the Canada goose (<em>Branta canadensis</em>; geese hereafter) kindly provided by Jay Hestbeck (Figure <a href="survival.html#fig:pixdipper">4.2</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:pixgeese"></span>
<img src="images/goose.jpg" alt="Canada goose (Branta canadensis). Credit: Max McCarthy." width="100%"><p class="caption">
Figure 5.1: Canada goose (Branta canadensis). Credit: Max McCarthy.
</p>
</div>
<p>In total, 21277 geese were captured, marked with coded neck bands and recaptured between 1984 and 1989 in their wintering locations. Specifically, geese were monitored in the Atlantic flyway, in large areas along the East coast of the USA, namely 3 sites in the mid–Atlantic (New York, Pennsylvania, New Jersey), Chesapeake (Delaware, Maryland, Virginia), and Carolinas (North and South Carolina). Birds were adults and sub-adults when banded.</p>
<p>You may see the data below:</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"geese.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      year_1984 year_1985 year_1986 year_1987 year_1988
## [1,]         0         2         2         0         0
## [2,]         0         0         0         0         0
## [3,]         0         0         0         1         0
## [4,]         0         0         2         0         0
## [5,]         0         3         0         0         3
## [6,]         0         0         0         2         0
##      year_1989
## [1,]         0
## [2,]         2
## [3,]         0
## [4,]         0
## [5,]         2
## [6,]         0</code></pre>
<p>The six columns are years in which the geese were captured, banded and recapture. A 0 stands for a non-detection, and detections were coded in the 3 wintering sites 1, 2 and 3 for mid–Atlantic, Chesapeake and Carolinas respectively. This is only a subsample of 500 individuals of the whole dataset that I will use for illustration here.</p>
</div>
<div id="nimble-implementation-1" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> NIMBLE implementation<a class="anchor" aria-label="anchor" href="#nimble-implementation-1"><i class="fas fa-link"></i></a>
</h3>
<p>To write the NIMBLE code corresponding to the AS model, we will make our life easier and start with 2 sites only – we drop the Carolinas wintering site for now. We replace all 3’s by 0’s in the dataset:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[</span><span class="va">y</span><span class="op">==</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># remove rows with 0's</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">mask</span><span class="op">!=</span><span class="fl">0</span>,<span class="op">]</span></span></code></pre></div>
<p>Also we consider parameters constant over time.</p>
<!-- Note: You may code non-detections as $y_t = 2$, and the first column in the observation matrix should go last. -->
<!-- Quick answer about the -1 and the important issue of coding states and obs. I did this on purpose, to have folks think about the difference between observations and states (non-detection obs should not be confused with state for dead). This becomes even more crucial when we get to multievent models where several observations may be generated by a single state. I get the intuition argument perfectly, but I’d like them to fight against it at first, then once they’re comfortable with the difference, they may code obs/states as they see fit. Let’s see how it goes. I agree that we should mention that during the multistate lecture, in the spirit of « you’re free to code states and jobs the way you like ». I’ll add something. -->
<p>We start with comments to define the quantities – parameters, states and observations – we will use in the NIMBLE code:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="dispersal.html#cb277-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb277-2"><a href="dispersal.html#cb277-2" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb277-3"><a href="dispersal.html#cb277-3" tabindex="-1"></a>  <span class="co"># Parameters:</span></span>
<span id="cb277-4"><a href="dispersal.html#cb277-4" tabindex="-1"></a>  <span class="co"># phi1: survival probability site 1</span></span>
<span id="cb277-5"><a href="dispersal.html#cb277-5" tabindex="-1"></a>  <span class="co"># phi2: survival probability site 2</span></span>
<span id="cb277-6"><a href="dispersal.html#cb277-6" tabindex="-1"></a>  <span class="co"># psi12: movement probability from site 1 to site 2</span></span>
<span id="cb277-7"><a href="dispersal.html#cb277-7" tabindex="-1"></a>  <span class="co"># psi21: movement probability from site 2 to site 1</span></span>
<span id="cb277-8"><a href="dispersal.html#cb277-8" tabindex="-1"></a>  <span class="co"># p1: detection probability site 1</span></span>
<span id="cb277-9"><a href="dispersal.html#cb277-9" tabindex="-1"></a>  <span class="co"># p2: detection probability site 2</span></span>
<span id="cb277-10"><a href="dispersal.html#cb277-10" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb277-11"><a href="dispersal.html#cb277-11" tabindex="-1"></a>  <span class="co"># States (z):</span></span>
<span id="cb277-12"><a href="dispersal.html#cb277-12" tabindex="-1"></a>  <span class="co"># 1 alive at site 1</span></span>
<span id="cb277-13"><a href="dispersal.html#cb277-13" tabindex="-1"></a>  <span class="co"># 2 alive at site 2</span></span>
<span id="cb277-14"><a href="dispersal.html#cb277-14" tabindex="-1"></a>  <span class="co"># 3 dead</span></span>
<span id="cb277-15"><a href="dispersal.html#cb277-15" tabindex="-1"></a>  <span class="co"># Observations (y):</span></span>
<span id="cb277-16"><a href="dispersal.html#cb277-16" tabindex="-1"></a>  <span class="co"># 1 not seen</span></span>
<span id="cb277-17"><a href="dispersal.html#cb277-17" tabindex="-1"></a>  <span class="co"># 2 seen at site 1</span></span>
<span id="cb277-18"><a href="dispersal.html#cb277-18" tabindex="-1"></a>  <span class="co"># 3 seen at site 2</span></span>
<span id="cb277-19"><a href="dispersal.html#cb277-19" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb277-20"><a href="dispersal.html#cb277-20" tabindex="-1"></a>...</span></code></pre></div>
<p>The we specify priors for the survival, transition and detection probabilities:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="dispersal.html#cb278-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb278-2"><a href="dispersal.html#cb278-2" tabindex="-1"></a>...</span>
<span id="cb278-3"><a href="dispersal.html#cb278-3" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb278-4"><a href="dispersal.html#cb278-4" tabindex="-1"></a>  phi1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-5"><a href="dispersal.html#cb278-5" tabindex="-1"></a>  phi2 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-6"><a href="dispersal.html#cb278-6" tabindex="-1"></a>  psi12 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-7"><a href="dispersal.html#cb278-7" tabindex="-1"></a>  psi21 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-8"><a href="dispersal.html#cb278-8" tabindex="-1"></a>  p1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-9"><a href="dispersal.html#cb278-9" tabindex="-1"></a>  p2 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb278-10"><a href="dispersal.html#cb278-10" tabindex="-1"></a>...</span></code></pre></div>
<p>We now write the vector of initial state probabilities:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="dispersal.html#cb279-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb279-2"><a href="dispersal.html#cb279-2" tabindex="-1"></a>...</span>
<span id="cb279-3"><a href="dispersal.html#cb279-3" tabindex="-1"></a>  <span class="co"># initial state probabilities</span></span>
<span id="cb279-4"><a href="dispersal.html#cb279-4" tabindex="-1"></a>  delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> pi1          <span class="co"># Pr(alive in 1 at t = first)</span></span>
<span id="cb279-5"><a href="dispersal.html#cb279-5" tabindex="-1"></a>  delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pi1      <span class="co"># Pr(alive in 2 at t = first)</span></span>
<span id="cb279-6"><a href="dispersal.html#cb279-6" tabindex="-1"></a>  delta[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>            <span class="co"># Pr(dead at t = first) = 0</span></span>
<span id="cb279-7"><a href="dispersal.html#cb279-7" tabindex="-1"></a>...</span></code></pre></div>
<p>Actually, the initial state is known exactly: It is alive at site of initial capture, and <span class="math inline">\(\pi^1\)</span> is the proportion of individuals first captured in site 1, there is no need to make it explicit in the model and estimate it. Therefore, in the likelihood, instead of <code>z[i,first[i]] ~ dcat(delta[1:3])</code>, you can use <code>z[i,first[i]] &lt;- y[i,first[i]] - 1</code> and just forget about <span class="math inline">\(\pi^1\)</span>, for now. Note that the same trick applies to the CJS model.</p>
<p>We write the transition matrix:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="dispersal.html#cb280-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb280-2"><a href="dispersal.html#cb280-2" tabindex="-1"></a>...</span>
<span id="cb280-3"><a href="dispersal.html#cb280-3" tabindex="-1"></a>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span id="cb280-4"><a href="dispersal.html#cb280-4" tabindex="-1"></a>  <span class="co"># (read as gamma[z(t),z(t+1)] = gamma[fromState,toState])</span></span>
<span id="cb280-5"><a href="dispersal.html#cb280-5" tabindex="-1"></a></span>
<span id="cb280-6"><a href="dispersal.html#cb280-6" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psi12)</span>
<span id="cb280-7"><a href="dispersal.html#cb280-7" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi12</span>
<span id="cb280-8"><a href="dispersal.html#cb280-8" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi1</span>
<span id="cb280-9"><a href="dispersal.html#cb280-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi21</span>
<span id="cb280-10"><a href="dispersal.html#cb280-10" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psi21)</span>
<span id="cb280-11"><a href="dispersal.html#cb280-11" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi2</span>
<span id="cb280-12"><a href="dispersal.html#cb280-12" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb280-13"><a href="dispersal.html#cb280-13" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb280-14"><a href="dispersal.html#cb280-14" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb280-15"><a href="dispersal.html#cb280-15" tabindex="-1"></a>...</span></code></pre></div>
<p>In the same way, the observation matrix is:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="dispersal.html#cb281-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb281-2"><a href="dispersal.html#cb281-2" tabindex="-1"></a>...</span>
<span id="cb281-3"><a href="dispersal.html#cb281-3" tabindex="-1"></a>  <span class="co"># probabilities of y(t) given z(t)</span></span>
<span id="cb281-4"><a href="dispersal.html#cb281-4" tabindex="-1"></a>  <span class="co"># (read as omega[y(t),z(t)] = omega[Observation,State])</span></span>
<span id="cb281-5"><a href="dispersal.html#cb281-5" tabindex="-1"></a></span>
<span id="cb281-6"><a href="dispersal.html#cb281-6" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p1     <span class="co"># Pr(alive 1 t -&gt; non-detected t)</span></span>
<span id="cb281-7"><a href="dispersal.html#cb281-7" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> p1         <span class="co"># Pr(alive 1 t -&gt; detected site 1 t)</span></span>
<span id="cb281-8"><a href="dispersal.html#cb281-8" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive 1 t -&gt; detected site 2 t)</span></span>
<span id="cb281-9"><a href="dispersal.html#cb281-9" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p2     <span class="co"># Pr(alive 2 t -&gt; non-detected t)</span></span>
<span id="cb281-10"><a href="dispersal.html#cb281-10" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive 2 t -&gt; detected site 1 t)</span></span>
<span id="cb281-11"><a href="dispersal.html#cb281-11" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> p2         <span class="co"># Pr(alive 2 t -&gt; detected site 2 t)</span></span>
<span id="cb281-12"><a href="dispersal.html#cb281-12" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb281-13"><a href="dispersal.html#cb281-13" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected site 1 t)</span></span>
<span id="cb281-14"><a href="dispersal.html#cb281-14" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected site 2 t)</span></span>
<span id="cb281-15"><a href="dispersal.html#cb281-15" tabindex="-1"></a>...</span></code></pre></div>
<p>At last, we are ready to specify the likelihood which, and this this the magic of HMM, is the same as the likelihood of the CJS model, only the vector of initial states, the transition and observation matrices were changed:</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multisite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">...</span></span>
<span>  <span class="co"># likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># latent state at first capture</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># z(t) given z(t-1)</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="co"># y(t) given z(t)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">omega</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We need to provide NIMBLE with constants, data, initial values, some parameters to monitor and MCMC details:</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># occasions of first capture</span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># constants</span></span>
<span><span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>first <span class="op">=</span> <span class="va">first</span>, </span>
<span>                     K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                     N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># data</span></span>
<span><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># initial values </span></span>
<span><span class="va">zinits</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="co"># say states are observations, detections in A or B   </span></span>
<span>            <span class="co"># are taken as alive in same sites </span></span>
<span><span class="co"># non-detections become alive in site A or B</span></span>
<span><span class="va">zinits</span><span class="op">[</span><span class="va">zinits</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">zinits</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>phi1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  phi2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  psi12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  psi21 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  p2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  pi1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                  z <span class="op">=</span> <span class="va">zinits</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="co"># parameters to monitor</span></span>
<span><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"phi1"</span>, <span class="st">"phi2"</span>,<span class="st">"psi12"</span>, <span class="st">"psi21"</span>, </span>
<span>                        <span class="st">"p1"</span>, <span class="st">"p2"</span>, <span class="st">"pi1"</span><span class="op">)</span></span>
<span><span class="co"># MCMC details</span></span>
<span><span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">20000</span></span>
<span><span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">2</span></span></code></pre></div>
<p>Now we may run NIMBLE:</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc.multisite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">multisite</span>, </span>
<span>                             constants <span class="op">=</span> <span class="va">my.constants</span>,</span>
<span>                             data <span class="op">=</span> <span class="va">my.data</span>,              </span>
<span>                             inits <span class="op">=</span> <span class="va">initial.values</span>,</span>
<span>                             monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,</span>
<span>                             niter <span class="op">=</span> <span class="va">n.iter</span>,</span>
<span>                             nburnin <span class="op">=</span> <span class="va">n.burnin</span>, </span>
<span>                             nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span></span></code></pre></div>
<p>We may have a look to the results via a caterpillar plot:</p>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCplot.html">MCMCplot</a></span><span class="op">(</span><span class="va">mcmc.multisite</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-314-1.png" width="672"></div>
<p>Remember mid–Atlantic is site 1, and Chesapeake site 2. Detection in mid–Atlantic (around 0.5) is higher than in Cheasapeake (around 0.4) although it comes with more uncertainty (wider credible interval). Survival in both sites are estimated at around 0.6–0.7. Note that by going multisite, we could make these parameters site-specific and differences might reflect habitat quality for example. Now the novelty lies in our capability to estimate movements from site 1 to site 2 and from site 2 to site 1 from a winter to the next. The annual probability of remaining in the same site for two successive winters, used as a measure of site fidelity, was lower in the mid–Atlantic (<span class="math inline">\(1-\psi_{12}\)</span> around 0.8) than in the Chesapeake (<span class="math inline">\(1-\psi_{21}\)</span> around 0.9). The estimated probability of moving to the Chesapeake from the mid–Atlantic was four times as high as the probability of moving in the opposite direction.</p>
<p>We may also have a look to numerical summaries, which confirm our ecological interpretation of the model parameter estimates:</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multisite</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##       mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## p1    0.53 0.09 0.37 0.53  0.71    1  1107</span></span>
<span><span class="co">## p2    0.40 0.04 0.32 0.39  0.48    1  1080</span></span>
<span><span class="co">## phi1  0.60 0.05 0.50 0.60  0.71    1  1675</span></span>
<span><span class="co">## phi2  0.70 0.04 0.63 0.70  0.77    1  1145</span></span>
<span><span class="co">## psi12 0.27 0.06 0.17 0.27  0.39    1  2001</span></span>
<span><span class="co">## psi21 0.07 0.02 0.04 0.07  0.11    1  2192</span></span></code></pre></div>
<p>You could add time-dependence to the demographic parameters, e.g. survival and movements, and assess the effect of winter harshness with some temporal covariates; Individual covariates could also be considered. See Section <a href="survival.html#covariates">4.8</a>.</p>
<p>Before we move to the next section, I will illustrate the use of <code>nimbleEcology</code> to fit the AS to the geese data with 2 sites (see Section <a href="hmmcapturerecapture.html#nimblemarginalization">3.8.3</a>). Using the function <code><a href="https://rdrr.io/pkg/nimbleEcology/man/dHMM.html">dHMM()</a></code> which implements HMM with time-independent observation and transition matrices, we have:</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read in data</span></span>
<span><span class="va">geese</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"geese.csv"</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">geese</span><span class="op">)</span></span>
<span><span class="co"># drop Carolinas</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="va">y</span><span class="op">==</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># act as if there was no detection in site 3 Carolinas</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">mask</span><span class="op">!=</span><span class="fl">0</span>,<span class="op">]</span> <span class="co"># remove rows w/ 0s only</span></span>
<span><span class="co"># get occasions of first encounter</span></span>
<span><span class="va">get.first</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="va">get.first</span><span class="op">)</span></span>
<span><span class="co"># filter out individuals that are first captured at last occasion. </span></span>
<span><span class="co"># These individuals do not contribute to parameter estimation, </span></span>
<span><span class="co"># and also they cause problems with nimbleEcology</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">first</span><span class="op">!=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">mask</span>, <span class="op">]</span>                <span class="co"># keep only these</span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="va">first</span><span class="op">[</span><span class="va">mask</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># NIMBLE code </span></span>
<span><span class="va">multisite.marginalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># -------------------------------------------------</span></span>
<span>  <span class="co"># Parameters:</span></span>
<span>  <span class="co"># phi1: survival probability site 1</span></span>
<span>  <span class="co"># phi2: survival probability site 2</span></span>
<span>  <span class="co"># psi12: movement probability from site 1 to site 2</span></span>
<span>  <span class="co"># psi21: movement probability from site 2 to site 1</span></span>
<span>  <span class="co"># p1: recapture probability site 1</span></span>
<span>  <span class="co"># p2: recapture probability site 2</span></span>
<span>  <span class="co"># pi1: prop of being in site 1 at initial capture</span></span>
<span>  <span class="co"># -------------------------------------------------</span></span>
<span>  <span class="co"># States (z):</span></span>
<span>  <span class="co"># 1 alive at 1</span></span>
<span>  <span class="co"># 2 alive at 2</span></span>
<span>  <span class="co"># 3 dead</span></span>
<span>  <span class="co"># Observations (y):  </span></span>
<span>  <span class="co"># 1 not seen</span></span>
<span>  <span class="co"># 2 seen at site 1 </span></span>
<span>  <span class="co"># 3 seen at site 2</span></span>
<span>  <span class="co"># -------------------------------------------------</span></span>
<span>  </span>
<span>  <span class="co"># priors</span></span>
<span>  <span class="va">phi1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">phi2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">psi12</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">psi21</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">pi1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">psi12</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi1</span> <span class="op">*</span> <span class="va">psi12</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phi1</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi2</span> <span class="op">*</span> <span class="va">psi21</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">psi21</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phi2</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">gamma</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># probabilities of y(t) given z(t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p1</span>     <span class="co"># Pr(alive 1 t -&gt; non-detected t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p1</span>         <span class="co"># Pr(alive 1 t -&gt; detected 1 t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>          <span class="co"># Pr(alive 1 t -&gt; detected 2 t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p2</span>     <span class="co"># Pr(alive 2 t -&gt; non-detected t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>          <span class="co"># Pr(alive 2 t -&gt; detected 1 t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p2</span>         <span class="co"># Pr(alive 2 t -&gt; detected 2 t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>          <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>          <span class="co"># Pr(dead t -&gt; detected 1 t)</span></span>
<span>  <span class="va">omega</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>          <span class="co"># Pr(dead t -&gt; detected 2 t)</span></span>
<span>  </span>
<span>  <span class="co"># likelihood </span></span>
<span>  <span class="co"># initial state probs</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># first state propagation</span></span>
<span>    <span class="va">init</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">gamma</span><span class="op">[</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">]</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">]</span>        </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">K</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimbleEcology/man/dHMM.html">dHMM</a></span><span class="op">(</span>init <span class="op">=</span> <span class="va">init</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,<span class="co"># data first[i]+1</span></span>
<span>                               probObs <span class="op">=</span> <span class="va">omega</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="co"># obs</span></span>
<span>                               probTrans <span class="op">=</span> <span class="va">gamma</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="co"># trans</span></span>
<span>                               len <span class="op">=</span> <span class="va">K</span> <span class="op">-</span> <span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="co"># nb of occasions</span></span>
<span>                               checkRowSums <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># do not check </span></span>
<span>                                                 <span class="co"># whether elements </span></span>
<span>                                                 <span class="co"># in a row sum up </span></span>
<span>                                                 <span class="co"># to 1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co"># constants</span></span>
<span><span class="va">my.constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>first <span class="op">=</span> <span class="va">first</span>, </span>
<span>                     K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                     N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># data</span></span>
<span><span class="va">my.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># initial values </span></span>
<span><span class="va">initial.values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>phi1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  phi2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  psi12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  psi21 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                  p2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="co"># parameters to monitor</span></span>
<span><span class="va">parameters.to.save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"phi1"</span>, <span class="st">"phi2"</span>,<span class="st">"psi12"</span>, <span class="st">"psi21"</span>, <span class="st">"p1"</span>, <span class="st">"p2"</span><span class="op">)</span></span>
<span><span class="co"># MCMC details</span></span>
<span><span class="va">n.iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">n.burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n.chains</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="co"># run NIMBLE</span></span>
<span><span class="va">mcmc.multisite.marginalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html">nimbleMCMC</a></span><span class="op">(</span></span>
<span>  code <span class="op">=</span> <span class="va">multisite.marginalized</span>, </span>
<span>  constants <span class="op">=</span> <span class="va">my.constants</span>,</span>
<span>  data <span class="op">=</span> <span class="va">my.data</span>,              </span>
<span>  inits <span class="op">=</span> <span class="va">initial.values</span>,</span>
<span>  monitors <span class="op">=</span> <span class="va">parameters.to.save</span>,</span>
<span>  niter <span class="op">=</span> <span class="va">n.iter</span>,</span>
<span>  nburnin <span class="op">=</span> <span class="va">n.burnin</span>, </span>
<span>  nchains <span class="op">=</span> <span class="va">n.chains</span><span class="op">)</span></span></code></pre></div>
<p>We obtain:</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multisite.marginalized</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##       mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## p1    0.53 0.09 0.36 0.53  0.71    1   651</span></span>
<span><span class="co">## p2    0.40 0.04 0.32 0.39  0.49    1   618</span></span>
<span><span class="co">## phi1  0.60 0.05 0.51 0.60  0.71    1   935</span></span>
<span><span class="co">## phi2  0.70 0.04 0.63 0.70  0.76    1   804</span></span>
<span><span class="co">## psi12 0.27 0.06 0.17 0.26  0.39    1   973</span></span>
<span><span class="co">## psi21 0.07 0.02 0.04 0.07  0.11    1   965</span></span></code></pre></div>
<p>There are no differences whatsoever in these parameters estimates compared to those we obtained earlier.</p>
</div>
<div id="gofas" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Goodness of fit<a class="anchor" aria-label="anchor" href="#gofas"><i class="fas fa-link"></i></a>
</h3>
<p>Like for the CJS model, we need to ensure that the AS model provides a good fit to the data. With regard to classical tests, the goodness-of-fit testing procedures we covered in Section <a href="survival.html#gof">4.7</a> for the CJS model have been extended to the AS model. These procedure are also available in the package <code>R2ucare</code>. While the transience and trap-dependence tests can be used on each site, it is worth mentionning a test that is specific to the AS model with several sites. The “where before where after” (WBWA) tests for memory, in other words it’s a test for the Markovian property of the HMM in the particular context of capture-recapture. WBWA quantifies whether there is a relationship between where an animal has last been seen and where it will next be seen again. If a relationship exists, positive or negative, this suggests memory in the movements, and the probability for an animal of moving to a site at <span class="math inline">\(t\)</span>, given it is present in a site at <span class="math inline">\(t-1\)</span> should be made dependent of where it was at <span class="math inline">\(t-2\)</span>. This is called a second-order Markov process.</p>
<p>Going back to the geese data, the WBWA test is implemented as follows on the whole dataset:</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To install the R2ucare package:</span></span>
<span><span class="co"># if(!require(devtools)) install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("oliviergimenez/R2ucare")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/oliviergimenez/R2ucare">R2ucare</a></span><span class="op">)</span></span>
<span><span class="va">geese</span> <span class="op">&lt;-</span> <span class="fu">read_csv2</span><span class="op">(</span><span class="st">"allgeese.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">geese</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="va">size</span> <span class="op">&lt;-</span> <span class="va">geese</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span></span>
<span><span class="va">wbwa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2ucare/man/test3Gwbwa.html">test3Gwbwa</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">size</span><span class="op">)</span></span>
<span><span class="va">wbwa</span><span class="op">$</span><span class="va">test3Gwbwa</span></span></code></pre></div>
<pre><code>##  stat    df p_val 
## 472.9  20.0   0.0</code></pre>
<p>There is clearly a strong (not to say significant) positive relationship judging by the value of the statistic. I will demonstrate how to account for this memory issue in an extension of the AS model in a case study in Section <a href="lackoffit.html#memorymodel">7.3</a>.</p>
</div>
</div>
<div id="what-if-more-than-2-sites" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> What if more than 2 sites?<a class="anchor" aria-label="anchor" href="#what-if-more-than-2-sites"><i class="fas fa-link"></i></a>
</h2>
<p>So far we have considered two sites only, for the sake of simplicity. Indeed when going for three sites (or more), a difficulty arises. While the movement probabilities still need to be between 0 and 1, the sum of all probabilities of moving from a site should also sum to one. This is because an individual alive in site 1 for example, has to stay in 1, move to 2 or move to 3, it has no other choice. This is no problem when you have only two sites because the probability of moving from 1 to 2 is always estimated between 0 and 1, and its complementary, the probability of moving from 2 to 1 will be too. When you have three sites, it might happen that the sum of the estimates for <span class="math inline">\(\psi^{12}\)</span> and <span class="math inline">\(\psi^{13}\)</span> is larger than one, even though they’re both between 0 and 1, which would make <span class="math inline">\(\psi^{11} = 1 - \psi^{12} - \psi^{13}\)</span> negative.</p>
<p>There are basically two methods to fulfill both constraints, either to assign a Dirichlet (which is pronounced deer-eesh-lay) prior to the movement probabilities, or to use a multinomial logit link function.</p>
<div id="dirichletprior" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> Dirichlet prior<a class="anchor" aria-label="anchor" href="#dirichletprior"><i class="fas fa-link"></i></a>
</h3>
<p>The Dirichlet distribution extends the Beta distribution multivariate we have seen previously (Figure <a href="crashcourse.html#fig:betadistribution">1.2</a>) for values between 0 and 1 that add up to 1. Going back to our example with 3 sites, we would like to come up with a prior for parameters of moving from 1, which are <span class="math inline">\(\psi^{11}\)</span>, <span class="math inline">\(\psi^{12}\)</span> and <span class="math inline">\(\psi^{13}\)</span>. The Dirichlet distribution of dimension 3 has a vector of parameters <span class="math inline">\((\alpha_1, \alpha_2, \alpha_3)\)</span> that controls its shape. The sum of all <span class="math inline">\(\alpha\)</span>’s can be interpreted as a measure of precision: The higher the sum, the more peaked is the distribution on the mean value, the mean value along each dimension being the ratio of the corresponding over the sum of all <span class="math inline">\(\alpha\)</span>’s. When all <span class="math inline">\(\alpha\)</span>’s are equal, the distribution is symmetric (Figure <a href="dispersal.html#fig:dirichletdistribution">5.2</a>). Its mean is <span class="math inline">\((1/3, 1/3, 1/3)\)</span> in our example with 3 parameters, whatever the value of <span class="math inline">\(\alpha\)</span>. When <span class="math inline">\(\alpha_1 = \alpha_2 = \alpha_3 = 1\)</span>, we obtain a uniform marginal distribution for the <span class="math inline">\(\psi\)</span>’s, while values below 1 (<span class="math inline">\(\alpha_1 = \alpha_2 = \alpha_3 = 0.1\)</span>) result in the distribution concentrating in the corners (skewed U-shaped forms) and values above 1 (<span class="math inline">\(\alpha_1 = \alpha_2 = \alpha_3 = 10\)</span>) result in unimodal marginal distributions.</p>
<!-- The probability density function for dirichlet is $f(x) = \displaystyle{\frac{1}{\text{B}({\mathbf \alpha})} \prod_{i=1}^K{x_i^{\alpha_i-1}}}$ where $\text{B}({\mathbf \alpha}) = \displaystyle{\frac{\prod_{i=1}^K{\Gamma({\alpha_i})}}{\Gamma(\sum_{i=1}^K{\alpha_i})}}$ and ${\mathbf \alpha} = (\alpha_1, \ldots, \alpha_K)$ the concentration parameters and $K$ the dimension of the space where $x$ takes values (Figure \@ref(fig:dirichlet)). -->
<!-- <https://en.wikipedia.org/wiki/Dirichlet_distribution#Occurrence_and_applications> -->
<!-- <https://stats.stackexchange.com/questions/130248/what-is-a-dirichlet-prior> <https://mc-stan.org/docs/functions-reference/dirichlet-distribution.html> <https://www.cs.helsinki.fi/u/ahonkela/dippa/node95.html> <https://rpubs.com/JanpuHou/295096> <https://www.biorxiv.org/content/10.1101/711317v2.full.pdf> <https://www.statisticshowto.com/dirichlet-distribution/> <https://research.wu.ac.at/ws/portalfiles/portal/17761231/Report125.pdf> -->

<div class="figure">
<span style="display:block;" id="fig:dirichletdistribution"></span>
<img src="banana-book_files/figure-html/dirichletdistribution-1.png" alt="The Dirichlet distribution as a prior for \((\psi^{11}, \psi^{12}, \psi^{13})\) with vector of parameters \(\alpha\). Here all components of \(\alpha\) are equal which makes the distribution symmetric, and its mean is \((1/3, 1/3, 1/3)\). When \(\alpha = 1\), the prior for the \(\psi\)’s is uniform (middle panel), unimodal when \(\alpha = 10\) (right panel) and concentrated in the corners (0 and 1) when \(\alpha = 0.1\) (left panel)." width="672"><p class="caption">
Figure 5.2: The Dirichlet distribution as a prior for <span class="math inline">\((\psi^{11}, \psi^{12}, \psi^{13})\)</span> with vector of parameters <span class="math inline">\(\alpha\)</span>. Here all components of <span class="math inline">\(\alpha\)</span> are equal which makes the distribution symmetric, and its mean is <span class="math inline">\((1/3, 1/3, 1/3)\)</span>. When <span class="math inline">\(\alpha = 1\)</span>, the prior for the <span class="math inline">\(\psi\)</span>’s is uniform (middle panel), unimodal when <span class="math inline">\(\alpha = 10\)</span> (right panel) and concentrated in the corners (0 and 1) when <span class="math inline">\(\alpha = 0.1\)</span> (left panel).
</p>
</div>
<p>Going back to our example, in NIMBLE, we consider a Dirichlet prior for each triplet of movement parameters, from site 1 (<span class="math inline">\(\psi^{11}\)</span>, <span class="math inline">\(\psi^{12}\)</span> and <span class="math inline">\(\psi^{13}\)</span>), from site 2 (<span class="math inline">\(\psi^{21}\)</span>, <span class="math inline">\(\psi^{22}\)</span> and <span class="math inline">\(\psi^{23}\)</span>) and from site 3 (<span class="math inline">\(\psi^{31}\)</span>, <span class="math inline">\(\psi^{32}\)</span> and <span class="math inline">\(\psi^{33}\)</span>).</p>
<p>We start by setting the scene with comments:</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">...</span></span>
<span>  <span class="co"># -------------------------------------------------</span></span>
<span>  <span class="co"># Parameters:</span></span>
<span>  <span class="co"># phi1: survival prob site 1</span></span>
<span>  <span class="co"># phi2: survival prob site 2</span></span>
<span>  <span class="co"># phi3: survival prob site 3</span></span>
<span>  <span class="co"># psi11 = psi1[1]: mov prob site 1 -&gt; site 1 (reference)</span></span>
<span>  <span class="co"># psi12 = psi1[2]: mov prob site 1 -&gt; site 2</span></span>
<span>  <span class="co"># psi13 = psi1[3]: mov prob site 1 -&gt; site 3 </span></span>
<span>  <span class="co"># psi21 = psi2[1]: mov prob site 2 -&gt; site 1</span></span>
<span>  <span class="co"># psi22 = psi2[2]: mov prob site 2 -&gt; site 2 (reference)</span></span>
<span>  <span class="co"># psi23 = psi2[3]: mov prob site 2 -&gt; site 3</span></span>
<span>  <span class="co"># psi31 = psi3[1]: mov prob site 3 -&gt; site 1</span></span>
<span>  <span class="co"># psi32 = psi3[2]: mov prob site 3 -&gt; site 2</span></span>
<span>  <span class="co"># psi33 = psi3[3]: mov prob site 3 -&gt; site 3 (reference)</span></span>
<span>  <span class="co"># p1: recapture prob site 1</span></span>
<span>  <span class="co"># p2: recapture prob site 2</span></span>
<span>  <span class="co"># p3: recapture prob site 3</span></span>
<span>  <span class="co"># -------------------------------------------------</span></span>
<span>  <span class="co"># States (z):</span></span>
<span>  <span class="co"># 1 alive at 1</span></span>
<span>  <span class="co"># 2 alive at 2</span></span>
<span>  <span class="co"># 2 alive at 3</span></span>
<span>  <span class="co"># 3 dead</span></span>
<span>  <span class="co"># Observations (y):  </span></span>
<span>  <span class="co"># 1 not seen</span></span>
<span>  <span class="co"># 2 seen at 1 </span></span>
<span>  <span class="co"># 3 seen at 2</span></span>
<span>  <span class="co"># 3 seen at 3</span></span>
<span><span class="va">...</span></span></code></pre></div>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="dispersal.html#cb292-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb292-2"><a href="dispersal.html#cb292-2" tabindex="-1"></a>...</span>
<span id="cb292-3"><a href="dispersal.html#cb292-3" tabindex="-1"></a>  <span class="co"># transitions: Dirichlet priors</span></span>
<span id="cb292-4"><a href="dispersal.html#cb292-4" tabindex="-1"></a>  psi1[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">~</span> <span class="fu">ddirch</span>(alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]) <span class="co"># psi11, psi12, psi13</span></span>
<span id="cb292-5"><a href="dispersal.html#cb292-5" tabindex="-1"></a>  psi2[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">~</span> <span class="fu">ddirch</span>(alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]) <span class="co"># psi21, psi22, psi23</span></span>
<span id="cb292-6"><a href="dispersal.html#cb292-6" tabindex="-1"></a>  psi3[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">~</span> <span class="fu">ddirch</span>(alpha[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]) <span class="co"># psi31, psi32, psi33</span></span>
<span id="cb292-7"><a href="dispersal.html#cb292-7" tabindex="-1"></a>...</span></code></pre></div>
<p>Then we use these parameters (which now respect the constraints) to define the transition matrix:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="dispersal.html#cb293-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb293-2"><a href="dispersal.html#cb293-2" tabindex="-1"></a>...</span>
<span id="cb293-3"><a href="dispersal.html#cb293-3" tabindex="-1"></a>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span id="cb293-4"><a href="dispersal.html#cb293-4" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">1</span>]</span>
<span id="cb293-5"><a href="dispersal.html#cb293-5" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">2</span>]</span>
<span id="cb293-6"><a href="dispersal.html#cb293-6" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">3</span>]</span>
<span id="cb293-7"><a href="dispersal.html#cb293-7" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi1</span>
<span id="cb293-8"><a href="dispersal.html#cb293-8" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">1</span>]</span>
<span id="cb293-9"><a href="dispersal.html#cb293-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">2</span>]</span>
<span id="cb293-10"><a href="dispersal.html#cb293-10" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">3</span>]</span>
<span id="cb293-11"><a href="dispersal.html#cb293-11" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi2</span>
<span id="cb293-12"><a href="dispersal.html#cb293-12" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">1</span>]</span>
<span id="cb293-13"><a href="dispersal.html#cb293-13" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">2</span>]</span>
<span id="cb293-14"><a href="dispersal.html#cb293-14" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">3</span>]</span>
<span id="cb293-15"><a href="dispersal.html#cb293-15" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi3</span>
<span id="cb293-16"><a href="dispersal.html#cb293-16" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb293-17"><a href="dispersal.html#cb293-17" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb293-18"><a href="dispersal.html#cb293-18" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb293-19"><a href="dispersal.html#cb293-19" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb293-20"><a href="dispersal.html#cb293-20" tabindex="-1"></a>...</span></code></pre></div>
<p>When we fit this model to the geese dataset with the detections in the Carolinas wintering site back in, and with <code>alpha &lt;- c(1, 1, 1)</code> passed to the constants, we obtain the following results:</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multisite</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## p1      0.53 0.09 0.36 0.52  0.70 1.01   412</span></span>
<span><span class="co">## p2      0.46 0.05 0.37 0.45  0.57 1.00   399</span></span>
<span><span class="co">## p3      0.24 0.06 0.13 0.23  0.38 1.01   248</span></span>
<span><span class="co">## phi1    0.60 0.05 0.50 0.60  0.70 1.01   564</span></span>
<span><span class="co">## phi2    0.70 0.04 0.63 0.70  0.77 1.00   547</span></span>
<span><span class="co">## phi3    0.78 0.07 0.64 0.78  0.91 1.00   258</span></span>
<span><span class="co">## psi1[1] 0.74 0.06 0.62 0.74  0.84 1.00   798</span></span>
<span><span class="co">## psi1[2] 0.24 0.05 0.14 0.23  0.36 1.00   853</span></span>
<span><span class="co">## psi1[3] 0.02 0.03 0.00 0.02  0.10 1.01   401</span></span>
<span><span class="co">## psi2[1] 0.07 0.02 0.04 0.07  0.12 1.01   687</span></span>
<span><span class="co">## psi2[2] 0.83 0.04 0.73 0.84  0.90 1.00   363</span></span>
<span><span class="co">## psi2[3] 0.09 0.04 0.04 0.09  0.18 1.01   361</span></span>
<span><span class="co">## psi3[1] 0.02 0.02 0.00 0.02  0.06 1.00  1631</span></span>
<span><span class="co">## psi3[2] 0.21 0.05 0.12 0.20  0.32 1.00   721</span></span>
<span><span class="co">## psi3[3] 0.77 0.06 0.65 0.78  0.87 1.00   672</span></span></code></pre></div>
<p>Survival probabilities are similar among sites, although lower in the mid-Atlantic (<code>phi[1]</code>). The detection probability in Carolinas (<code>p3</code>) seems much lower than in the two other wintering sites. The estimated probability of moving to the Chesapeake from the Carolinas (<code>psi3[2]</code>) is 2 times as high as the probability of moving in the opposite direction (<code>psi2[3]</code>).</p>
<p>In theory, you could include covariates as in Section <a href="survival.html#covariates">4.8</a> through the <span class="math inline">\(\alpha\)</span> parameters and the use a log link function (to ensure <span class="math inline">\(\alpha &gt; 0\)</span>), e.g. <span class="math inline">\(\log(\alpha) = \beta_1 + \beta_2 x\)</span>. However, NIMBLE does not allow that. Fortunately, there is another way to specify the Dirichlet distribution through a ratio of gamma distributions that allows to incorporate covariates.</p>
<p>The gamma distribution is continuous. It has two parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\theta\)</span> that control its shape and scale (Figure <a href="dispersal.html#fig:gammadistribution">5.3</a>). Another parameterization considers its shape and rate which is the inverse of the scale.</p>

<div class="figure">
<span style="display:block;" id="fig:gammadistribution"></span>
<img src="banana-book_files/figure-html/gammadistribution-1.png" alt="The distribution gamma(\(\alpha\),\(\theta\)) for different values of \(\alpha\) and \(\theta\). The shape argument \(\alpha\) determines the overall shape while the scale parameter \(\theta\) only affects the scale values (compare the values on X- and Y-axes between the bottom and upper panels). The exponential and chi-square distributions are particular cases of the gamma distribution. If the parameter shape is close to zero, the gamma is very similar to the exponential (bottom and upper left panels). If the parameter shape is large, then the gamma is similar to the chi-squared distribution (bottom and upper right panels)." width="672"><p class="caption">
Figure 5.3: The distribution gamma(<span class="math inline">\(\alpha\)</span>,<span class="math inline">\(\theta\)</span>) for different values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\theta\)</span>. The shape argument <span class="math inline">\(\alpha\)</span> determines the overall shape while the scale parameter <span class="math inline">\(\theta\)</span> only affects the scale values (compare the values on X- and Y-axes between the bottom and upper panels). The exponential and chi-square distributions are particular cases of the gamma distribution. If the parameter shape is close to zero, the gamma is very similar to the exponential (bottom and upper left panels). If the parameter shape is large, then the gamma is similar to the chi-squared distribution (bottom and upper right panels).
</p>
</div>
<p>If we have three independent random variables <span class="math inline">\(Y_1, Y_2\)</span> and <span class="math inline">\(Y_3\)</span> distributed as gamma distributions with shape parameters the <span class="math inline">\(\alpha\)</span>’s and same scale parameter <span class="math inline">\(\theta\)</span>, that is <span class="math inline">\(Y_j \sim \text{Gamma}(\alpha_j, \theta)\)</span>, then it can be shown that the vector <span class="math inline">\((Y_1/V, Y_2/V, Y_3/V)\)</span> is Dirichlet with vector of parameters the <span class="math inline">\(\alpha\)</span>’s, where <span class="math inline">\(V\)</span> is the sum of the <span class="math inline">\(Y\)</span>’s (which is also gamma distributed). In NIMBLE, this suggests using <span class="math inline">\(\theta = 1\)</span> to get a uniform prior:</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">...</span></span>
<span><span class="co"># transitions: Dirichlet priors with Gamma formulation</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Y1, Y2, Y3 for psi11, psi12, psi13</span></span>
<span>  <span class="va">lpsi1</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="va">psi1</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lpsi1</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">/</span><span class="va">V1</span> <span class="co"># psi11, psi12, psi13</span></span>
<span>  <span class="co"># Y'1, Y'2, Y'3 for psi21, psi22, psi23</span></span>
<span>  <span class="va">lpsi2</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="va">psi2</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lpsi2</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">/</span><span class="va">V2</span> <span class="co"># psi21, psi22, psi23</span></span>
<span>  <span class="co"># Y''1, Y''2, Y''3 for psi31, psi32, psi33</span></span>
<span>  <span class="va">lpsi3</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="va">psi3</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lpsi3</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">/</span><span class="va">V3</span> <span class="co"># psi31, psi32, psi33</span></span>
<span><span class="op">}</span></span>
<span><span class="va">V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lpsi1</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lpsi2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lpsi3</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">...</span></span></code></pre></div>
<p>From there, we can express the shape parameter of the gamma distribution (precisely the <span class="math inline">\(\alpha\)</span>’s here) as a function of covariates as in <span class="math inline">\(\log(\alpha) = \beta_1 + \beta_2 x\)</span> in the spirit of a generalized linear model with a gamma response.</p>
<!-- <https://en.wikipedia.org/wiki/Dirichlet_distribution#Related_distributions>, <https://en.wikipedia.org/wiki/Dirichlet_distribution#Random_variate_generation>, <https://groups.google.com/g/nimble-users/c/4XrJbRLUOyY/m/iDLeAIovAQAJ> -->
</div>
<div id="multinomiallogit" class="section level3" number="5.4.2">
<h3>
<span class="header-section-number">5.4.2</span> Multinomial logit<a class="anchor" aria-label="anchor" href="#multinomiallogit"><i class="fas fa-link"></i></a>
</h3>
<!-- <https://socialwork.wayne.edu/research/pdf/multi-nomial-logistic-regression.pdf>, <https://www3.nd.edu/~rwilliam/stats3/Mlogit1.pdf>, <https://stats.oarc.ucla.edu/stata/dae/multinomiallogistic-regression/> and <https://en.wikipedia.org/wiki/Multinomial_logistic_regression>. -->
<p>Another possibility to build a prior that ensures the movement probabilities are between 0 and 1 and sum up to 1 is to extend the logit link we used for the CJS model in Section <a href="survival.html#covariates">4.8</a>. Remember we had <span class="math inline">\(\text{logit}(\phi) = \beta\)</span>, we specified a prior on <span class="math inline">\(\beta\)</span> say <span class="math inline">\(\beta \sim N(0,1.5)\)</span> then got a prior on <span class="math inline">\(\phi\)</span> by back-transforming <span class="math inline">\(\beta\)</span> with <span class="math inline">\(\phi = \text{logit}^{-1}(\beta)\)</span>.</p>
<p>Going back to our example with <span class="math inline">\(3\)</span> sites, and focusing on the movement probabilities say, from site 1, we first choose a reference (or pivot) site, say 1, then <span class="math inline">\(\log\left(\displaystyle{\frac{\psi^{12}}{\psi^{11}}}\right) = \beta_2\)</span> and <span class="math inline">\(\log\left(\displaystyle{\frac{\psi^{13}}{\psi^{11}}}\right) = \beta_3\)</span>. Interestingly, when exponentiated, the <span class="math inline">\(\beta\)</span>’s here can be interpreted as the increase in the odds of moving versus staying on site resulting from a one-unit increase in the covariate. Any of the sites can be chosen to be the reference, this will not change the likelihood and you will get the same results. Now we specify a normal prior distribution for the <span class="math inline">\(\beta\)</span>’s. Eventually, to back-transform, we use <span class="math inline">\(\psi^{12} = \displaystyle{\frac{\exp(\beta_2)}{1+\displaystyle{\exp(\beta_2)+\displaystyle{\exp(\beta_3)}}}}\)</span> and <span class="math inline">\(\psi^{13} = \displaystyle{\frac{\exp(\beta_3)}{1+\displaystyle{\exp(\beta_2)+\displaystyle{\exp(\beta_3)}}}}\)</span>. The reference parameter, here <span class="math inline">\(\psi^{11}\)</span>, is calculated as <span class="math inline">\(\psi^{11} = \displaystyle{\frac{1}{1 + \displaystyle{\exp(\beta_2)+\displaystyle{\exp(\beta_3)}}}}\)</span>, or simply as the complementary probability <span class="math inline">\(\psi^{11} = 1 - \psi^{12} - \psi^{13}\)</span>.</p>
<p>Note that when there are only 2 sites instead of 3 or more, then the multinomial logit reduces to the logit link.</p>
<p>In NIMBLE, we write:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="dispersal.html#cb296-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb296-2"><a href="dispersal.html#cb296-2" tabindex="-1"></a>...</span>
<span id="cb296-3"><a href="dispersal.html#cb296-3" tabindex="-1"></a>  <span class="co"># transitions: multinomial logit</span></span>
<span id="cb296-4"><a href="dispersal.html#cb296-4" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb296-5"><a href="dispersal.html#cb296-5" tabindex="-1"></a>    <span class="co"># normal priors on logit of all but one movement prob</span></span>
<span id="cb296-6"><a href="dispersal.html#cb296-6" tabindex="-1"></a>    beta1[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb296-7"><a href="dispersal.html#cb296-7" tabindex="-1"></a>    beta2[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb296-8"><a href="dispersal.html#cb296-8" tabindex="-1"></a>    beta3[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb296-9"><a href="dispersal.html#cb296-9" tabindex="-1"></a>    <span class="co"># constrain the transitions such that their sum is &lt; 1</span></span>
<span id="cb296-10"><a href="dispersal.html#cb296-10" tabindex="-1"></a>    psi1[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta1[i]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(beta1[<span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">exp</span>(beta1[<span class="dv">2</span>]))</span>
<span id="cb296-11"><a href="dispersal.html#cb296-11" tabindex="-1"></a>    psi2[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta2[i]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(beta2[<span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">exp</span>(beta2[<span class="dv">2</span>]))</span>
<span id="cb296-12"><a href="dispersal.html#cb296-12" tabindex="-1"></a>    psi3[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta3[i]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(beta3[<span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">exp</span>(beta3[<span class="dv">2</span>]))</span>
<span id="cb296-13"><a href="dispersal.html#cb296-13" tabindex="-1"></a>  }</span>
<span id="cb296-14"><a href="dispersal.html#cb296-14" tabindex="-1"></a>  <span class="co"># reference movement probability</span></span>
<span id="cb296-15"><a href="dispersal.html#cb296-15" tabindex="-1"></a>  psi1[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> psi1[<span class="dv">1</span>] <span class="sc">-</span> psi1[<span class="dv">2</span>]</span>
<span id="cb296-16"><a href="dispersal.html#cb296-16" tabindex="-1"></a>  psi2[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> psi2[<span class="dv">1</span>] <span class="sc">-</span> psi2[<span class="dv">2</span>]</span>
<span id="cb296-17"><a href="dispersal.html#cb296-17" tabindex="-1"></a>  psi3[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> psi3[<span class="dv">1</span>] <span class="sc">-</span> psi3[<span class="dv">2</span>]</span>
<span id="cb296-18"><a href="dispersal.html#cb296-18" tabindex="-1"></a>...</span></code></pre></div>
<p>Then we use these parameters (which now respect the constraints) to define the transition matrix:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="dispersal.html#cb297-1" tabindex="-1"></a>multisite <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb297-2"><a href="dispersal.html#cb297-2" tabindex="-1"></a>...</span>
<span id="cb297-3"><a href="dispersal.html#cb297-3" tabindex="-1"></a>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span id="cb297-4"><a href="dispersal.html#cb297-4" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">1</span>]</span>
<span id="cb297-5"><a href="dispersal.html#cb297-5" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">2</span>]</span>
<span id="cb297-6"><a href="dispersal.html#cb297-6" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi1 <span class="sc">*</span> psi1[<span class="dv">3</span>]</span>
<span id="cb297-7"><a href="dispersal.html#cb297-7" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi1</span>
<span id="cb297-8"><a href="dispersal.html#cb297-8" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">1</span>]</span>
<span id="cb297-9"><a href="dispersal.html#cb297-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">2</span>]</span>
<span id="cb297-10"><a href="dispersal.html#cb297-10" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi2 <span class="sc">*</span> psi2[<span class="dv">3</span>]</span>
<span id="cb297-11"><a href="dispersal.html#cb297-11" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi2</span>
<span id="cb297-12"><a href="dispersal.html#cb297-12" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">1</span>]</span>
<span id="cb297-13"><a href="dispersal.html#cb297-13" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">2</span>]</span>
<span id="cb297-14"><a href="dispersal.html#cb297-14" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> phi3 <span class="sc">*</span> psi3[<span class="dv">3</span>]</span>
<span id="cb297-15"><a href="dispersal.html#cb297-15" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi3</span>
<span id="cb297-16"><a href="dispersal.html#cb297-16" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb297-17"><a href="dispersal.html#cb297-17" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb297-18"><a href="dispersal.html#cb297-18" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb297-19"><a href="dispersal.html#cb297-19" tabindex="-1"></a>  gamma[<span class="dv">4</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb297-20"><a href="dispersal.html#cb297-20" tabindex="-1"></a>...</span></code></pre></div>
<p>You may check that the results are very similar to those we obtained with the Dirichlet prior:</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multisite</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## p1      0.52 0.09 0.36 0.52  0.69 1.02   702</span></span>
<span><span class="co">## p2      0.46 0.05 0.37 0.46  0.57 1.00   538</span></span>
<span><span class="co">## p3      0.23 0.06 0.13 0.23  0.36 1.00   404</span></span>
<span><span class="co">## phi1    0.61 0.05 0.51 0.61  0.71 1.00   893</span></span>
<span><span class="co">## phi2    0.70 0.04 0.63 0.70  0.77 1.00   879</span></span>
<span><span class="co">## phi3    0.77 0.07 0.64 0.77  0.91 1.01   462</span></span>
<span><span class="co">## psi1[1] 0.73 0.06 0.62 0.74  0.83 1.02  1435</span></span>
<span><span class="co">## psi1[2] 0.22 0.05 0.13 0.22  0.33 1.00  1687</span></span>
<span><span class="co">## psi1[3] 0.05 0.03 0.01 0.04  0.12 1.03   313</span></span>
<span><span class="co">## psi2[1] 0.07 0.02 0.04 0.07  0.12 1.00  1318</span></span>
<span><span class="co">## psi2[2] 0.83 0.04 0.73 0.84  0.90 1.01   466</span></span>
<span><span class="co">## psi2[3] 0.10 0.04 0.04 0.09  0.18 1.00   325</span></span>
<span><span class="co">## psi3[1] 0.03 0.02 0.01 0.02  0.07 1.01  2526</span></span>
<span><span class="co">## psi3[2] 0.21 0.05 0.12 0.21  0.33 1.00  1197</span></span>
<span><span class="co">## psi3[3] 0.76 0.06 0.64 0.76  0.86 1.00   994</span></span></code></pre></div>
<p>Both the Dirichlet prior and the multinomial logit link give similar results, and there is not much difference in terms of runtime or quality of convergence, so you should use the option you feel the most comfortable with.</p>
</div>
</div>
<div id="states" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Sites may be states<a class="anchor" aria-label="anchor" href="#states"><i class="fas fa-link"></i></a>
</h2>
<p>So far, we have considered geographical locations (or sites) to refine the alive information when an animal is detected. However, it was quickly realized that sites could actually be states defined by physiology or behavior, hence opening up an avenue for applications of capture-recapture models in many fields of ecology.</p>
<p>Examples of states include:</p>
<ul>
<li>Epidemiological or disease states: sick/healthy, uninfected/infected/recovered;<br>
</li>
<li>Morphological states: small/medium/big, light/medium/heavy;<br>
</li>
<li>Life-history states: e.g. breeder/non-breeder, failed breeder, first-time breeder;<br>
</li>
<li>Developmental states: e.g. juvenile/subadult/adult;<br>
</li>
<li>Social states: e.g. solitary/group-living, subordinate/dominant;<br>
</li>
<li>Death states: e.g. alive, dead from harvest, dead from natural causes.</li>
</ul>
<p>In brief, states are individual, time-specific discrete covariates.</p>
<div id="titis-data" class="section level3" number="5.5.1">
<h3>
<span class="header-section-number">5.5.1</span> Titis data<a class="anchor" aria-label="anchor" href="#titis-data"><i class="fas fa-link"></i></a>
</h3>
<p>To illustrate this section, we will consider data collected between 1942 and 1956 by Lance Richdale on the Sooty shearwaters (<em>Ardenna grisea</em>), also known as titis (Figure <a href="dispersal.html#fig:pixtiti">5.4</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:pixtiti"></span>
<img src="images/titi.jpg" alt="Sooty shearwater (*Ardenna grisea*). Credit: John Harrison." width="100%"><p class="caption">
Figure 5.4: Sooty shearwater (<em>Ardenna grisea</em>). Credit: John Harrison.
</p>
</div>
<p>You may see the data below:</p>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">titis</span> <span class="op">&lt;-</span> <span class="fu">read_csv2</span><span class="op">(</span><span class="st">"titis.csv"</span>, </span>
<span>                   col_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">titis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>year_1942 <span class="op">=</span> <span class="va">X1</span>,</span>
<span>         year_1943 <span class="op">=</span> <span class="va">X2</span>,</span>
<span>         year_1944 <span class="op">=</span> <span class="va">X3</span>,</span>
<span>         year_1949 <span class="op">=</span> <span class="va">X4</span>,</span>
<span>         year_1952 <span class="op">=</span> <span class="va">X5</span>,</span>
<span>         year_1953 <span class="op">=</span> <span class="va">X6</span>,</span>
<span>         year_1956 <span class="op">=</span> <span class="va">X7</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1,013 × 7
##    year_1942 year_1943 year_1944 year_1949 year_1952
##        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1         0         0         0         0         0
##  2         0         0         0         0         0
##  3         0         0         0         0         0
##  4         0         0         0         0         0
##  5         0         0         0         0         0
##  6         0         0         0         0         0
##  7         0         0         0         0         0
##  8         0         0         0         0         0
##  9         0         0         0         0         0
## 10         0         0         0         0         0
## # ℹ 1,003 more rows
## # ℹ 2 more variables: year_1953 &lt;dbl&gt;, year_1956 &lt;dbl&gt;</code></pre>
<p>In total, 1013 titis were captured, marked and recaptured on a small colony on Whero Island in southern New Zealand. These data were previously analyzed by Richard Scofield who kindly provided us with the data.</p>
<p>Following the way the data were collected, four states were originally considered: Alive breeder; Accompanied by another bird in a burrow; Alone in a burrow; On the surface; Dead. For simplicity, we pooled all alive states (except breeder) together in a non-breeder state (NB) that includes failed breeders (birds that had bred previously – skip reproduction or divorce) and pre-breeders (birds that had yet to breed). Because burrows were not checked before hatching, some birds in the category NB might have already failed. Therefore birds in the breeder state (B) should be seen as successful breeders, and those in the NB state as nonbreeders plus prebreeders and failed breeders.</p>
<p>In summary, we code the states as 1 for alive and breeding, 2 for alive and non-breeding and 3 for dead. To make the modelling process more self-explanatory, we will use letters B, NB and D but you should keep in mind that these are actually numbers. Observations are non-detected coded as 1, and detected as breeder or non-breeder coded as 2 and 3 respectively.</p>
<p>The aim here is to study life-history trade–offs. Specifically, we ask the questions: Does breeding affect survival? Does breeding in current year affect breeding next year?</p>
</div>
<div id="the-as-model-for-states" class="section level3" number="5.5.2">
<h3>
<span class="header-section-number">5.5.2</span> The AS model for states<a class="anchor" aria-label="anchor" href="#the-as-model-for-states"><i class="fas fa-link"></i></a>
</h3>
<p>Basically, the AS model with states is the same model as in the geese example with two sites, see Sections <a href="dispersal.html#ASmodel">5.2</a> and <a href="dispersal.html#ASmodelfitting">5.3</a>.</p>
<p>If we let <span class="math inline">\(\phi^B\)</span> and <span class="math inline">\(\phi^{NB}\)</span> be the survival probabilities of breeders and non-breeders, <span class="math inline">\(\psi^{NBB}\)</span> the probability of becoming breeder for a non-breeder, and <span class="math inline">\(\psi^{BNB}\)</span> the probability of skipping reproduction, then the transition matrix is:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Gamma =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=B &amp; z_t=NB &amp; z_t=D \\[0.3em] \hdashline
\phi^B (1-\psi^{BNB}) &amp; \phi^B \psi^{BNB} &amp; 1 - \phi^B\\
\phi^{NB} \psi^{NBB} &amp; \phi^{NB} (1-\psi^{NBB}) &amp; 1 - \phi^{NB}\\
0 &amp; 0 &amp; 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=B \\ z_{t-1}=NB \\ z_{t-1}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>The costs or reproduction would reflect in future reproduction if breeders have a lower probability of breed next year than non-breeders <span class="math inline">\(\psi^{BB} = 1 - \psi^{BNB} &lt; \psi^{NBB}\)</span> or in survival if the survival of breeders is lower than that of non-breeders <span class="math inline">\(\phi^B &lt; \phi^{NB}\)</span>.</p>
<p>The observation matrix is:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Omega =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=1 &amp; y_t=2 &amp; y_t=3 \\[0.3em] \hdashline
1 - p^B &amp; p^B &amp; 0\\
1 - p^{NB} &amp; 0 &amp; p^{NB}\\
1 &amp; 0 &amp; 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t}=B \\ z_{t}=NB \\ z_{t}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(p^B\)</span> and <span class="math inline">\(p^{NB}\)</span> are the detection proabilities of non-breeders and breeders respectively.</p>
</div>
<div id="nimble-implementation-2" class="section level3" number="5.5.3">
<h3>
<span class="header-section-number">5.5.3</span> NIMBLE implementation<a class="anchor" aria-label="anchor" href="#nimble-implementation-2"><i class="fas fa-link"></i></a>
</h3>
<p>We first write the NIMBLE code, which is exactly the same as in the geese example with two sites, see Section <a href="dispersal.html#ASmodelfitting">5.3</a>.</p>
<p>First some definitions which we have as comments in the code:</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="dispersal.html#cb301-1" tabindex="-1"></a>multistate <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb301-2"><a href="dispersal.html#cb301-2" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb301-3"><a href="dispersal.html#cb301-3" tabindex="-1"></a>  <span class="co"># Parameters:</span></span>
<span id="cb301-4"><a href="dispersal.html#cb301-4" tabindex="-1"></a>  <span class="co"># B is for breeder, NB for non-breeder</span></span>
<span id="cb301-5"><a href="dispersal.html#cb301-5" tabindex="-1"></a>  <span class="co"># phiB: survival probability state B</span></span>
<span id="cb301-6"><a href="dispersal.html#cb301-6" tabindex="-1"></a>  <span class="co"># phiNB: survival probability state NB</span></span>
<span id="cb301-7"><a href="dispersal.html#cb301-7" tabindex="-1"></a>  <span class="co"># psiBNB: transition probability from B to NB</span></span>
<span id="cb301-8"><a href="dispersal.html#cb301-8" tabindex="-1"></a>  <span class="co"># psiNBB: transition probability from NB to B</span></span>
<span id="cb301-9"><a href="dispersal.html#cb301-9" tabindex="-1"></a>  <span class="co"># pB: detection probability B</span></span>
<span id="cb301-10"><a href="dispersal.html#cb301-10" tabindex="-1"></a>  <span class="co"># pNB: detection probability NB</span></span>
<span id="cb301-11"><a href="dispersal.html#cb301-11" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb301-12"><a href="dispersal.html#cb301-12" tabindex="-1"></a>  <span class="co"># States (z):</span></span>
<span id="cb301-13"><a href="dispersal.html#cb301-13" tabindex="-1"></a>  <span class="co"># 1 alive B</span></span>
<span id="cb301-14"><a href="dispersal.html#cb301-14" tabindex="-1"></a>  <span class="co"># 2 alive NB</span></span>
<span id="cb301-15"><a href="dispersal.html#cb301-15" tabindex="-1"></a>  <span class="co"># 3 dead</span></span>
<span id="cb301-16"><a href="dispersal.html#cb301-16" tabindex="-1"></a>  <span class="co"># Observations (y):</span></span>
<span id="cb301-17"><a href="dispersal.html#cb301-17" tabindex="-1"></a>  <span class="co"># 1 not seen</span></span>
<span id="cb301-18"><a href="dispersal.html#cb301-18" tabindex="-1"></a>  <span class="co"># 2 seen as B</span></span>
<span id="cb301-19"><a href="dispersal.html#cb301-19" tabindex="-1"></a>  <span class="co"># 3 seen as NB</span></span>
<span id="cb301-20"><a href="dispersal.html#cb301-20" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb301-21"><a href="dispersal.html#cb301-21" tabindex="-1"></a>...</span></code></pre></div>
<p>Then the priors:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="dispersal.html#cb302-1" tabindex="-1"></a>multistate <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb302-2"><a href="dispersal.html#cb302-2" tabindex="-1"></a>...</span>
<span id="cb302-3"><a href="dispersal.html#cb302-3" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb302-4"><a href="dispersal.html#cb302-4" tabindex="-1"></a>  phiB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-5"><a href="dispersal.html#cb302-5" tabindex="-1"></a>  phiNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-6"><a href="dispersal.html#cb302-6" tabindex="-1"></a>  psiBNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-7"><a href="dispersal.html#cb302-7" tabindex="-1"></a>  psiNBB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-8"><a href="dispersal.html#cb302-8" tabindex="-1"></a>  pB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-9"><a href="dispersal.html#cb302-9" tabindex="-1"></a>  pNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb302-10"><a href="dispersal.html#cb302-10" tabindex="-1"></a>...</span></code></pre></div>
<p>The transition matrix:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="dispersal.html#cb303-1" tabindex="-1"></a>multistate <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb303-2"><a href="dispersal.html#cb303-2" tabindex="-1"></a>...</span>
<span id="cb303-3"><a href="dispersal.html#cb303-3" tabindex="-1"></a>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span id="cb303-4"><a href="dispersal.html#cb303-4" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phiB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psiBNB)</span>
<span id="cb303-5"><a href="dispersal.html#cb303-5" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phiB <span class="sc">*</span> psiBNB</span>
<span id="cb303-6"><a href="dispersal.html#cb303-6" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phiB</span>
<span id="cb303-7"><a href="dispersal.html#cb303-7" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phiNB <span class="sc">*</span> psiNBB</span>
<span id="cb303-8"><a href="dispersal.html#cb303-8" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phiNB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psiNBB)</span>
<span id="cb303-9"><a href="dispersal.html#cb303-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phiNB</span>
<span id="cb303-10"><a href="dispersal.html#cb303-10" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb303-11"><a href="dispersal.html#cb303-11" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb303-12"><a href="dispersal.html#cb303-12" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb303-13"><a href="dispersal.html#cb303-13" tabindex="-1"></a>...</span></code></pre></div>
<p>The observation matrix:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="dispersal.html#cb304-1" tabindex="-1"></a>multistate <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb304-2"><a href="dispersal.html#cb304-2" tabindex="-1"></a>...</span>
<span id="cb304-3"><a href="dispersal.html#cb304-3" tabindex="-1"></a>  <span class="co"># probabilities of y(t) given z(t)</span></span>
<span id="cb304-4"><a href="dispersal.html#cb304-4" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pB    <span class="co"># Pr(alive B t -&gt; non-detected t)</span></span>
<span id="cb304-5"><a href="dispersal.html#cb304-5" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> pB        <span class="co"># Pr(alive B t -&gt; detected B t)</span></span>
<span id="cb304-6"><a href="dispersal.html#cb304-6" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># Pr(alive B t -&gt; detected NB t)</span></span>
<span id="cb304-7"><a href="dispersal.html#cb304-7" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pNB   <span class="co"># Pr(alive NB t -&gt; non-detected t)</span></span>
<span id="cb304-8"><a href="dispersal.html#cb304-8" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># Pr(alive NB t -&gt; detected B t)</span></span>
<span id="cb304-9"><a href="dispersal.html#cb304-9" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> pNB       <span class="co"># Pr(alive NB t -&gt; detected NB t)</span></span>
<span id="cb304-10"><a href="dispersal.html#cb304-10" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>         <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb304-11"><a href="dispersal.html#cb304-11" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># Pr(dead t -&gt; detected N t)</span></span>
<span id="cb304-12"><a href="dispersal.html#cb304-12" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># Pr(dead t -&gt; detected NB t)</span></span>
<span id="cb304-13"><a href="dispersal.html#cb304-13" tabindex="-1"></a>...</span></code></pre></div>
<p>And the likelihood:</p>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multistate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">...</span></span>
<span>  <span class="co"># likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># latent state at first capture</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># z(t) given z(t-1)</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="co"># y(t) given z(t)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">omega</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We run NIMBLE and get the following results:</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multistate</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##        mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## pB     0.60 0.03 0.54 0.60  0.65 1.00   756</span></span>
<span><span class="co">## pNB    0.56 0.03 0.51 0.56  0.62 1.01   725</span></span>
<span><span class="co">## phiB   0.80 0.02 0.77 0.80  0.83 1.00  1485</span></span>
<span><span class="co">## phiNB  0.85 0.02 0.81 0.85  0.88 1.01  1231</span></span>
<span><span class="co">## psiBNB 0.25 0.02 0.21 0.25  0.30 1.01  1227</span></span>
<span><span class="co">## psiNBB 0.24 0.02 0.20 0.24  0.28 1.00  1123</span></span></code></pre></div>
<p>Non-breeder individuals seem to have a survival higher than breeder individuals, suggesting a trade-off between reproduction and survival. Let’s compare graphically the survival of breeder and non-breeder individuals. First we gather the values generated for <span class="math inline">\(\phi^B\)</span> and <span class="math inline">\(\phi^{NB}\)</span> for the two chains:</p>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phiB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">"phiB"</span><span class="op">]</span>, </span>
<span>          <span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">"phiB"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">phiNB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">"phiNB"</span><span class="op">]</span>, </span>
<span>           <span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">"phiNB"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"phiB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">phiB</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"phiNB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">phiB</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">phiB</span>, <span class="va">phiNB</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we plot the two posterior distributions:</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">param</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, position <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#69b3a2"</span>, <span class="st">"#404080"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">""</span>, x <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-342-1.png" width="672"></div>
<p>There is little overlap between the two distributions, suggesting an actual trade–off. A formal test of the trade-off would consist in fitting the model with survival irrespective of the state, and compare its WAIC value to the model we just fitted.</p>
<p>What about a potential trade-off on reproduction?</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psiBNB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">"psiBNB"</span><span class="op">]</span>, </span>
<span>            <span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">"psiBNB"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">psiBB</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">psiBNB</span></span>
<span><span class="va">psiNBB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain1</span><span class="op">[</span>,<span class="st">"psiNBB"</span><span class="op">]</span>, </span>
<span>            <span class="va">mcmc.multistate</span><span class="op">$</span><span class="va">chain2</span><span class="op">[</span>,<span class="st">"psiNBB"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"psiBB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">phiB</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"psiNBB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">phiB</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">psiBB</span>, <span class="va">psiNBB</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">param</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, position <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#69b3a2"</span>, <span class="st">"#404080"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">""</span>, x <span class="op">=</span> <span class="st">"breeding probabilities"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-343-1.png" width="672"></div>
<p>There is no overlap whatsoever, so the two transition probabilities are clearly different. Interestingly, breeder individuals do much better than non-breeder individuals. This failure at detecting a trade-off is probably due to individual heterogeneity that should be accounted for. You could add an individual random effect as in Section <a href="survival.html#randomeffects">4.8.4</a> or consider 2 classes of individuals as we will do in a case study at Section <a href="lackoffit.html#indhet">7.4</a>.</p>
<!-- See M. Paquet suggestion: Pouvoir utiliser le modèle à la fois pour simuler des données, puis ensuite pour les ajuster au modèle (le tout sans avoir à réécrire le modèle!). Exemple: nodesToSim <- model$getDependencies(c("parameter_name1","parameter_name2"), self = F, downstream = T), # compile Cmodel <- compileNimble(model), #simulate Cmodel$simulate(nodesToSim) -->
</div>
</div>
<div id="localminima" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Issue of local minima<a class="anchor" aria-label="anchor" href="#localminima"><i class="fas fa-link"></i></a>
</h2>
<p>In the frequentist approach, we use the maximum likelihood theory to estimate parameters. The maximum likelihood estimates are the values that get you to the maximum of the model likelihood. To find out the maximum of the likelihood, we use iterative optimization algorithms (e.g. the default method is that of Nelder and Mead in the R <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> function). However, sometimes, our model likelihood contains several maxima and there is no guarantee that the algorithms will find the global maximum corresponding to the maximum likelihood estimates, and it may get stuck in a local maximum. Let’s illustrate this issue with some simulated data that were kindly provided by Jérôme Dupuis. We consider 2 sites (or alive states), say 1 and 2, and 7 sampling occasions. The survival probability is constant <span class="math inline">\(\phi = 1\)</span> as well as the detection probability <span class="math inline">\(p = 0.6\)</span>. The probability of moving from 1 to 2 is <span class="math inline">\(\psi^{12} = 0.6\)</span> and <span class="math inline">\(\psi^{21} = 0.85\)</span> in the opposite direction. Here are the encounter histories of the 27 individuals that were simulated by Jérôme:</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>              byrow <span class="op">=</span> <span class="cn">T</span>,</span>
<span>              ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<p>In Figure <a href="dispersal.html#fig:inits">5.5</a>, we provide an illustration of the influence of the choice of initial values when trying to maximize the likelihood, or rather to minimize the deviance (which is minus two times the log of the likelihood). The black curve is the what we called the profile deviance for <span class="math inline">\(\psi^{21}\)</span>. Profiling the deviance consists in taking a slice of it in the direction of a parameter of interest and treating the other parameters as nuisance parameters. In our example, we set <span class="math inline">\(\psi^{21}\)</span> to a value (on the x-axis) an minimize the deviance (on the y-axis) with respect to the other parameters. There are two minima, but only the global minimum (corresponding to the lowest value of deviance) corresponding to <span class="math inline">\(\psi^{21}\)</span> around 0.8 is of interest to us. The thing is that if you start your optimization algorithm by picking value in the red area, then it will get stuck in the local minimum and will tell you the maximum likelihood estimate of <span class="math inline">\(\psi^{21}\)</span> is around 0.35, which is obviously far from the value we used to simulate the data. In contrast, if you pick initial values in the green area, then the algorithm will converge to the global minimum.</p>
<div class="figure">
<span style="display:block;" id="fig:inits"></span>
<img src="images/multistate_local_minimav2_Page_07.png" alt="Influence of the choice of initial values on the convergence to the global minimum of the deviance illustrated with simulated data. The black curve is the profile deviance of the probability to move from site 2 to 1. If an initial value is picked in the red area, we end up in the local minimum while if it is picked in the green area, then we get the global minimum which corresponds to the maximum lilkelihood estimate." width="100%"><p class="caption">
Figure 5.5: Influence of the choice of initial values on the convergence to the global minimum of the deviance illustrated with simulated data. The black curve is the profile deviance of the probability to move from site 2 to 1. If an initial value is picked in the red area, we end up in the local minimum while if it is picked in the green area, then we get the global minimum which corresponds to the maximum lilkelihood estimate.
</p>
</div>
<p>You might argue that this is a problem of the optimization algorithm and therefore inherent to the frequentist approach. Well, it turns out that MCMC algorithms are not immune to the issue. If you fit the AS model with constant parameters to the simulated data, here is the trace for the probability of moving from 2 to 1:</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-345-1.png" width="672"></div>
<p>Clearly, there are two regimes. The chain spends most of its time around high values of <span class="math inline">\(\psi^{21}\)</span> close to the true value represented by the blue dashed line. But sometimes, the chain jumps to values around 0.3-0.4. This behavior translates into two modes in the posterior distribution for <span class="math inline">\(\psi^{21}\)</span> where the mode on the right is closer to the truth represented by the dashed blue vertical line:</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-346-1.png" width="672"></div>
<p>The issue of local minima is a difficult problem. How to get out of this problematic situation? In the frequentist approach, the trick is to fit your model several times with different initial values each time, hoping that you’ll get to fall in the green area somehow as in Figure <a href="dispersal.html#fig:inits">5.5</a>. In the Bayesian approach, the key to handle distributions with multiple modes is to sample the posteriors efficiently. Assuming the chains we run in NIMBLE spend more time in the region of the parameter space corresponding to the global minimum, then I recommend using the median or the mode to summarize the posterior distribution. In the simulated example, we get a median of 0.79 for <span class="math inline">\(\psi^{21}\)</span>, not too bad given that the data were simulated with a value of 0.85 for that parameter:</p>
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multisite</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##       mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## p     0.58 0.04 0.51 0.58  0.65 1.00  3194</span></span>
<span><span class="co">## phi   0.99 0.01 0.98 1.00  1.00 1.02  1173</span></span>
<span><span class="co">## psi12 0.51 0.15 0.19 0.56  0.72 1.10    76</span></span>
<span><span class="co">## psi21 0.70 0.20 0.27 0.78  0.93 1.12    56</span></span></code></pre></div>
<p>As a general advice, I recommend to always inspect the trace plots to find out whether you have posterior distributions with multiple modes which would suggest local minima.</p>
</div>
<div id="multievent" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Uncertainty<a class="anchor" aria-label="anchor" href="#multievent"><i class="fas fa-link"></i></a>
</h2>
<p>In the AS model, we assume that we can without a doubt assign a site or a state to an animal whenever it is detected. But this is not always the case. For example, when the breeding status in mammals or birds is ascertained based on the presence of offspring or eggs, we are uncertain of whether a female is breeding or not when the offspring or eggs are not seen. Another example is when the epidemiological status in mammals or birds is ascertained based on some tests run on some animals when captured, we are uncertain whether these animals are healthy or sick when detected from distance without possibility to manipulate them for testing. In this section we will cover the extension of the AS model to uncertain states – known as multievent models after <span class="citation">Pradel (<a href="references.html#ref-pradel_multievent_2005">2005</a>)</span> – through two examples, one on breeding states and the other on disease states. We will cover other examples in the part on Case studies.</p>
<div id="breedingmultievent" class="section level3" number="5.7.1">
<h3>
<span class="header-section-number">5.7.1</span> Breeding states<a class="anchor" aria-label="anchor" href="#breedingmultievent"><i class="fas fa-link"></i></a>
</h3>
<p>We will revisit the titis example <a href="dispersal.html#states">5.5</a> and try to assess life-history trade-offs while accounting for uncertainty in breeding status. We still have 3 states, which are alive and breeding, alive and non-breeding and dead. With regard to observations, a bird may be not encountered. It may also be encountered, but in contrast with our previous analysis of the titis data, we don’t know its state for sure. It may be found and ascertained (or classified) as breeder. It may be found and ascertained as non-breeder. It may be found but we are unable to determine whether it’s breeding or non-breeding.</p>
<!-- Ingredients -->
<!-- + 3 states -->
<!--     + breeding (B) -->
<!--     + non-breeding (NB) -->
<!--     + dead (D) -->
<!-- + 4 observations -->
<!--     + not encountered (0) -->
<!--     + found, ascertained as breeder (1) -->
<!--     + found, ascertained as non-breeder (2) -->
<!--     + found, status unknown (3) -->
<p>How do the states generate the observations?</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-349-1.png" width="672"></div>
<p>Each alive state can generate 3 observations. The only deterministic link is that between the dead state and the observation non-encountered, because if a bird is dead, it cannot be detected for sure.</p>
<p>Let’s specify the model. First thing we need, and it’s a big difference with the AS model, we need initial state probabilities because we cannot assign states to individuals with certainty. We write down the probability for each state at first encounter, or the vector of initial state probabilities:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\delta =
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=B &amp; z_t=NB &amp; z_t=D \\[0.3em] \hdashline
\pi^B &amp; 1 - \pi^{B} &amp; 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\pi^B\)</span> is the probability that a newly encountered individual is a breeder, and <span class="math inline">\(\pi^{NB} = 1 - \pi^B\)</span> is the probability that a newly encountered individual is a non-breeder (the complementary probability of <span class="math inline">\(\pi^B\)</span>). The probability of being dead at first encounter is 0 (a bird is alive when it is first encountered).</p>
<p>Now the transition matrix, this is the easy part as it doesn’t change. We have:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Gamma =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=B &amp; z_t=NB &amp; z_t=D \\[0.3em] \hdashline
\phi^B (1-\psi^{BNB}) &amp; \phi^B \psi^{BNB} &amp; 1 - \phi^B\\
\phi^{NB} \psi^{NBB} &amp; \phi^{NB} (1-\psi^{NBB}) &amp; 1 - \phi^{NB}\\
0 &amp; 0 &amp; 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=B \\ z_{t-1}=NB \\ z_{t-1}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\phi^B\)</span> is the breeder survival, <span class="math inline">\(\phi_ {NB}\)</span> that of non-breeders, <span class="math inline">\(\psi^{BNB}\)</span> is the probability for an individual breeding a year to be a non-breeder the next year, and <span class="math inline">\(\psi^{NBB}\)</span> is the probability for an non-breeder individual to breeder the next year.</p>
<p>Last, the observation matrix. The main difference between multisite/multistate and multievent models is here, in the observation parameters. Besides <span class="math inline">\(p^B\)</span> the detection probability of breeders and <span class="math inline">\(p^{NB}\)</span> that of non-breeders, we introduce two new parameters: <span class="math inline">\(\beta^B\)</span> is the probability to correctly assign an individual that is in state B to state B, and <span class="math inline">\(\beta^{NB}\)</span> is the probability to correctly assign an individual that is in state NB to state NB. The complementary of these <span class="math inline">\(\beta\)</span> parameters are often called false positive probabilities. We put everything in a matrix, as usual. In rows we have the states: breeding, non-breeding and dead. In columns, at the same occasion, we have the observations: non-detected, detected and ascertained B, detected and ascertained NB, and detected but state unknown:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Omega =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=1 &amp; y_t=2 &amp; y_t=3 &amp; y_t=4 \\[0.3em] \hdashline
1 - p^B &amp; p^B \beta^B &amp; 0 &amp; p^B (1-\beta_ B) \\
1-p^{NB} &amp; 0 &amp; p^{NB} \beta^{NB} &amp; p^{NB} (1-\beta^{NB})\\
1 &amp; 0 &amp; 0 &amp; 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=B \\ z_{t}=NB \\ z_{t}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>For example, the probability of being detected and assigned to state B, given that you’re in state B is the product of <span class="math inline">\(p^B\)</span> the detection probability in B and <span class="math inline">\(\beta^B\)</span> the probability of correctly assigning a breeding individual to state B.</p>
<p>At first encounter, all individuals are captured, but you still need to assign them a state. This means that we should set <span class="math inline">\(p^B = p^{NB} = 1\)</span> and use:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_{t = \text{first}}=1 &amp; y_{t = \text{first}}=2 &amp; y_{t = \text{first}}=3 &amp; y_{t = \text{first}}=4 \\[0.3em] \hdashline
0 &amp; \beta^B &amp; 0 &amp; (1-\beta^B)\\
0 &amp; 0 &amp; \beta^{NB} &amp; (1-\beta^{NB})\\
1 &amp; 0 &amp; 0 &amp; 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t = \text{first}}=B \\ z_{t = \text{first}}=NB \\ z_{t = \text{first}}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>To implement this model in NIMBLE, we start by using comments to define the parameters, states and observations in the header of the code:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="dispersal.html#cb312-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb312-2"><a href="dispersal.html#cb312-2" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb312-3"><a href="dispersal.html#cb312-3" tabindex="-1"></a>  <span class="co"># Parameters:</span></span>
<span id="cb312-4"><a href="dispersal.html#cb312-4" tabindex="-1"></a>  <span class="co"># phiB: survival probability state B</span></span>
<span id="cb312-5"><a href="dispersal.html#cb312-5" tabindex="-1"></a>  <span class="co"># phiNB: survival probability state NB</span></span>
<span id="cb312-6"><a href="dispersal.html#cb312-6" tabindex="-1"></a>  <span class="co"># psiBNB: transition probability from B to NB</span></span>
<span id="cb312-7"><a href="dispersal.html#cb312-7" tabindex="-1"></a>  <span class="co"># psiNBB: transition probability from NB to B</span></span>
<span id="cb312-8"><a href="dispersal.html#cb312-8" tabindex="-1"></a>  <span class="co"># pB: recapture probability B</span></span>
<span id="cb312-9"><a href="dispersal.html#cb312-9" tabindex="-1"></a>  <span class="co"># pNB: recapture probability NB</span></span>
<span id="cb312-10"><a href="dispersal.html#cb312-10" tabindex="-1"></a>  <span class="co"># piB prob. of being in initial state breeder</span></span>
<span id="cb312-11"><a href="dispersal.html#cb312-11" tabindex="-1"></a>  <span class="co"># betaNB prob ascertain breeding status of ind encountered as NB</span></span>
<span id="cb312-12"><a href="dispersal.html#cb312-12" tabindex="-1"></a>  <span class="co"># betaB prob ascertain breeding status of ind encountered as B</span></span>
<span id="cb312-13"><a href="dispersal.html#cb312-13" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb312-14"><a href="dispersal.html#cb312-14" tabindex="-1"></a>  <span class="co"># States (z):</span></span>
<span id="cb312-15"><a href="dispersal.html#cb312-15" tabindex="-1"></a>  <span class="co"># 1 alive B</span></span>
<span id="cb312-16"><a href="dispersal.html#cb312-16" tabindex="-1"></a>  <span class="co"># 2 alive NB</span></span>
<span id="cb312-17"><a href="dispersal.html#cb312-17" tabindex="-1"></a>  <span class="co"># 3 dead</span></span>
<span id="cb312-18"><a href="dispersal.html#cb312-18" tabindex="-1"></a>  <span class="co"># Observations (y):</span></span>
<span id="cb312-19"><a href="dispersal.html#cb312-19" tabindex="-1"></a>  <span class="co"># 1 = non-detected</span></span>
<span id="cb312-20"><a href="dispersal.html#cb312-20" tabindex="-1"></a>  <span class="co"># 2 = seen and ascertained as breeder</span></span>
<span id="cb312-21"><a href="dispersal.html#cb312-21" tabindex="-1"></a>  <span class="co"># 3 = seen and ascertained as non-breeder</span></span>
<span id="cb312-22"><a href="dispersal.html#cb312-22" tabindex="-1"></a>  <span class="co"># 4 = not ascertained</span></span>
<span id="cb312-23"><a href="dispersal.html#cb312-23" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb312-24"><a href="dispersal.html#cb312-24" tabindex="-1"></a>...</span></code></pre></div>
<p>Then we assign prior to all parameters to be estimated. Because we deal with probabilities, the uniform distribution between 0 and 1 will do the job:</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="dispersal.html#cb313-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb313-2"><a href="dispersal.html#cb313-2" tabindex="-1"></a>...</span>
<span id="cb313-3"><a href="dispersal.html#cb313-3" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb313-4"><a href="dispersal.html#cb313-4" tabindex="-1"></a>  phiB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-5"><a href="dispersal.html#cb313-5" tabindex="-1"></a>  phiNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-6"><a href="dispersal.html#cb313-6" tabindex="-1"></a>  psiBNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-7"><a href="dispersal.html#cb313-7" tabindex="-1"></a>  psiNBB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-8"><a href="dispersal.html#cb313-8" tabindex="-1"></a>  pB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-9"><a href="dispersal.html#cb313-9" tabindex="-1"></a>  pNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-10"><a href="dispersal.html#cb313-10" tabindex="-1"></a>  piB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-11"><a href="dispersal.html#cb313-11" tabindex="-1"></a>  betaNB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-12"><a href="dispersal.html#cb313-12" tabindex="-1"></a>  betaB <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb313-13"><a href="dispersal.html#cb313-13" tabindex="-1"></a>...</span></code></pre></div>
<p>Now we write the vector of initial state probabilities:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="dispersal.html#cb314-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb314-2"><a href="dispersal.html#cb314-2" tabindex="-1"></a>...</span>
<span id="cb314-3"><a href="dispersal.html#cb314-3" tabindex="-1"></a>  <span class="co"># vector of initial stats probs</span></span>
<span id="cb314-4"><a href="dispersal.html#cb314-4" tabindex="-1"></a>  delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> piB <span class="co"># prob. of being in initial state B</span></span>
<span id="cb314-5"><a href="dispersal.html#cb314-5" tabindex="-1"></a>  delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> piB <span class="co"># prob. of being in initial state NB</span></span>
<span id="cb314-6"><a href="dispersal.html#cb314-6" tabindex="-1"></a>  delta[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># prob. of being in initial state dead</span></span>
<span id="cb314-7"><a href="dispersal.html#cb314-7" tabindex="-1"></a>...</span></code></pre></div>
<p>The transition matrix:</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="dispersal.html#cb315-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb315-2"><a href="dispersal.html#cb315-2" tabindex="-1"></a>...</span>
<span id="cb315-3"><a href="dispersal.html#cb315-3" tabindex="-1"></a>  <span class="co"># probabilities of state z(t+1) given z(t)</span></span>
<span id="cb315-4"><a href="dispersal.html#cb315-4" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phiB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psiBNB)</span>
<span id="cb315-5"><a href="dispersal.html#cb315-5" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phiB <span class="sc">*</span> psiBNB</span>
<span id="cb315-6"><a href="dispersal.html#cb315-6" tabindex="-1"></a>  gamma[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phiB</span>
<span id="cb315-7"><a href="dispersal.html#cb315-7" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phiNB <span class="sc">*</span> psiNBB</span>
<span id="cb315-8"><a href="dispersal.html#cb315-8" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> phiNB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> psiNBB)</span>
<span id="cb315-9"><a href="dispersal.html#cb315-9" tabindex="-1"></a>  gamma[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phiNB</span>
<span id="cb315-10"><a href="dispersal.html#cb315-10" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb315-11"><a href="dispersal.html#cb315-11" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb315-12"><a href="dispersal.html#cb315-12" tabindex="-1"></a>  gamma[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb315-13"><a href="dispersal.html#cb315-13" tabindex="-1"></a>...</span></code></pre></div>
<p>And the observation matrix:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="dispersal.html#cb316-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb316-2"><a href="dispersal.html#cb316-2" tabindex="-1"></a>...</span>
<span id="cb316-3"><a href="dispersal.html#cb316-3" tabindex="-1"></a>  <span class="co"># probabilities of y(t) given z(t)</span></span>
<span id="cb316-4"><a href="dispersal.html#cb316-4" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pB             <span class="co"># Pr(alive B t -&gt; non-detected t)</span></span>
<span id="cb316-5"><a href="dispersal.html#cb316-5" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> pB <span class="sc">*</span> betaB         <span class="co"># Pr(alive B t -&gt; detected B t)</span></span>
<span id="cb316-6"><a href="dispersal.html#cb316-6" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                  <span class="co"># Pr(alive B t -&gt; detected NB t)</span></span>
<span id="cb316-7"><a href="dispersal.html#cb316-7" tabindex="-1"></a>  omega[<span class="dv">1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> pB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> betaB)   <span class="co"># Pr(alive B t -&gt; detected U t)</span></span>
<span id="cb316-8"><a href="dispersal.html#cb316-8" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pNB            <span class="co"># Pr(alive NB t -&gt; non-detected t)</span></span>
<span id="cb316-9"><a href="dispersal.html#cb316-9" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                  <span class="co"># Pr(alive NB t -&gt; detected B t)</span></span>
<span id="cb316-10"><a href="dispersal.html#cb316-10" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> pNB <span class="sc">*</span> betaNB       <span class="co"># Pr(alive NB t -&gt; detected NB t)</span></span>
<span id="cb316-11"><a href="dispersal.html#cb316-11" tabindex="-1"></a>  omega[<span class="dv">2</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> pNB <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> betaNB) <span class="co"># Pr(alive NB t -&gt; detected U t)</span></span>
<span id="cb316-12"><a href="dispersal.html#cb316-12" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                  <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb316-13"><a href="dispersal.html#cb316-13" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                  <span class="co"># Pr(dead t -&gt; detected N t)</span></span>
<span id="cb316-14"><a href="dispersal.html#cb316-14" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                  <span class="co"># Pr(dead t -&gt; detected NB t)</span></span>
<span id="cb316-15"><a href="dispersal.html#cb316-15" tabindex="-1"></a>  omega[<span class="dv">3</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                  <span class="co"># Pr(dead t -&gt; detected U t)</span></span>
<span id="cb316-16"><a href="dispersal.html#cb316-16" tabindex="-1"></a>...</span></code></pre></div>
<p>The observation matrix at first encounter:</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="dispersal.html#cb317-1" tabindex="-1"></a>multievent <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb317-2"><a href="dispersal.html#cb317-2" tabindex="-1"></a>...</span>
<span id="cb317-3"><a href="dispersal.html#cb317-3" tabindex="-1"></a>  <span class="co"># probabilities of y(first) given z(first)</span></span>
<span id="cb317-4"><a href="dispersal.html#cb317-4" tabindex="-1"></a>  <span class="co"># Pr(alive B t = first -&gt; non-detected t = first)</span></span>
<span id="cb317-5"><a href="dispersal.html#cb317-5" tabindex="-1"></a>  omega.init[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-6"><a href="dispersal.html#cb317-6" tabindex="-1"></a>  <span class="co"># Pr(alive B t = first -&gt; detected B t = first)</span></span>
<span id="cb317-7"><a href="dispersal.html#cb317-7" tabindex="-1"></a>  omega.init[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> betaB      </span>
<span id="cb317-8"><a href="dispersal.html#cb317-8" tabindex="-1"></a>  <span class="co"># Pr(alive B t = first -&gt; detected NB t = first)</span></span>
<span id="cb317-9"><a href="dispersal.html#cb317-9" tabindex="-1"></a>  omega.init[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-10"><a href="dispersal.html#cb317-10" tabindex="-1"></a>  <span class="co"># Pr(alive B t = first -&gt; detected U t = first)</span></span>
<span id="cb317-11"><a href="dispersal.html#cb317-11" tabindex="-1"></a>  omega.init[<span class="dv">1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> betaB  </span>
<span id="cb317-12"><a href="dispersal.html#cb317-12" tabindex="-1"></a>  <span class="co"># Pr(alive NB t = first -&gt; non-detected t = first)</span></span>
<span id="cb317-13"><a href="dispersal.html#cb317-13" tabindex="-1"></a>  omega.init[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-14"><a href="dispersal.html#cb317-14" tabindex="-1"></a>  <span class="co"># Pr(alive NB t = first -&gt; detected B t = first)</span></span>
<span id="cb317-15"><a href="dispersal.html#cb317-15" tabindex="-1"></a>  omega.init[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-16"><a href="dispersal.html#cb317-16" tabindex="-1"></a>  <span class="co"># Pr(alive NB t = first -&gt; detected NB t = first)</span></span>
<span id="cb317-17"><a href="dispersal.html#cb317-17" tabindex="-1"></a>  omega.init[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> betaNB     </span>
<span id="cb317-18"><a href="dispersal.html#cb317-18" tabindex="-1"></a>  <span class="co"># Pr(alive NB t = first -&gt; detected U t = first)</span></span>
<span id="cb317-19"><a href="dispersal.html#cb317-19" tabindex="-1"></a>  omega.init[<span class="dv">2</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> betaNB </span>
<span id="cb317-20"><a href="dispersal.html#cb317-20" tabindex="-1"></a>  <span class="co"># Pr(dead t = first -&gt; non-detected t = first)</span></span>
<span id="cb317-21"><a href="dispersal.html#cb317-21" tabindex="-1"></a>  omega.init[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          </span>
<span id="cb317-22"><a href="dispersal.html#cb317-22" tabindex="-1"></a>  <span class="co"># Pr(dead t = first -&gt; detected N t = first)</span></span>
<span id="cb317-23"><a href="dispersal.html#cb317-23" tabindex="-1"></a>  omega.init[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-24"><a href="dispersal.html#cb317-24" tabindex="-1"></a>  <span class="co"># Pr(dead t = first -&gt; detected NB t = first)</span></span>
<span id="cb317-25"><a href="dispersal.html#cb317-25" tabindex="-1"></a>  omega.init[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-26"><a href="dispersal.html#cb317-26" tabindex="-1"></a>  <span class="co"># Pr(dead t = first -&gt; detected U t = first)</span></span>
<span id="cb317-27"><a href="dispersal.html#cb317-27" tabindex="-1"></a>  omega.init[<span class="dv">3</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          </span>
<span id="cb317-28"><a href="dispersal.html#cb317-28" tabindex="-1"></a>...</span></code></pre></div>
<p>Eventually, we get to the likelihood:</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multievent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">...</span></span>
<span>  <span class="co"># likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># latent state at first capture</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">delta</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># obs at first encounter</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">omega.init</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># z(t) given z(t-1)</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="co"># y(t) given z(t)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/Categorical.html">dcat</a></span><span class="op">(</span><span class="va">omega</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The only change is in the line <code>y[i,first[i]] ~ dcat(omega.init[z[i,first[i]],1:4])</code> where we use the observation matrix at first encounter.</p>
<p>We run NIMBLE and get the following numerical summaries for the model parameters:</p>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCsummary</a></span><span class="op">(</span><span class="va">mcmc.multievent</span>, round <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##        mean   sd 2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">## betaB  0.19 0.01 0.16 0.19  0.22 1.00   583</span></span>
<span><span class="co">## betaNB 0.74 0.06 0.64 0.73  0.88 1.00   198</span></span>
<span><span class="co">## pB     0.56 0.03 0.51 0.56  0.62 1.01   801</span></span>
<span><span class="co">## pNB    0.60 0.04 0.53 0.60  0.67 1.02   757</span></span>
<span><span class="co">## phiB   0.81 0.02 0.78 0.81  0.85 1.00  1551</span></span>
<span><span class="co">## phiNB  0.84 0.02 0.80 0.84  0.87 1.00  1610</span></span>
<span><span class="co">## piB    0.70 0.03 0.64 0.70  0.76 1.00   296</span></span>
<span><span class="co">## psiBNB 0.22 0.03 0.17 0.22  0.28 1.01   925</span></span>
<span><span class="co">## psiNBB 0.23 0.05 0.15 0.23  0.35 1.00   250</span></span></code></pre></div>
<p>Breeders are difficult to assign to the correct state <span class="math inline">\(\beta^B\)</span>, while non-breeders are relatively well classified as non-breeders <span class="math inline">\(\beta^{NB}\)</span>.</p>
<p>There is again no cost of current reproduction on future reproduction. We no longer detect a cost of breeding on survival.</p>
<!-- Uncertainty was simulated, so no ecological interpretation to be found. Say it was simulated though. -->
</div>
<div id="diseasemultievent" class="section level3" number="5.7.2">
<h3>
<span class="header-section-number">5.7.2</span> Disease states<a class="anchor" aria-label="anchor" href="#diseasemultievent"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s have a look to another example. We consider a system of an emerging pathogen <em>Mycoplasma gallisepticum</em> Edward and Kanarek and its host the house finch, <em>Carpodacus mexicanus</em> Müller. The pathogen causes moderate to severe eye swelling (Figure <a href="dispersal.html#fig:pixfinch">5.6</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:pixfinch"></span>
<img src="images/infectedhousefinch.jpg" alt="A house finch with a heavy infection caused by conjunctivitis. Credit: Jim Mondok." width="100%"><p class="caption">
Figure 5.6: A house finch with a heavy infection caused by conjunctivitis. Credit: Jim Mondok.
</p>
</div>
<p>Here we’re asking whether the presence of clinical signs of the pathogen influences survival. The objective of the study was also to quantify infection (moving from state healthy to state ill) and recovery (moving from state ill to state healthy) probabilities. The birds were captured via mist nets and marked with individually identifiable color bands over three years. The data were kindly provided by Paul Conn and Evan Cooch. The difficulty was that ascertaining the disease status of birds seen from distance was difficult since determining the presence of the pathogen was only possible when the bird’s eyes were clearly visible. In this context, how to study the dynamics of the disease?</p>
<p>First, we think of states and observations. We have:</p>
<ul>
<li>3 states
<ul>
<li>healthy (H)</li>
<li>ill (I)</li>
<li>dead (D)</li>
</ul>
</li>
<li>4 observations
<ul>
<li>not seen (1)</li>
<li>captured healthy (2)</li>
<li>captured ill (3)</li>
<li>health status unknown, i.e. seen at distance (4)</li>
</ul>
</li>
</ul>
<p>How do the states generate observations?</p>
<div class="inline-figure"><img src="banana-book_files/figure-html/unnamed-chunk-359-1.png" width="672"></div>
<p>Clearly, this is the same model as in the previous section on titis, Section <a href="dispersal.html#breedingmultievent">5.7.1</a>, in which loosely speaking we replace breeder by healthy and non-breeder by ill.</p>
<p>The vector of initial state probabilities is:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\delta =
    \left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=H &amp; z_t=I &amp; z_t=D \\[0.3em] \hdashline
\pi^H &amp; 1 - \pi^{H} &amp; 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
    \begin{matrix}
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\pi^H\)</span> is the probability that a newly encountered individual is healthy, and <span class="math inline">\(\pi^{I} = 1 - \pi^H\)</span> is the probability that a newly encountered individual is ill.</p>
<p>The transition matrix is:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Gamma =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=H &amp; z_t=I &amp; z_t=D \\[0.3em] \hdashline
\phi^H (1-\psi^{HI}) &amp; \phi^H \psi^{HI} &amp; 1 - \phi^H\\
\phi^{I} \psi^{IH} &amp; \phi^{I} (1-\psi^{IH}) &amp; 1 - \phi^{I}\\
0 &amp; 0 &amp; 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=H \\ z_{t-1}=I \\ z_{t-1}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\phi^H\)</span> is the survival probability of healthy individuals, <span class="math inline">\(\phi^I\)</span> the survival probability of ill individuals, <span class="math inline">\(\psi^{HI}\)</span> the probability of getting ill (infection rate) and <span class="math inline">\(\psi^{IH}\)</span> the probability of recovering from the disease (recovery rate).</p>
<p>Image you’d like to model the dynamic of an incurable disease, the transition matrix would be modified by having <span class="math inline">\(\psi^{IH} = 0\)</span>, and once a bird gets ill, it remains ill <span class="math inline">\(\psi^{II} = 1 - \psi^{IH} = 1\)</span>. Therefore we would have:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Gamma =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    z_t=H &amp; z_t=I &amp; z_t=D \\[0.3em] \hdashline
\phi^H (1-\psi^{HI}) &amp; \phi^H \psi^{HI} &amp; 1 - \phi^H\\
0 &amp; \phi^{I}  &amp; 1 - \phi^{I}\\
0 &amp; 0 &amp; 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
    \begin{matrix}
    z_{t-1}=H \\ z_{t-1}=I \\ z_{t-1}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>For analysing the house finch data, we allow recovering from the disease. The observation matrix is:</p>
<p><span class="math display">\[\begin{matrix}
&amp; \\
\Omega =
    \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
    y_t=0 &amp; y_t=1 &amp; y_t=2 &amp; y_t=3 \\[0.3em] \hdashline
1-p^H &amp; p^H \beta^H &amp; 0 &amp; p^H (1-\beta^H)\\
1-p^I &amp; 0 &amp; p^{I} \beta^{I} &amp; p^{I} (1-\beta^{I})\\
1 &amp; 0 &amp; 0 &amp; 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
&amp; \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right )
    \begin{matrix}
    z_{t}=H \\ z_{t}=I \\ z_{t}=D
    \end{matrix}
\end{matrix}\]</span></p>
<p>where <span class="math inline">\(\beta^H\)</span> is the probability to assign a healthy individual to state H, and <span class="math inline">\(\beta^{I}\)</span> is the probability to assign a sick individual to state I. <span class="math inline">\(p^H\)</span> is the detection probability of healthy individuals, <span class="math inline">\(p^I\)</span> that of sick individuals.</p>
<p>Using the code we developped for the titis example, we get the following results on the finches by running NIMBLE:</p>
<pre><code>##       mean   sd 2.5%  50% 97.5% Rhat n.eff
## betaH 0.99 0.01 0.97 0.99  1.00 1.01  2118
## betaI 0.05 0.01 0.02 0.05  0.08 1.01  1810
## pH    0.71 0.21 0.15 0.75  0.98 1.04   142
## pI    0.28 0.10 0.21 0.25  0.63 1.00   317
## phiH  0.70 0.07 0.62 0.69  0.89 1.08   192
## phiI  0.99 0.01 0.96 0.99  1.00 1.00   832
## pi    0.96 0.01 0.93 0.96  0.98 1.00  6332
## psiHI 0.75 0.17 0.19 0.80  0.88 1.02   160
## psiIH 0.20 0.09 0.12 0.17  0.50 1.05   146</code></pre>
<p>Healthy individuals are correctly assigned (<span class="math inline">\(\beta^H\)</span> is almost 1), while infected individuals are difficult to ascertain (<span class="math inline">\(\beta^I\)</span> is around 0.05). Unexpectedly, ill birds have a better survival than healthy individuals (compare <span class="math inline">\(\phi^I\)</span> and <span class="math inline">\(\phi^H\)</span>). Infection rate (<span class="math inline">\(\psi^{HI}\)</span>) is 75%, recovery rate is 20% (<span class="math inline">\(\psi^{IH}\)</span>).</p>
<!-- ```{r, echo = FALSE} -->
<!-- load(here::here("dat","disease.RData")) -->
<!-- MCMCplot(out) -->
<!-- ``` -->
</div>
</div>
<div id="summary-4" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Summary<a class="anchor" aria-label="anchor" href="#summary-4"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>The AS model is a HMM that extends the CJS model by allowing the estimation of movements between sites (e.g. geographical locations) or transitions between states (e.g. breeding status). This flexibility allows addressing all sorts of questions in ecology and evolution.</p></li>
<li><p>Covariates can be considered, and appropriate priors or link functions need to be used when there are more than 2 sites or 2 alive states.</p></li>
<li><p>Model comparison can be achieved with the WAIC and the goodness of fit of the AS model to capture-recapture data can be assessed with classical procedures.</p></li>
<li><p>Importantly, the HMM framework allows to account for uncertainty when assigning states to individuals.</p></li>
<li><p>The models covered in this chapter haven been called multistratum/strata models, multisite models (section <a href="dispersal.html#ASmodel">5.2</a>), multistate models (section <a href="dispersal.html#states">5.5</a>) and multievent models (section <a href="dispersal.html#multievent">5.7</a>). These models are all HMMs.</p></li>
</ul>
</div>
<div id="suggested-reading-4" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> Suggested reading<a class="anchor" aria-label="anchor" href="#suggested-reading-4"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>The AS model was introduced in <span class="citation">Arnason (<a href="references.html#ref-arnason1972">1972</a>)</span>, <span class="citation">Arnason (<a href="references.html#ref-arnason1973">1973</a>)</span> and <span class="citation">Schwarz, Schweigert, and Arnason (<a href="references.html#ref-SchwarzEtAl1993">1993</a>)</span>. Very soon clever folks realized that sites could be replaced by states as in <span class="citation">Nichols et al. (<a href="references.html#ref-NicholsEtAl1992">1992</a>)</span> and <span class="citation">Nichols et al. (<a href="references.html#ref-NicholsEtAl1994">1994</a>)</span>. For a review of models with sites and states, see <span class="citation">Lebreton et al. (<a href="references.html#ref-LebretonEtAl2009">2009</a>)</span>.</p></li>
<li><p>The geese data were analyzed in <span class="citation">Hestbeck, Nichols, and Malecki (<a href="references.html#ref-hestbeck1991estimates">1991</a>)</span> and <span class="citation">Brownie et al. (<a href="references.html#ref-BrownieEtAl1993">1993</a>)</span>, and the titis data in <span class="citation">Scofield, Fletcher, and Robertson (<a href="references.html#ref-scofield2001titi">2001</a>)</span>. The house finches data were analyzed in <span class="citation">Faustino et al. (<a href="references.html#ref-FaustinoEtAl2004">2004</a>)</span> and <span class="citation">Conn and Cooch (<a href="references.html#ref-ConnCooch2009">2009</a>; see also <a href="references.html#ref-cooch2012disease">Cooch et al. 2012</a>)</span>. Check out <span class="citation">Santoro et al. (<a href="references.html#ref-santoro2014host">2014</a>)</span>, <span class="citation">Marescot et al. (<a href="references.html#ref-MarescotEtAl2018">2018</a>)</span> and <span class="citation">Ollivier et al. (<a href="references.html#ref-ollivier2023lyme">2023</a>)</span> for other examples in disease ecology.</p></li>
<li><p>Section <a href="dispersal.html#localminima">5.6</a> on local minima was inspired by chapter 10 of <span class="citation">Cooch and White (<a href="references.html#ref-cooch2017intromark">2017</a>)</span>.</p></li>
<li><p>Classical goodness of fit tests are reviewed in <span class="citation">Pradel, Gimenez, and Lebreton (<a href="references.html#ref-pradel2005gof">2005</a>)</span>. See also <span class="citation">Pradel, Wintrebert, and Gimenez (<a href="references.html#ref-pradel2003gof">2003</a>)</span> for tests specifically designed for multisite/multistate models.</p></li>
<li><p>Models with uncertainty were introduced in <span class="citation">Pradel (<a href="references.html#ref-pradel_multievent_2005">2005</a>)</span>. <span class="citation">Dupuis (<a href="references.html#ref-dupuis_bayesian_1995">1995</a>)</span> had a similar idea for the AS model. For a review, see <span class="citation">Gimenez et al. (<a href="references.html#ref-gimenez_estimating_2012">2012</a>)</span>.</p></li>
</ul>
<!-- Several papers propose adapted MCMC algo. Also Gelman advice: "Say you have already found several distinct modes of the posterior and you are happy that these are the most important modes, and if the posterior around these modes is reasonably normal. Then you can calculate the hessian at these modes (say, using optim in R with hessian=T) and you can approximate the posterior as a mixture of normals (or t distributions). See p318-319 in Gelman et al. (2003) "Bayesian Data Analysis" for details. Then you can use the normal/t-mixture approximation as the proposal distribution in an independence sampler to obtain samples from the full posterior." --><!-- + @evans2017elicit explain and provide Shiny app to elicit prior with Dirichlet.  -->
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="survival.html"><span class="header-section-number">4</span> Alive and dead</a></div>
<div class="next"><a href="introduction-7.html">Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#dispersal"><span class="header-section-number">5</span> Sites and states</a></li>
<li><a class="nav-link" href="#introduction-6"><span class="header-section-number">5.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#ASmodel"><span class="header-section-number">5.2</span> The Arnason-Schwarz (AS) model</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#theory"><span class="header-section-number">5.2.1</span> Theory</a></li></ul>
</li>
<li>
<a class="nav-link" href="#ASmodelfitting"><span class="header-section-number">5.3</span> Fitting the AS model</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#geese-data"><span class="header-section-number">5.3.1</span> Geese data</a></li>
<li><a class="nav-link" href="#nimble-implementation-1"><span class="header-section-number">5.3.2</span> NIMBLE implementation</a></li>
<li><a class="nav-link" href="#gofas"><span class="header-section-number">5.3.3</span> Goodness of fit</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#what-if-more-than-2-sites"><span class="header-section-number">5.4</span> What if more than 2 sites?</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#dirichletprior"><span class="header-section-number">5.4.1</span> Dirichlet prior</a></li>
<li><a class="nav-link" href="#multinomiallogit"><span class="header-section-number">5.4.2</span> Multinomial logit</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#states"><span class="header-section-number">5.5</span> Sites may be states</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#titis-data"><span class="header-section-number">5.5.1</span> Titis data</a></li>
<li><a class="nav-link" href="#the-as-model-for-states"><span class="header-section-number">5.5.2</span> The AS model for states</a></li>
<li><a class="nav-link" href="#nimble-implementation-2"><span class="header-section-number">5.5.3</span> NIMBLE implementation</a></li>
</ul>
</li>
<li><a class="nav-link" href="#localminima"><span class="header-section-number">5.6</span> Issue of local minima</a></li>
<li>
<a class="nav-link" href="#multievent"><span class="header-section-number">5.7</span> Uncertainty</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#breedingmultievent"><span class="header-section-number">5.7.1</span> Breeding states</a></li>
<li><a class="nav-link" href="#diseasemultievent"><span class="header-section-number">5.7.2</span> Disease states</a></li>
</ul>
</li>
<li><a class="nav-link" href="#summary-4"><span class="header-section-number">5.8</span> Summary</a></li>
<li><a class="nav-link" href="#suggested-reading-4"><span class="header-section-number">5.9</span> Suggested reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/oliviergimenez/banana-book/blob/master/5-move.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/oliviergimenez/banana-book/edit/master/5-move.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian analysis of capture-recapture data with hidden Markov models</strong>: Theory and case studies in R and NIMBLE" was written by Olivier Gimenez. It was last built on 2025-09-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>

# Quantifying life history traits {#tradeoffs}

## Introduction

Capture--recapture models allow the estimation of key demographic parameters such as survival, recruitment, and dispersal. These parameters are central to life history theory, which seeks to explain how organisms allocate limited resources across survival, growth, and reproduction over their lifetime. Life-history traits, such as age at first breeding, breeding frequency, or lifespan, reflect trade--offs shaped by natural selection and environmental constraints.

Capture--recapture data are particularly suited to quantifying such traits in the wild, providing direct estimates that can be compared to theoretical predictions. As introduced in Section \@ref(states), states and transitions between them -- whether disease, developmental, or breeding states -- can be incorporated naturally into the HMM framework.

In this chapter, we focus on three examples: cause-- and age--specific mortalities, age--specific breeding probabilities, and stopover duration. Together, they illustrate how capture–recapture HMMs can shed light on life-history strategies.

## Assessing age-- and cause--specific mortality

### Motivation

Cause‐ and age-specific mortalities are key life-history traits, shaping population dynamics and informing management or conservation strategies. Yet in the wild, direct assignment of causes of death is challenging as field observations are often incomplete, and carcass recovery is biased towards certain causes or habitats. If we ignore this uncertainty, estimates of mortality rates by cause or age class can be biased, and our understanding of population processes compromised.

The fix is to treat cause of death as a latent state. Following @koons2014, we model survival and transitions to cause--specific death states jointly within a HMM capture–recapture framework, by combining data on recaptures of live and recoveries of dead animals. Individuals can either survive to the next occasion or die from one of several competing causes, with probabilities that may depend on age. This formulation naturally accommodates uncertainty in cause assignment, for example, when only a fraction of recovered dead individuals can be confidently attributed to a specific cause.

Here, we use the case study on roe deer (*Capreolus capreolus*) in @koons2014. The authors show that failing to account for uncertain cause assignment underestimated mortality from hunting and overestimated natural mortality, particularly in younger age classes. By explicitly modelling causes as states, we obtain unbiased, age‐specific estimates of cause‐specific mortality and can directly compare them to life‐history theory predictions.

Here, we adopt that logic in NIMBLE: define cause‐specific death states, let survival and cause‐specific mortality depend on age, and keep the rest of the HMM machinery unchanged.

### Model and NIMBLE implementation

For our example, we will use data on roe deer from population in the enclosed forest of the Territoire d'Etude et d'Expérimentation of Trois Fontaines, in eastern France. Each year since 1985, newborn fawns were captured, sexed, marked and released after handling. Here, we focus on the 556 known-age females, of which 217 were recaptured at least once and 41 were deadly injured during handling, victim of car collisions, or recovered and reported by hunters (human-related mortalities). 

To build up our model and explicitely account for this lack of fit, we first define the states and observations:

- Observations   
      - 1, not seen   
      - 2, captured for the first time or recaptured   
      - 3, killed by human activities and reported   

- States  
      - A, alive   
      - H, individual just died from human causes   
      - NH, individual just died from a natural (non-human) cause   
      - D, individual already dead   

Now we turn to writing our model. 

We start with the vector of initial states. Individuals enter alive the study with probability 1: 
$$\begin{matrix}
& \\
\mathbf{\delta} =
\left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=A & z_t=H & z_t=NH & z_t=D \\ \hdashline
1 & 0 & 0 & 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
\begin{matrix}
\end{matrix}
\end{matrix}$$

We proceed with the transition matrix: 
$$\begin{matrix}
& \\
\mathbf{\Gamma} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=A & z_t=H & z_t=NH & z_t=D \\ \hdashline
1 - \mu_H - \mu_{NH}  & \mu_H & \mu_{NH} & 0\\
0 & 0 & &  1\\
0 & 0 & &  1\\
0 & 0 & &  1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1}=A \\ z_{t-1}=H \\ z_{t-1}=NH \\ z_{t-1}=D
\end{matrix}
\end{matrix}$$

where the transition probability from $A$ at $t$ to $H$ at $t + 1$ is the human-related mortality probability $\mu_H$ and the transition probability from $A$ at $t$ to $NH$ at $t + 1$ is the natural mortality probability $\mu_{NH}$. Because an individual could not return to state $A$ once dead, we fix these transitions to 0. 

Following the paper, adult survival is age-specific: $\mu_H$ is different for individuals in their first year of life after birth ([0,1[) vs. age 1 onwards, while $\mu_{NH}$ has two different parameters for ages [0,1[ and [1,2[ then a linear trend with age from age 2 onward. We also use a multinomial logit link function to ensure that mortality probabilities are estimated between 0 and 1 and sum up to 1, see Section \@ref(multinomiallogit). In NIMBLE, we code:
```{r eval = FALSE}
# Transition matrix
  for(i in 1:N){
    for(t in 1:(K-1)) {
      
      # Age effects
      etaH[i,t] <- (alpha_H_01 * age_lt1[i,t] + alpha_H_ge1 * age_ge1[i,t])
      
      etaNH[i,t] <- (alpha_NH_01 * age_lt1[i,t] +                               # if age is [0,1[
                       alpha_NH_12 * age_1to2[i,t] +                            # if age is [1,2[
                       (beta0_NH + beta1_NH * age_std_mu2[i,t]) * age_ge2[i,t]) # linear trend if age >= 2
      
      # Transitions from A
      den[i,t] <- 1 + exp(etaH[i,t]) + exp(etaNH[i,t])  # denominator
      gamma[i,t,1,1] <- 1 / den[i,t]  # stay alive
      gamma[i,t,1,2] <- exp(etaH[i,t]) / den[i,t]   # muH
      gamma[i,t,1,3] <- exp(etaNH[i,t]) / den[i,t]  # muNH
      gamma[i,t,1,4] <- 0  # Always 0
      
      # From H, NH, D (always go to D)
      gamma[i,t,2,1] <- 0; gamma[i,t,2,2] <- 0; gamma[i,t,2,3] <- 0; gamma[i,t,2,4] <- 1
      gamma[i,t,3,1] <- 0; gamma[i,t,3,2] <- 0; gamma[i,t,3,3] <- 0; gamma[i,t,3,4] <- 1
      gamma[i,t,4,1] <- 0; gamma[i,t,4,2] <- 0; gamma[i,t,4,3] <- 0; gamma[i,t,4,4] <- 1
```

In the code above, age is passed in the data and created as follows:
```{r eval = FALSE}
# Build an N x K age matrix
age <- matrix(0, nrow = nrow(obs_matrix), ncol = K)
for (i in 1:nrow(obs_matrix)) {
  for (t in first[i]:K) {
    age[i, t] <- t - first[i]   # age 0 at first capture
  }
}
# Define age [0,1[ and age >=1
for (i in 1:nrow(obs_matrix)) {
  for (t in first[i]:K) {
    age_val <- age[i, t]
    if (age_val == 0) { # age < 1
      age_lt1[i, t] <- 1
      age_ge1[i, t] <- 0
    } else {            # age >= 1
      age_lt1[i, t] <- 0  
      age_ge1[i, t] <- 1
    }
  }
}
# Define age >1 and age [1,2[
for (i in 1:nrow(obs_matrix)) {
  for (t in first[i]:K) {
    age_val <- age[i, t]
    age_ge2[i, t] <- as.integer(age_val > 1)   # age > 1 or 2 onwards
    age_1to2[i, t] <- as.integer(age_val == 1) # age in [1,2[
  }
}
```

Last step is the observation matrix:
$$\begin{matrix}
& \\
\mathbf{\Omega} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
y_t=1 & y_t=2 & y_t=3\\ \hdashline
1 - p & p & 0 \\
1 - \lambda & 0 & \lambda\\
1 & 0 & 0\\
1 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t}=A \\ z_{t}=H \\ z_{t}=NH \\ z_{t}=D
\end{matrix}
\end{matrix}$$

where a live individual can be detected with probability $p$, or not with probability $1−p$. We include time-dependence and age on $p$, with a different parameter for 1 year-old individuals vs. individuals older than 1 year of age. In NIMBLE, we write:
```{r eval = FALSE}
pA[i,t] <- p_ageLE1[t] * age_lt1[i,t] + p_ageGT1[t] * age_ge1[i,t]
```

An individual that just died from human causes can be recovered and reported with probability $\lambda$, or not with probability $1-\lambda$. Because tag recovery protocols were constant over the course of the study, the authors considered that parameter to be constant over time and across age classes.

### Results and interpretation

```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","agemortalities.RData"))
#MCMCsummary(out, round = 2)
```

The results are given in Figure \@ref(fig:fig-mortality-age). We see senescence in natural mortality from age 2 onwards, as well as well as a slighly a higher human-related mortality in the first year of life after birth. These patterns are similar to those obtained by @koons2014, check out their Figure 4. 

```{r fig-mortality-age, fig.cap="Age‐specific mortality probabilities for human‐related (solid line) and natural (dashed line) causes in female roe deer at Trois‐Fontaines, France, from 1985 to 2013. Shaded polygons represent 95\\% credible intervals.", echo=FALSE}
# ----- Posterior curves vs age -----
library(tidyverse)

# Récupère les échantillons MCMC en matrice (toutes chaînes empilées)
draws <- if (is.list(out) && !is.matrix(out)) do.call(rbind, out) else as.matrix(out)

# Colonnes nécessaires
pars <- c("alpha_H_01","alpha_H_ge1","alpha_NH_01","alpha_NH_12","beta0_NH","beta1_NH")

# Plage d’âges entiers
ages_plot <- 1:max(age)           
ages_plot <- 1:18

# Standardization as in your script
age_std_grid     <- (ages_plot - age_mean) / age_sd
age_std_mu2_grid <- ifelse(ages_plot >= 3, age_std_grid, 0)

# Extract draw vectors
aH01  <- draws[, "alpha_H_01"]
aHge1 <- draws[, "alpha_H_ge1"]
aNH01 <- draws[, "alpha_NH_01"]
aNH12 <- draws[, "alpha_NH_12"]
b0    <- draws[, "beta0_NH"]
b1    <- draws[, "beta1_NH"]

# Prepare empty tibble to store results
df_results <- tibble(
  age = numeric(),
  metric = character(),
  median = numeric(),
  l95 = numeric(),
  u95 = numeric()
)

# Loop over ages
for (k in seq_along(ages_plot)) {
  a <- ages_plot[k]
  
  # eta_H(age): with your age definition (≥1), this is alpha_H_ge1
  etaH <- aHge1
  
  # eta_NH(age): piecewise
  if (a < 1) {
    etaNH <- aNH01
  } else if (a == 2) {
    etaNH <- aNH12
  } else if (a >= 3) {
    etaNH <- b0 + b1 * age_std_mu2_grid[k]
  } else {
    # a == 1 → treat like 1–2 piece
    etaNH <- aNH12
  }
  
  # Probabilities
  den  <- 1 + exp(etaH) + exp(etaNH)
  muA  <- 1 / den
  muH  <- exp(etaH)  / den
  muNH <- exp(etaNH) / den
  
  # Summary function
  qfun <- function(x) c(median = median(x), l95 = quantile(x, 0.025), u95 = quantile(x, 0.975))
  sH   <- qfun(muH)
  sNH  <- qfun(muNH)
  
  # Append rows for this age
  df_results <- bind_rows(
    df_results,
    tibble(
      age = a,
      metric = "Mortality: human",
      median = sH[1], l95 = sH[2], u95 = sH[3]
    ),
    tibble(
      age = a,
      metric = "Mortality: natural",
      median = sNH[1], l95 = sNH[2], u95 = sNH[3]
    )
  )
}


ggplot(df_results, aes(age, median)) +
  geom_ribbon(aes(ymin = l95, ymax = u95, fill = metric), alpha = 0.2) +
  geom_line(aes(linetype = metric)) +
  scale_y_continuous(limits = c(0,1), name = "Estimated mortality probability") +
  scale_x_continuous(breaks = pretty(ages_plot)) +
  labs(x = "Age (years)", linetype = NULL, fill = NULL,
       title = "") +
  theme_bw()
```


## Quantifying age-specific breeding

### Motivation

Breeding is not a simple yes/no coin flip. Who breeds this year depends on what happened last year. In long-lived mammals, adult survival is high and fairly stable, but breeding probability can differ according to recent reproductive history and with how reliably we detect mothers and their offspring. If we blur these pieces and treat breeding status as perfectly known we risk biasing both survival and breeding estimates.

@couet2019 give a clear template with female bottlenose dolphins. They show that calf detectability differs by age and a female's breeding probability depends on the outcome of her previous calf. Rather than pretend states are observed without error, they use a HMM to keep true breeding state hidden, model misclassification/detection explicitly, and tie breeding this year to last year's outcome. That way, uncertainty about calf presence and age feeds correctly into demographic estimates.

Here, we follow that logic: we define hidden female states (nonbreeder vs. breeder with calf age classes), let detection vary by calf age, and make breeding probability state-dependent on the previous year's result. The payoff is a set of adult and calf survival estimates and age-specific breeding probabilities that reflect both imperfect observation and real biological carry-over.

### Model and NIMBLE implementation

For our example, we'll work with data from a population of bottlenose dolphins (*Tursiops truncatus*) inhabiting the French waters of the Normano-Breton Gulf in the English Channel. We have 106 encounter histories between 2004 and 2016, made of photographs taken from a boat between July and November, which corresponds to the birth peak and the best weather conditions for monitoring. To build up our model, we first define the states and observations:

- States   
        - NB Nonbreeding adult female   
        - Byoy Breeding adult female with a young‐of‐the‐year
        - Bc1 Breeding adult female with a 1‐year‐old calf
        - Bc3 Breeding adult female with a 3‐year‐old calf
        - Bc2 Breeding adult female with a 2‐year‐old calf
        - D Dead female

- Observations   
        - 0 = not seen   
        - 1 = seen alone   
        - 2 = seen with a young of the year   
        - 3 = seen with a calf (1 to 3 years old)   

Now we turn to writing our model. 

We start with the vector of initial states: 

$$
\begin{matrix}
& \\
\boldsymbol{\delta} =
\left ( \vphantom{ \begin{matrix} 1 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
\pi_1 & \pi_2 & \pi_3 & \pi_4 & \pi_5 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 1 \end{matrix} } \right )
\end{matrix}
$$
where $\displaystyle \pi_5 = 1 - \sum_{j=1}^4\pi_j$.

To write the transition matrix, we can make a diagram of the life cycle:
```{r, engine = 'tikz', echo = FALSE}
\usetikzlibrary{arrows.meta, fit, positioning, automata}
\begin{tikzpicture}[
  >=Latex, node distance=24mm,
  state/.style = {circle, draw, minimum size=8mm, font=\small, align=center}
]
% Nodes
\node[state] (NB)   {NB};
\node[state, right=of NB] (Byoy) {Byoy};
\node[state, right=of Byoy] (Bc1)  {Bc1};
\node[state, right=of Bc1] (Bc2)  {Bc2};
\node[state, right=of Bc2] (Bc3)  {Bc3};
\node[state, below=12mm of Bc2] (D) {D};

% Adult survival (loops)
\draw[->] (NB)   edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Byoy) edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc1)  edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc2)  edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc3)  edge[loop above] node[above] {$\phi_A$} ();

% Death (to D) with labels under the arrows, slightly bent & shortened
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (NB)   to[out=-80, in=180] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Byoy) to[out=-70, in=160] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);

% --- tweaked placements ---
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Bc1)  to[out=-55, in=145] node[pos=0.35, sloped, below] {$1-\phi_A$} (D); % label earlier to avoid crossing
\draw[->, shorten >=1.5pt, shorten <=4pt]
  (Bc2) to[out=-30, in=110]
  node[pos=0.30, sloped, below] {$1-\phi_A$} (D); % --------------------------------

\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Bc3)  to[out=-60, in=60 ] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);

% D absorbing
\draw[->] (D) edge[loop below] node[below] {$1$} ();

% Breeding switch
\draw[->] (NB) -- node[pos=0.5, above] {$\beta_1$} (Byoy);

% YOY survival
\draw[->] (Byoy) -- node[pos=0.5, above] {$\phi_{Y1}$} (Bc1);

% Aging with labels below the arrows
\draw[->] (Bc1) -- node[pos=0.5, below] {$1$} (Bc2);
\draw[->] (Bc2) -- node[pos=0.5, below] {$1$} (Bc3);

% Emancipation Bc3 -> NB (arc above to avoid crossing)
\draw[->] (Bc3) to[out=120, in=60, looseness=1.0]
  node[pos=0.5, above] {$1$} (NB);
\end{tikzpicture}
```

which can be translated in this matrix:
$$
\begin{matrix}
& \\
\mathbf{\Gamma} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=NB & z_t = Byoy & z_t = Bc1 & z_t = Bc2 & z_t = Bc3 & z_t = D \\ \hdashline
\phi_A (1 - \beta_1) & \phi_A \beta_1 & 0 & 0 & 0 & 1 - \phi_A \\
0 & 0 & \phi_A \phi_Y & \phi_A (1-\phi_Y) & 0 & 1-\phi_A \\
\phi_A (1 - \beta_1) & \phi_A \beta_1 & 0 & 0 & 0 & 1-\phi_A \\
\phi_A (1 - \beta_2) & \phi_A \beta_2 & 0 & 0 & 0 & 1-\phi_A \\
\phi_A (1 - \beta_2) & \phi_A \beta_2 & 0 & 0 & 0 & 1-\phi_A \\
0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1} = NB \\
z_{t-1} = Byoy \\
z_{t-1} = Bc1 \\
z_{t-1} = Bc2 \\
z_{t-1} = Bc3 \\
z_{t-1} = D
\end{matrix}
\end{matrix}
$$

As noted by @couet2019, this transition matrix can be split split into four steps: (1) female survival $\mathbf{\Phi_A}$, (2) young survival $\mathbf{\Phi_Y}$, (3) young aging $\mathbf{AGING}$, and (4) breeding $\mathbf{BREED}$, each step being conditional on the previous ones. To do so, we introduce some intermediate states: 

- Intermediate states   
       - Byoy‐D Breeding adult female that had lost her young‐of‐the‐year   
       - Bc1‐D Breeding adult female that had lost her 1‐year‐ old calf   
       - Bc2‐D Breeding adult female that had lost her 2‐year‐ old calf   
       - Bc3‐leave Breeding adult female that raised her calf to the age of 3   

The four corresponding matrices are given below, starting with the female survival matrix: 
$$
\begin{matrix}
& \\
\mathbf{\Phi_A} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
\phi_A & 0      & 0      & 0      & 0      & 1 - \phi_A \\
0      & \phi_A & 0      & 0      & 0      & 1 - \phi_A \\
0      & 0      & \phi_A & 0      & 0      & 1 - \phi_A \\
0      & 0      & 0      & \phi_A & 0      & 1 - \phi_A \\
0      & 0      & 0      & 0      & \phi_A & 1 - \phi_A \\
0      & 0      & 0      & 0      & 0      & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$

An adult female survives from $t$ to $t+1$ with probability $\phi_A$ or dies with $1−\phi_A$. We go on with the young survival matrix:
$$
\begin{matrix}
& \\
\mathbf{\Phi_Y} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Byoy-D} & \text{Bc1} & \text{Bc1-D} & \text{Bc2} & \text{Bc2-D} & \text{Bc3-leave} & \text{D} \\ \hdashline
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & \phi_{Y,1} & 1 - \phi_{Y,1} & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & \phi_{Y,1} & 1 - \phi_{Y,1} & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & \phi_{Y,2} & 1 - \phi_{Y,2} & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$


Offspring survive with probability $\phi_Y$ or die with $1-\phi_Y$. If the calf survives, the female remains in the same breeding state. If it dies, she moves to an intermediate “dead-offspring” state ($BYOY-D$, $Bc1-D$, or $Bc2-D$) so that later steps can condition on that loss. For 3-year-old calves, mortality cannot be distinguished from emancipation (leaving the mother), so we add an intermediate $Bc3-leave$ state and fix survival to 1 there (this parameter is otherwise unidentifiable). We go on with the young aging matrix:
$$
\begin{matrix}
& \\
\mathbf{AGING} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Byoy-D} & \text{Bc1} & \text{Bc1-D} & \text{Bc2} & \text{Bc2-D} & \text{Bc3-leave} & \text{D} \\ \hdashline
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Byoy-D} \\
\text{Bc1} \\
\text{Bc1-D} \\
\text{Bc2} \\
\text{Bc2-D} \\
\text{Bc3-leave} \\
\text{D}
\end{matrix}
\end{matrix}
$$
The progression of calf age classes between $t$ and $t+1$ is deterministic, all relevant age-advancing transitions are set to 1, and there are no parameters estimated in this matrix. Last, here is the breeding matrix: 
$$
\begin{matrix}
& \\
\mathbf{BREED} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 \\
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
1 - \beta_2 & \beta_2 & 0 & 0 & 0 & 0 \\
1 - \beta_2 & \beta_2 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Byoy-D} \\
\text{Bc1-D} \\
\text{Bc2-D} \\
\text{Bc3-leave} \\
\text{D}
\end{matrix}
\end{matrix}
$$

Breeding at $t+1$ occurs with probability $\beta$ (otherwise $1−\beta$). Breeding can depend on the female's state, including whether she was a nonbreeder at $t$ or had lost her calf between $t$ and $t+1$ (the $−D$ intermediate states created in the young-survival step).

Overall, the transition matrix is the product of all four matrices. In NIMBLE, we could code directly the full matrix, but I take this opportunity to illustrate how to code the splitting in several ecological processes:
```{r eval = FALSE}
# Transition matrix

# PHIA is 6x6
for (i in 1:5) {
  PHIA[i, i] <- adultsurvival
  PHIA[i, 6] <- 1 - adultsurvival
}
PHIA[6, 6] <- 1

# PHIY is 6x9
# Row 1: NB stays NB
PHIY[1, 1] <- 1
# Row 2: Byoy
PHIY[2, 2] <- youngsurvival[1]        # YOY survives → becomes Bc1
PHIY[2, 3] <- 1 - youngsurvival[1]    # YOY dies     → becomes Byoy-D
# Row 3: Bc1
PHIY[3, 4] <- youngsurvival[1]        # 1-year-old survives → Bc2
PHIY[3, 5] <- 1 - youngsurvival[1]    # dies → Bc1-D
# Row 4: Bc2
PHIY[4, 6] <- youngsurvival[2]        # 2-year-old survives → Bc3-L (emancipation)
PHIY[4, 7] <- 1 - youngsurvival[2]    # dies → Bc2-D
# Row 5: Bc3 always emancipates
PHIY[5, 8] <- 1
# Row 6: dead female stays dead
PHIY[6, 9] <- 1

# AGING is 9x9
AGING[1, 1] <- 1   # NB → NB
AGING[2, 2] <- 1   # Byoy → Bc1
AGING[3, 5] <- 1   # Byoy-D → Byoy-D
AGING[4, 3] <- 1   # Bc1 → Bc2
AGING[5, 6] <- 1   # Bc1-D → Bc1-D
AGING[6, 4] <- 1   # Bc2 → Bc3
AGING[7, 7] <- 1   # Bc2-D → Bc2-D
AGING[8, 8] <- 1   # Bc3-L → Bc3-L
AGING[9, 9] <- 1   # D → D

# BREED is 9x6
# Row 1: NB → Byoy or NB
BREED[1, 2] <- beta[1]
BREED[1, 1] <- 1 - beta[1]
# Row 2: Bc1 → Bc1
BREED[2, 3] <- 1
# Row 3: Bc2 → Bc2
BREED[3, 4] <- 1
# Row 4: Bc3 → Bc3
BREED[4, 5] <- 1
# Row 5: Byoy-D → Byoy or NB
BREED[5, 2] <- beta[1]
BREED[5, 1] <- 1 - beta[1]
# Row 6: Bc1-D → Byoy or NB
BREED[6, 2] <- beta[1]
BREED[6, 1] <- 1 - beta[1]
# Row 7: Bc2-D → Byoy or NB
BREED[7, 2] <- beta[2]
BREED[7, 1] <- 1 - beta[2]
# Row 8: Bc3-L → Byoy or NB
BREED[8, 2] <- beta[2]
BREED[8, 1] <- 1 - beta[2]
# Row 9: D → D
BREED[9, 6] <- 1

gamma[1:6,1:6] <- PHIA[1:6,1:6] %*% PHIY[1:6,1:9] %*% AGING[1:9,1:9] %*% BREED[1:9,1:6]
```

Last step is the observation matrix that we can also split in two steps. First, the detection step: 
$$
\begin{matrix}
& \\
\mathbf{DETECTION} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
1 - p_1 & p_1 & 0 & 0 & 0 & 0 \\
1 - p_2 & 0 & p_2 & 0 & 0 & 0 \\
1 - p_2 & 0 & 0 & p_2 & 0 & 0 \\
1 - p_1 & 0 & 0 & 0 & p_1 & 0 \\
1 - p_1 & 0 & 0 & 0 & p_1 & 0 \\
1 & 0 & 0 & 0 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$

which contains the probability $p$ of detecting the female given her latent state at $t$. Then the observation matrix: 
$$
\begin{matrix}
& \\
\mathbf{OBS} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
1 & 2 & 3 & 4 \\ \hdashline
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 1 - q_1 & q_1 & 0 \\
0 & 1 - q_2 & 0 & q_2 \\
0 & 1 - q_2 & 0 & q_2 \\
0 & 1 - q_2 & 0 & q_2
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$
where, conditional on being in a breeding state, there is a probability $q$ that a calf is seen vs. not seen. Calf age is not identifiable from photographs, so observations are seen or not seen, but $q$ may still vary by calf age (e.g., YOY vs. older). This is coded in NIMBLE as follows:
```{r eval = FALSE}
# Observation matrix

# Detection probabilities
DETECTION[1, 1] <- 1 - p[1]     # NB not detected
DETECTION[1, 2] <- p[1]         # NB detected
DETECTION[2, 1] <- 1 - p[2]
DETECTION[2, 3] <- p[2]        # Byoy detected
DETECTION[3, 1] <- 1 - p[2]
DETECTION[3, 4] <- p[2]         # Bc1 detected
DETECTION[4, 1] <- 1 - p[1]
DETECTION[4, 5] <- p[1]         # Bc2 detected
DETECTION[5, 1] <- 1 - p[1]
DETECTION[5, 6] <- p[1]         # Bc3 detected
DETECTION[6, 1] <- 1           # Dead never detected

# OBS is 6x4
# Not detected → not sighted
OBS[1, 1] <- 1
# Detected NB → alone
OBS[2, 2] <- 1
# Detected Byoy → YOY visible or not
OBS[3, 2] <- 1 - q[1]    # alone
OBS[3, 3] <- q[1]        # with YOY
# Detected Bc1 → calf visible or not
OBS[4, 2] <- 1 - q[2]
OBS[4, 4] <- q[2]
# Detected Bc2
OBS[5, 2] <- 1 - q[2]
OBS[5, 4] <- q[2]
# Detected Bc3
OBS[6, 2] <- 1 - q[2]
OBS[6, 4] <- q[2]

omega[1:6,1:4] <- DETECTION[1:6,1:6] %*% OBS[1:6,1:4]
```

### Results and interpretation

The raw results are:
```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","agebreeding.RData"))
MCMCsummary(out, round = 2)
```

which we can gather in a table to compare them to the estimates obtained by @couet2019: 
```{r results='asis', echo=FALSE, message=FALSE}
library(knitr)

# ---- 1) Rough, by-eye digitization from Couet et al. (2019) Fig. 3 ----
# Black line: nonbreeding females OR breeding with 2–3 y calf
rho_nb_older <- c(0.40, 0.50, 0.52, 0.32, 0.55, 0.64, 0.46, 0.49, 0.45, 0.49, 0.44, 0.42)

# Gray line: breeding females with YOY or 1-year calf
rho_yoy_1yr <- c(0.55, 0.60, 0.62, 0.45, 0.60, 0.72, 0.65, 0.58, 0.65, 0.68, 0.58, 0.62)

rho_nb_older_avg <- mean(rho_nb_older)   # ≈ 0.47
rho_yoy_1yr_avg  <- mean(rho_yoy_1yr)    # ≈ 0.61

# ---- 2) Your posterior summaries (as you reported) ----
fmt <- function(m,l,u) sprintf("%.2f (%.2f–%.2f)", m,l,u)
ours <- list(
  adultsurvival        = list(mean=0.96, l=0.94, u=0.98),
  # calf observation (delta) by calf age (YOY vs older)
  q_yoy                = list(mean=0.59, l=0.49, u=0.69),
  q_older              = list(mean=0.80, l=0.70, u=0.89),
  youngsurv_yoy        = list(mean=0.63, l=0.55, u=0.73),
  youngsurv_1yr        = list(mean=0.69, l=0.53, u=0.83),
  # adult female detection (rho) by breeding state class
  p_nb_older           = list(mean=0.63, l=0.58, u=0.69),  # your p[1]
  p_yoy_1yr            = list(mean=0.79, l=0.72, u=0.86),  # your p[2]
  # initial state mix (pi_1:pi_5)
  pi1                  = list(mean=0.49, l=0.37, u=0.60),  # NB
  pi2                  = list(mean=0.26, l=0.17, u=0.37),  # Byoy
  pi3                  = list(mean=0.08, l=0.03, u=0.16),  # Bc1
  pi4                  = list(mean=0.14, l=0.07, u=0.23),  # Bc2
  pi5                  = list(mean=0.03, l=0.00, u=0.10)   # Bc3
)

# ---- 3) Paper side: use time-averaged rho from Fig. 3; delta & survivals from text ----
paper <- list(
  adultsurvival        = "0.97 (0.96–0.98)",
  q_yoy                = "0.58 (0.46–0.68)",  # calf seen (YOY)
  q_older              = "0.79 (0.59–0.90)",  # calf seen (1–3 y)
  youngsurv_yoy        = "0.66 (0.50–0.78)",
  youngsurv_1yr        = "0.45 (0.29–0.61)",
  # adult female detection (averages from Fig. 3)
  p_nb_older           = sprintf("≈%.2f", rho_nb_older_avg),
  p_yoy_1yr            = sprintf("≈%.2f", rho_yoy_1yr_avg),
  # initial mix not reported explicitly
  pi1                  = "NR",
  pi2                  = "NR",
  pi3                  = "NR",
  pi4                  = "NR",
  pi5                  = "NR"
)

labels <- c(
  adultsurvival        = "Adult female survival",
  q_yoy                = "Calf observation, YOY (δ)",
  q_older              = "Calf observation, 1–3 y (δ)",
  youngsurv_yoy        = "Calf survival (YOY)",
  youngsurv_1yr        = "Calf survival (1-year-old)",
  p_nb_older           = "Female detection ρ: NB or calf 2–3 y",
  p_yoy_1yr            = "Female detection ρ: YOY or 1-year calf",
  pi1                  = "Initial state π₁ (NB)",
  pi2                  = "Initial state π₂ (Byoy)",
  pi3                  = "Initial state π₃ (Bc1)",
  pi4                  = "Initial state π₄ (Bc2)",
  pi5                  = "Initial state π₅ (Bc3)"
)

order_keys <- names(labels)

tab <- data.frame(
  Quantity = unname(labels[order_keys]),
  `Our NIMBLE (mean, 95% CrI)` =
    sapply(ours[order_keys], function(x) fmt(x$mean, x$l, x$u)),
  `Couet et al. 2019` =
    unname(unlist(paper[order_keys])),
  check.names = FALSE
)

kable(
  tab,
  align = c("l","c","c"),
  caption = "Comparison of our NIMBLE estimates with Couet et al. (2019). ‘NR’ denotes quantities not reported in the paper. Adult female detection (ρ) on the paper side is a rough time-average read by eye from Figure 3 (2005–2016)."
)
```

Our NIMBLE estimates track the published values closely. Calf survival shows some discrepancies, but credible and confidence intervals overlap, so I would not worry too much. Note also that our model differs slightly: we held adult female detection constant in time, whereas the paper models it as time‐dependent.

Offspring are often missed even when a female is breeding, especially YOY, which are harder to see than older calves. Offspring detection is well below 1. Adult detection also depends on the female's state: females with a YOY or 1-year calf are more detectable than nonbreeders or those with older calves.

Adult female survival is high. Calf survival ranks YOY ≥ 1-year > 2-year. Breeding probability depends on recent history: it's lower after nonbreeding or losing a YOY/1-year calf, and higher after losing a 2-year calf or successfully raising a calf to age 3.

## Estimating stopover duration

### Motivation 

Stopover is not just a logistical pause; it's a stage-specific timing trait in a migratory life cycle. Like age at first reproduction or length of a breeding attempt, the duration of stopover shapes exposure to predators, energy balance, and downstream reproductive timing. Two core questions in migration ecology are: (1) how long individuals stop over, and (2) whether groups differ in their stopover behaviour. Treating stopover as a life-history trait puts those questions center stage.

The catch is that arrivals and departures are hidden and detection is imperfect. If we only look at when individuals are seen, we bias both the entry curve and the distribution of stay lengths. As reviewed in @guerin_advances_2017, a HMM fixes this by keeping states hidden and observations separate: for example, we may use three latent states: not yet arrived, arrived (present), departed; and let two transition probabilities drive dynamics: recruitment (from not yet arrived to arrived) and staying (from arrived to arrived). Detection operates only in state arrived. This so-called time-effect parameterization assumes staying depends on calendar date, not time-since-arrival, which is often the right first step.

With this setup we can estimate daily entry and staying probabilities, derive expected stopover duration for an arrival date, and test for group differences in behaviour. In short, framing stopover within a HMM makes the biology explicit and the inference calibrated.

### Model and NIMBLE implementation

We illustrate the model with marbled newts (*Triturus marmoratus*) monitored in 2013 at a permanent pond near Vigneux-de-Bretagne (Loire-Atlantique, western France). Intensive capture–recapture yielded 713 PIT-tagged newts (412 males, 301 females). For analysis, captures within the same week were pooled to create 12 equally spaced occasions (11 weekly samples plus a leading 'empty' occasion), so all individuals start in the 'not yet arrived' state.

To build up our model, we first define the states and observations:

- States   
      - not yet arrived in the pond (NYA)   
      - arrived in the pond (ARR)   
      - departed from the pond (DEP)   

- Observations   
      - not captured (1)   
      - captured (2)]   
      
Now we turn to writing our model. 

We start with the vector of initial states. At the start of the study, everyone is in $NYA$, so the initial state vector is: 
$$
\begin{matrix}
& \\
\boldsymbol{\delta} =
\left ( \vphantom{ \begin{matrix} 1 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NYA} & \text{ARR} & \text{DEP} \\ \hdashline
1 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 1 \end{matrix} } \right )
\end{matrix}
$$

We proceed with the transition matrix, which is governed by two processes: recruitment $r$ is the probability that an individual in $NYA$ enters the pond and staying $s$ is the probability that an individual in $ARR$ remains in the pond. State $DEP$ is absorbing. We have: 
$$\begin{matrix}
& \\
\mathbf{\Gamma} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=NYA & z_t=ARR & z_t=DEP \\ \hdashline
1 - r & r & 0 \\
0 & s & 1 - s \\
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1}=NYA \\ z_{t-1}=ARR \\ z_{t-1}=DEP
\end{matrix}
\end{matrix}$$

We make both parameters $r$ and $s$ sex and time-dependent, which we code in NIMBLE:
```{r eval = FALSE}
for (j in 1:(K-1)){
  logit(r[1,j]) <- beta[1,1] + beta[1,2] * (j-4.5)/2.45 # prior probability of arriving in the pond / 1 = female
  logit(r[2,j]) <- beta[2,1] + beta[2,2] * (j-4.5)/2.45 # prior probability of arriving in the pond / 2 = male
  s[1,j] ~ dunif(0, 1) # prior retention probability (staying) / 1 = female
  s[2,j] ~ dunif(0, 1) # prior retention probability (staying) / 2 = male
}
for (i in 1:N){
  for (j in 1:(K-1)){
    gamma[1,1,i,j] <- 1 - r[sex[i],j] 
    gamma[1,2,i,j] <- r[sex[i],j] 
    gamma[1,3,i,j] <- 0 
    gamma[2,1,i,j] <- 0
    gamma[2,2,i,j] <- s[sex[i],j]
    gamma[2,3,i,j] <- 1 - s[sex[i],j]
    gamma[3,1,i,j] <- 0 
    gamma[3,2,i,j] <- 0 
    gamma[3,3,i,j] <- 1
  }
}
```

Graphically, this corresponds to:
```{r diagram-stopover, engine = 'tikz', echo = FALSE}
\usetikzlibrary{arrows.meta, fit, positioning, automata}
\begin{tikzpicture}[>=Latex, node distance=28mm, state/.style={circle,draw,minimum size=8mm}]
\node[state] (NYA) {NYA};
\node[state, right=of NYA] (ARR) {ARR};
\node[state, right=of ARR] (DEP) {DEP};

\draw[->] (NYA) edge[bend left] node[above] {$r_{g,j}$} (ARR);
\draw[->] (NYA) edge[loop above] node {$1 - r_{g,j}$} ();
\draw[->] (ARR) edge[bend left] node[above] {$1 - s_{g,j}$} (DEP);
\draw[->] (ARR) edge[loop above] node {$s_{g,j}$} ();
\draw[->] (DEP) edge[loop above] node {$1$} ();
\end{tikzpicture}
```

Last step is the observation matrix:
$$\begin{matrix}
& \\
\mathbf{\Omega} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
y_t=1 & y_t=2 \\ \hdashline
1 & 0 \\
1-p & p \\
1 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t}=NYA \\ z_{t}=ARR \\ z_{t}=DEP
\end{matrix}
\end{matrix}$$

where only individuals in state $ARR$ are observable with probability $p$.

The likelihood and priors are handled as usual. 

Using MCMC draws from the posterior distribution of the staying $s$, we can calculate the expected stopover duration $\mathbb{E}[D]$ which is the number of occasions present after arrival. With constant $s$, this is given by:
\[
\mathbb{E}[D] \;=\; \frac{1}{\,1 - s\,}.
\]

Why is that? Because the length of stay (counting the arrival occasion) is geometric. After arriving, you are present this week with probability 1 (that's 1 week). You are still present next week with probability $s$. You are still present the week after with probability $s^2$. And so on. So the expected number of occasions present is the sum of those probabilities: 

\[
\mathbb{E}[D] \;=\; 1+s+s^2+\cdots \;=\; \frac{1}{\,1 - s\,}.
\]

When $s$ varies with date, the 'length of stay' after arrival is no longer geometric with a single parameter, it's a non-homogeneous geometric process with week-specific stay probabilities $s_t$. If an individual arrives on date $\tau$, the chance it is still present $k$ occasions later is the product of the stay probabilities along that run:

\[
Pr(D > k \mid \text{arrive at } \tau) \;=\; \prod_{j=0}^{k-1} s_{\tau + j}.
\]

Therefore, the expected number of occasions present (counting the arrival occasion) is the sum of those tail probabilities:
\[
\mathbb{E}[D \mid \text{arrive at } \tau]
\;=\;
\sum_{k=0}^{\infty} \prod_{j=0}^{k-1} s_{\tau + j}.
\]

with the empty product for $k=0$ equal to 1, or in other words the sum of the probabilities of 'surviving' each additional week in $ARR$ under the calendar-date effects.

### Results and interpretation

```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","stopover.RData"))
```

Our NIMBLE estimates match pretty closely those obtained by @guerin_advances_2017, check out their Figure 2.  

```{r echo = FALSE}
samps <- rbind(out[[1]], out[[2]])

library(tidyverse)

# samps: matrix from rbind(out[[1]], out[[2]])
df <- as.data.frame(samps) %>% mutate(iter = row_number())

# Helpers to tidy blocks like r[i,j] and s[i,j]
tidy_block <- function(df, prefix){
  df %>%
    select(iter, matches(paste0("^", prefix, "\\["))) %>%
    pivot_longer(-iter, names_to = "param", values_to = "value") %>%
    mutate(
      i = as.integer(str_match(param, paste0(prefix, "\\[(\\d+),"))[,2]),
      j = as.integer(str_match(param, ",\\s*(\\d+)\\]")[,2]),
      sex = ifelse(i == 1, "Female", "Male"),
      week = j
    ) %>%
    select(iter, sex, week, value)
}

r_long <- tidy_block(df, "r")
s_long <- tidy_block(df, "s")
```

Early in the season, females arrive first: during the first three capture occasions their arrival probability exceeds that of males. By occasion 7, essentially all individuals have entered the pond (Figure \@ref(fig:fig-arrival-prob)).

```{r fig-arrival-prob, echo = FALSE, fig.align='center', out.width='85%', fig.cap="Arrival probability by sex and week. Means and 95\\% credible intervals (shaded areas) are provided."}
r_sum <- r_long %>%
  group_by(sex, week) %>%
  summarise(
    mean = mean(value),
    median = median(value),
    l95 = quantile(value, 0.025),
    u95 = quantile(value, 0.975),
    .groups = "drop"
  )

p_r <- ggplot(r_sum, aes(x = week, y = mean, color = sex, fill = sex, group = sex)) +
  geom_ribbon(aes(ymin = l95, ymax = u95), alpha = 0.20, linewidth = 0) +
  geom_line(size = 1) +
  labs(x = "Week", y = "Estimated arrival probability",
       title = "") +
  theme_bw() +
  theme(legend.position = "top")
p_r
```

Females show longer stopovers than males for most of the season; near the end, the pattern reverses. Individuals arriving early in the breeding season stay longer than those arriving later (Figure \@ref(fig:fig-stopover-duration)).

```{r fig-stopover-duration, echo = FALSE, fig.align='center', out.width='85%', fig.cap="Expected stopover duration by sex and arrival week. Means and 95\\% credible intervals (shaded areas) are provided."}
compute_duration_curve <- function(s_vec){
  s_vec <- pmin(s_vec, 0.999999)        # guard against s=1 exactly
  K <- length(s_vec)
  dur <- numeric(K)
  for(w in 1:K){
    if(w == K){
      dur[w] <- 1
    } else {
      dur[w] <- 1 + sum(cumprod(s_vec[w:(K-1)]))
    }
  }
  dur
}

K_weeks <- max(s_long$week)

duration_draws <- s_long %>%
  arrange(iter, sex, week) %>%
  group_by(iter, sex) %>%
  summarise(
    duration = list(compute_duration_curve(value)),
    .groups = "drop"
  ) %>%
  mutate(week = list(seq_len(K_weeks))) %>%
  unnest(c(week, duration))

duration_sum <- duration_draws %>%
  group_by(sex, week) %>%
  summarise(
    mean = mean(duration),
    median = median(duration),
    l95 = quantile(duration, 0.025),
    u95 = quantile(duration, 0.975),
    .groups = "drop"
  )

p_dur <- ggplot(duration_sum, aes(x = week, y = mean, color = sex, fill = sex, group = sex)) +
  geom_ribbon(aes(ymin = l95, ymax = u95), alpha = 0.20, linewidth = 0) +
  geom_line(size = 1) +
  labs(x = "Week", y = "Estimated stopover duration (weeks)",
       title = "") +
  theme_bw() +
  theme(legend.position = "top")
p_dur
```

<!-- ## Recruitment -->

<!-- @pradel1997 -->

<!-- The purpose of the exercise is to estimate the accession to reproduction. The greater flamingo (Phoenicopterus ruber roseus) is a long-lived colonial waterbird that shows delayed maturity. No breeding attempt by a bird <3 yr old has ever been observed. The data used here come from a long term study in the Etang du Fangassier, part of the large complex of commercial salt pans of Salin de Giraud in the Camargue (southern France). They have been collected by the biological station of Tour du Valat and previously analyzed by Pradel et al. (1997). The data concern 7822 individuals ringed as young from 1977 to 1988 and resighted as breeders between 1983 and 1994. Of these, 1680 have been resighted breeding at least once. The observations as Pre-Breeder (chicks only) are coded 1. The observations as Breeder are coded 2. The capture histories are given in file FLAMINGO.TXT -->

<!-- Transition matrix: -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Gamma} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           z_t=J & z_t=1yNB & z_t=2yNB & z_t=B & z_t=D \\ \hdashline -->
<!--           0 & \phi_1 (1-\alpha_1) & 0 & \phi_1 \alpha_1 & 1 - \phi_1\\ -->
<!--           0 & 0 & \phi_2 (1-\alpha_2) & \phi_2 \alpha_2 & 1 - \phi_2\\ -->
<!--           0 & 0 & 0 & \phi_3 & 1 - \phi_3\\ -->
<!--           0 & 0 & 0 & \phi_B & 1 - \phi_B\\ -->
<!--           0 & 0 & 0 & 0 & 1 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t-1} = J \\ z_{t-1} = 1yNB \\ z_{t-1} = 2yNB \\ z_{t-1} = B \\ z_{t-1} = D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->

<!-- First-year and second-year individuals breed with probabilities $\alpha_1$ and $\alpha_2$. Then, everybody breeds from age 3. -->

<!-- Observation matrix: -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Omega} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           y_t = 1 & y_t = 2 & y_t = 3 & y_t = 4\\ \hdashline -->
<!--           1 & 0 & 0 & 0\\ -->
<!--           1 - p_1 & p_1 & 0 & 0\\ -->
<!--           1 - p_2 & 0 & p_2 & 0\\ -->
<!--           1 - p_3 & 0 & 0 & p_3\\ -->
<!--           1 & 0 & 0 & 0 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_t = J \\ z_t = 1yNB \\ z_t = 2yNB \\ z_t = B \\ z_t = D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->

<!-- Juveniles are never detected. -->




<!-- ## Tradeoffs {#casestudytradeoff} -->

<!-- @morano_life-history_2013, @shefferson_life_2003, and @cruz-flores_sex-specific_nodate -->

<!-- Case study with simulations as in Oikos paper, see Figure 1 and Table 2. Would be a nice example of the use of simulations. Another example could the statistical power analyses. -->

<!-- Also consider paper by Sarah on red-footed boobies.  -->

<!-- ## Breeding dynamics -->

<!-- @pradel_breeding_2012, @desprez_now_2011, @desprez_known_2013, and @pacoureau_population_2019 -->

<!-- ## Using data on dead recoveries -->

<!-- ### Ring recovery simple model -->

<!-- ### Combination of live captures and dead recoveries -->

<!-- Combine live recapture w/ dead recoveries by @lebreton1999. -->

<!-- Transition matrix -->


<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Gamma} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           z_t=A & z_t=JD & z_t=D \\ \hdashline -->
<!--           s & 1-s & 0\\ -->
<!--           0 & 0 & 1\\ -->
<!--           0 & 0 & 1 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t-1}=\text{alive} \\ z_{t-1}=\text{just dead} \\ z_{t-1}=\text{dead for good} -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->



<!-- Observation matrix -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Omega} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           y_t=1 & y_t=2 & y_t=3 \\ \hdashline -->
<!--           1 - p & 0 & p\\ -->
<!--           1 - r & r & 0\\ -->
<!--           1 & 0 & 0 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t}=A \\ z_{t}=JD \\ z_{t}=D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->


<!-- ### Cause-specific mortalities -->

<!-- @koons2014, @fernandez-chacon_causes_2016 and @ruette_comparative_2015 -->

<!-- ## Actuarial senescence -->

<!-- @choquet_semi-markov_2011, @peron_evidence_2016 and @marzo2011. -->


# Quantifying life history traits {#tradeoffs}

## Introduction

See <https://www.oxfordbibliographies.com/display/document/obo-9780199830060/obo-9780199830060-0016.xml> and <https://en.wikipedia.org/wiki/Life_history_theory> for a definition. I think that all case studies below fall in the LH category. I might consider moving the disease ecology case study in the main Sites and states chapter. See however  <https://onlinelibrary.wiley.com/doi/epdf/10.1111/ele.13681> for a link between disease ecology and life history theory. 

## Assessing age- and cause--specific mortality

### Motivation

Combine dead recoveries with live recaptures. Paper by @koons2014. Roe deer data. Cite recent paper by Michael on the combination.

See also nice app by @fernandez-chacon_causes_2016,  @peron_evidence_2016 and @marzo2011. Extension to semi-markov in @choquet_semi-markov_2011.

### Model and NIMBLE implementation

<!-- # OBS -->
<!-- # 0, not seen;  -->
<!-- # 1, captured for the first time or recaptured;  -->
<!-- # 2, killed by human activities and reported.  -->

<!-- # STATES -->
<!-- # A, alive;  -->
<!-- # H, individual just died from human causes;  -->
<!-- # NH, individual just died from a natural (non-human) cause;  -->
<!-- # D, individual already dead. -->

$$\begin{matrix}
& \\
\mathbf{\delta} =
\left ( \vphantom{ \begin{matrix} 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=A & z_t=H & z_t=NH & z_t=D \\ \hdashline
1 & 0 & 0 & 0\\
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \end{matrix} } \right )
\begin{matrix}
\end{matrix}
\end{matrix}$$

We proceed with the transition matrix: 
$$\begin{matrix}
& \\
\mathbf{\Gamma} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
z_t=A & z_t=H & z_t=NH & z_t=D \\ \hdashline
1 - \mu_H - \mu_{NH}  & \mu_H & \mu_{NH} & 0\\
0 & 0 & &  1\\
0 & 0 & &  1\\
0 & 0 & &  1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t-1}=A \\ z_{t-1}=H \\ z_{t-1}=NH \\ z_{t-1}=D
\end{matrix}
\end{matrix}$$

Following the paper, adult survival is blabla:
```{r eval = FALSE}
# Transition matrix
  for(i in 1:N){
    for(t in 1:(K-1)) {
      
      # Age effects
      etaH[i,t] <- (alpha_H_01 * age_lt1[i,t] + alpha_H_ge1 * age_ge1[i,t])
      
      etaNH[i,t] <- (alpha_NH_01 * age_lt1[i,t] +
                       alpha_NH_12 * age_1to2[i,t] +
                       (beta0_NH + beta1_NH * age_std_mu2[i,t]) * age_ge2[i,t])
      
      # Denominator 
      den[i,t] <- 1 + exp(etaH[i,t]) + exp(etaNH[i,t])  # Default denominator = 1
      
      # Transitions from A
      gamma_it[i,t,1,1] <- 1 / den[i,t]  # Default: stay alive
      gamma_it[i,t,1,2] <- exp(etaH[i,t]) / den[i,t]   # Default: 0
      gamma_it[i,t,1,3] <- exp(etaNH[i,t]) / den[i,t]  # Default: 0
      gamma_it[i,t,1,4] <- 0  # Always 0
      
      # From H, NH, D (always go to D)
      gamma_it[i,t,2,1] <- 0; gamma_it[i,t,2,2] <- 0; gamma_it[i,t,2,3] <- 0; gamma_it[i,t,2,4] <- 1
      gamma_it[i,t,3,1] <- 0; gamma_it[i,t,3,2] <- 0; gamma_it[i,t,3,3] <- 0; gamma_it[i,t,3,4] <- 1
      gamma_it[i,t,4,1] <- 0; gamma_it[i,t,4,2] <- 0; gamma_it[i,t,4,3] <- 0; gamma_it[i,t,4,4] <- 1
```

In the code above, age is passed in the data and created as follows:
```{r eval = FALSE}
...
```

Last step is the observation matrix:
$$\begin{matrix}
& \\
\mathbf{\Omega} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
y_t=1 & y_t=2 & y_t=3\\ \hdashline
1 - p & p & 0 \\
1 - \lambda & 0 & \lambda\\
1 & 0 & 0\\
1 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
z_{t}=A \\ z_{t}=H \\ z_{t}=NH \\ z_{t}=D
\end{matrix}
\end{matrix}$$


### Results and interpretation


```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","agemortalities.RData"))
MCMCsummary(out, round = 2)
```

```{r echo = FALSE}
# ----- Posterior curves vs age -----
library(tidyverse)

# Récupère les échantillons MCMC en matrice (toutes chaînes empilées)
draws <- if (is.list(out) && !is.matrix(out)) do.call(rbind, out) else as.matrix(out)

# Colonnes nécessaires
pars <- c("alpha_H_01","alpha_H_ge1","alpha_NH_01","alpha_NH_12","beta0_NH","beta1_NH")

# Plage d’âges entiers
ages_plot <- 1:max(age)           
ages_plot <- 1:18

# Standardization as in your script
age_std_grid     <- (ages_plot - age_mean) / age_sd
age_std_mu2_grid <- ifelse(ages_plot >= 3, age_std_grid, 0)

# Extract draw vectors
aH01  <- draws[, "alpha_H_01"]
aHge1 <- draws[, "alpha_H_ge1"]
aNH01 <- draws[, "alpha_NH_01"]
aNH12 <- draws[, "alpha_NH_12"]
b0    <- draws[, "beta0_NH"]
b1    <- draws[, "beta1_NH"]

# Prepare empty tibble to store results
df_results <- tibble(
  age = numeric(),
  metric = character(),
  median = numeric(),
  l95 = numeric(),
  u95 = numeric()
)

# Loop over ages
for (k in seq_along(ages_plot)) {
  a <- ages_plot[k]
  
  # eta_H(age): with your age definition (≥1), this is alpha_H_ge1
  etaH <- aHge1
  
  # eta_NH(age): piecewise
  if (a < 1) {
    etaNH <- aNH01
  } else if (a == 2) {
    etaNH <- aNH12
  } else if (a >= 3) {
    etaNH <- b0 + b1 * age_std_mu2_grid[k]
  } else {
    # a == 1 → treat like 1–2 piece
    etaNH <- aNH12
  }
  
  # Probabilities
  den  <- 1 + exp(etaH) + exp(etaNH)
  muA  <- 1 / den
  muH  <- exp(etaH)  / den
  muNH <- exp(etaNH) / den
  
  # Summary function
  qfun <- function(x) c(median = median(x), l95 = quantile(x, 0.025), u95 = quantile(x, 0.975))
  sH   <- qfun(muH)
  sNH  <- qfun(muNH)
  
  # Append rows for this age
  df_results <- bind_rows(
    df_results,
    tibble(
      age = a,
      metric = "Mortality: human",
      median = sH[1], l95 = sH[2], u95 = sH[3]
    ),
    tibble(
      age = a,
      metric = "Mortality: natural",
      median = sNH[1], l95 = sNH[2], u95 = sNH[3]
    )
  )
}


ggplot(df_results, aes(age, median)) +
#  geom_ribbon(aes(ymin = l95, ymax = u95, fill = metric), alpha = 0.2) +
  geom_line(aes(linetype = metric)) +
  scale_y_continuous(limits = c(0,1), name = "Probability") +
  scale_x_continuous(breaks = pretty(ages_plot)) +
  labs(x = "Age (years)", linetype = NULL, fill = NULL,
       title = "Roe deer: age-specific and cause-specific mortalities") +
  theme_bw()
```

<!-- The best model indicated senescence in natural mortality from age 2 onwards (generalized logit link beta = 2·239, 95% CI: 0·942–3·535). The best model also retained a constant human-related mortality probability from age 1 onwards but a higher mortality in the first year of life after birth (human-related mortality probability 0–1 = 0·132, 95% CI: 0·053–0·294; human-related mortality probability 1+ = 0·057, 95% CI: 0·027–0·115).  -->


## Quantifying age-specific breeding

### Motivation

### Model and NIMBLE implementation

<!-- # OBS -->
<!-- # data from 2004 to 2016 -->
<!-- # 0 = not seen -->
<!-- # 1 = seen alone -->
<!-- # 2 = seen with a young of the year -->
<!-- # 3 = seen with a calf (1 to 3 years old) -->

<!-- # # STATES (6) -->
<!-- # NB Nonbreeding adult female -->
<!-- # Byoy Breeding adult female with a young‐of‐the‐year -->
<!-- # Bc1 Breeding adult female with a 1‐year‐old calf  -->
<!-- # Bc3 Breeding adult female with a 3‐year‐old calf -->
<!-- # Bc2 Breeding adult female with a 2‐year‐old calf -->
<!-- # D Dead female -->
<!-- #  -->
<!-- # # INTERMEDIATE STATES -->
<!-- # Byoy‐D Breeding adult female that had lost her young‐of‐the‐year -->
<!-- # Bc1‐D Breeding adult female that had lost her 1‐year‐ old calf -->
<!-- # Bc2‐D Breeding adult female that had lost her 2‐year‐ old calf -->
<!-- # Bc3‐leave Breeding adult female that raised her calf to the age of 3 -->

$$
\begin{matrix}
& \\
\boldsymbol{\delta} =
\left ( \vphantom{ \begin{matrix} 1 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
\pi_1 & \pi_2 & \pi_3 & \pi_4 & \pi_5 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 1 \end{matrix} } \right )
\end{matrix}
$$



$$
\begin{matrix}
& \\
\mathbf{\Phi_A} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
\phi_A & 0      & 0      & 0      & 0      & 1 - \phi_A \\
0      & \phi_A & 0      & 0      & 0      & 1 - \phi_A \\
0      & 0      & \phi_A & 0      & 0      & 1 - \phi_A \\
0      & 0      & 0      & \phi_A & 0      & 1 - \phi_A \\
0      & 0      & 0      & 0      & \phi_A & 1 - \phi_A \\
0      & 0      & 0      & 0      & 0      & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$

$$
\begin{matrix}
& \\
\mathbf{\Phi_Y} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Byoy-D} & \text{Bc1} & \text{Bc1-D} & \text{Bc2} & \text{Bc2-D} & \text{Bc3-leave} & \text{D} \\ \hdashline
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & \phi_{Y,1} & 1 - \phi_{Y,1} & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & \phi_{Y,1} & 1 - \phi_{Y,1} & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & \phi_{Y,2} & 1 - \phi_{Y,2} & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$


$$
\begin{matrix}
& \\
\mathbf{AGING} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Byoy-D} & \text{Bc1} & \text{Bc1-D} & \text{Bc2} & \text{Bc2-D} & \text{Bc3-leave} & \text{D} \\ \hdashline
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Byoy-D} \\
\text{Bc1} \\
\text{Bc1-D} \\
\text{Bc2} \\
\text{Bc2-D} \\
\text{Bc3-leave} \\
\text{D}
\end{matrix}
\end{matrix}
$$


$$
\begin{matrix}
& \\
\mathbf{BREED} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 \\
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
1 - \beta_1 & \beta_1 & 0 & 0 & 0 & 0 \\
1 - \beta_2 & \beta_2 & 0 & 0 & 0 & 0 \\
1 - \beta_2 & \beta_2 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Byoy-D} \\
\text{Bc1-D} \\
\text{Bc2-D} \\
\text{Bc3-leave} \\
\text{D}
\end{matrix}
\end{matrix}
$$


$$
\begin{matrix}
& \\
\mathbf{DETECTION} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NB} & \text{Byoy} & \text{Bc1} & \text{Bc2} & \text{Bc3} & \text{D} \\ \hdashline
1 - p_1 & p_1 & 0 & 0 & 0 & 0 \\
1 - p_2 & 0 & p_2 & 0 & 0 & 0 \\
1 - p_2 & 0 & 0 & p_2 & 0 & 0 \\
1 - p_1 & 0 & 0 & 0 & p_1 & 0 \\
1 - p_1 & 0 & 0 & 0 & p_1 & 0 \\
1 & 0 & 0 & 0 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$


$$
\begin{matrix}
& \\
\mathbf{OBS} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
1 & 2 & 3 & 4 \\ \hdashline
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 1 - q_1 & q_1 & 0 \\
0 & 1 - q_2 & 0 & q_2 \\
0 & 1 - q_2 & 0 & q_2 \\
0 & 1 - q_2 & 0 & q_2
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NB} \\
\text{Byoy} \\
\text{Bc1} \\
\text{Bc2} \\
\text{Bc3} \\
\text{D}
\end{matrix}
\end{matrix}
$$



```{r, engine = 'tikz', echo = FALSE}
\usetikzlibrary{arrows.meta, fit, positioning, automata}
\begin{tikzpicture}[
  >=Latex, node distance=24mm,
  state/.style = {circle, draw, minimum size=8mm, font=\small, align=center}
]
% Nodes
\node[state] (NB)   {NB};
\node[state, right=of NB] (Byoy) {Byoy};
\node[state, right=of Byoy] (Bc1)  {Bc1};
\node[state, right=of Bc1] (Bc2)  {Bc2};
\node[state, right=of Bc2] (Bc3)  {Bc3};
\node[state, below=12mm of Bc2] (D) {D};

% Adult survival (loops)
\draw[->] (NB)   edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Byoy) edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc1)  edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc2)  edge[loop above] node[above] {$\phi_A$} ();
\draw[->] (Bc3)  edge[loop above] node[above] {$\phi_A$} ();

% Death (to D) with labels under the arrows, slightly bent & shortened
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (NB)   to[out=-80, in=180] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Byoy) to[out=-70, in=160] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);

% --- tweaked placements ---
\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Bc1)  to[out=-55, in=145] node[pos=0.35, sloped, below] {$1-\phi_A$} (D); % label earlier to avoid crossing
\draw[->, shorten >=1.5pt, shorten <=4pt]
  (Bc2) to[out=-30, in=110]
  node[pos=0.30, sloped, below] {$1-\phi_A$} (D); % --------------------------------

\draw[->, shorten >=1.5pt, shorten <=2pt]
  (Bc3)  to[out=-60, in=60 ] node[pos=0.55, sloped, below] {$1-\phi_A$} (D);

% D absorbing
\draw[->] (D) edge[loop below] node[below] {$1$} ();

% Breeding switch
\draw[->] (NB) -- node[pos=0.5, above] {$\beta_1$} (Byoy);

% YOY survival
\draw[->] (Byoy) -- node[pos=0.5, above] {$\phi_{Y1}$} (Bc1);

% Aging with labels below the arrows
\draw[->] (Bc1) -- node[pos=0.5, below] {$1$} (Bc2);
\draw[->] (Bc2) -- node[pos=0.5, below] {$1$} (Bc3);

% Emancipation Bc3 -> NB (arc above to avoid crossing)
\draw[->] (Bc3) to[out=120, in=60, looseness=1.0]
  node[pos=0.5, above] {$1$} (NB);
\end{tikzpicture}
```



### Results and interpretation


```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","agebreeding.RData"))
MCMCsummary(out, round = 2)
```

The probability of missing an offspring when a female is actually breeding was high and was greater for YOY than for calves. The probability of observing a YOY was estimated at 0.58 (95% CI 0.46–0.68) and of observing a calf at 0.79 (95% CI 0.59–0.90). 

The detection probabilities of offspring were clearly below 1 and varied strongly over time (between 0.32 and 0.94). The detection probability also differed depending on the state of the female (Figure 3): females with a YOY or a 1‐year‐old calf had a greater detection probability than nonbreeding females or those with an older calf. 

Female survival probability was estimated at 0.97 (95% CI 0.96– 0.98) and did not differ between states. Young‐of‐the‐year and 1‐ year‐old calf survival was estimated at 0.66 (95% CI 0.51–0.79), while 2‐year‐old calf survival was estimated at 0.45 (95% CI 0.30–0.62). 

Breeding probability varied depending on the breeding state: nonbreeding females and females that had just lost their YOY or 1‐year‐old calf had a low probability of giving birth (0.33, 95% CI 0.26–0.42), whereas females that had lost their 2‐year‐old calf or raised it until the age of 3 had a greater probability of giving birth the next year (0.71, 95% CI 0.45–0.88).

## Estimating stopover duration

### Motivation 

@guerin_advances_2017 for a comparison of method, would be great to reproduce all analyses. 

Can stopover duration be framed as a life‐history trait. Usual LH traits focus primarily on reproductive timing, allocation, survival, and growth. The framework is flexible enough that one could argue it qualifies — especially when considering it as a key timing and phase length in a migratory life cycle.

From Schaub and Jenni: "Migrating animals often divide their journey into alternating phases of migration bouts and stopping over. For investigating many questions of migration ecology it is crucial (1) to estimate the duration of stopover phases, and (2) to test whether animals of different groups differ in their stopover behavior."

This nicely reframes stopover behavior as a stage-specific timing trait — akin to stages like maturation or reproductive events, but in a migratory context. It influences overall survival, energy budgets, and perhaps reproductive success under certain ecological conditions. 

* Stage timing matters: Just as age-at-first-reproduction matters, the length of each migratory phase could have fitness implications via exposure to predation, energetic costs, or reproductive timing.
* Allocating resources: Extended stopovers might be linked to resource accumulation (e.g., fat gain) before migration, similar to capital breeding strategies.
* Trade-offs and constraints: The length of stopovers could reflect a trade-off between rapid migration vs. energy recovery and safety.

### Model and NIMBLE implementation

<!-- # Three STATES  -->
<!-- # + not yet arrived in the pond (1) -->
<!-- # + arrived in the pond (2) -->
<!-- # + departed from the pond (3)] -->
<!-- #  -->
<!-- # Two OBS -->
<!-- # + not captured (1) -->
<!-- # + captured (2)]  -->

$$
\begin{matrix}
& \\
\boldsymbol{\delta} =
\left ( \vphantom{ \begin{matrix} 1 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NYA} & \text{ARR} & \text{DEP} \\ \hdashline
1 & 0 & 0
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 1 \end{matrix} } \right )
\end{matrix}
$$

$$
\begin{matrix}
& \\
\boldsymbol{\Gamma}_{g,j} =
\left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right .
\end{matrix}
\hspace{-1.2em}
\begin{matrix}
\text{NYA} & \text{ARR} & \text{DEP} \\ \hdashline
1 - r_{g,j} & r_{g,j} & 0 \\
0 & s_{g,j} & 1 - s_{g,j} \\
0 & 0 & 1
\end{matrix}
\hspace{-0.2em}
\begin{matrix}
& \\
\left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right )
\begin{matrix}
\text{NYA} \\
\text{ARR} \\
\text{DEP}
\end{matrix}
\end{matrix}
$$


```{r, engine = 'tikz', echo = FALSE}
\usetikzlibrary{arrows.meta, fit, positioning, automata}
\begin{tikzpicture}[>=Latex, node distance=28mm, state/.style={circle,draw,minimum size=8mm}]
\node[state] (NYA) {NYA};
\node[state, right=of NYA] (ARR) {ARR};
\node[state, right=of ARR] (DEP) {DEP};

\draw[->] (NYA) edge[bend left] node[above] {$r_{g,j}$} (ARR);
\draw[->] (NYA) edge[loop above] node {$1 - r_{g,j}$} ();
\draw[->] (ARR) edge[bend left] node[above] {$1 - s_{g,j}$} (DEP);
\draw[->] (ARR) edge[loop above] node {$s_{g,j}$} ();
\draw[->] (DEP) edge[loop above] node {$1$} ();
\end{tikzpicture}
```


### Results and interpretation

```{r echo = FALSE}
library(MCMCvis)
load(here::here("dat","stopover.RData"))
```

```{r echo = FALSE}
samps <- rbind(out[[1]], out[[2]])

library(tidyverse)

# samps: matrix from rbind(out[[1]], out[[2]])
df <- as.data.frame(samps) %>% mutate(iter = row_number())

# Helpers to tidy blocks like r[i,j] and s[i,j]
tidy_block <- function(df, prefix){
  df %>%
    select(iter, matches(paste0("^", prefix, "\\["))) %>%
    pivot_longer(-iter, names_to = "param", values_to = "value") %>%
    mutate(
      i = as.integer(str_match(param, paste0(prefix, "\\[(\\d+),"))[,2]),
      j = as.integer(str_match(param, ",\\s*(\\d+)\\]")[,2]),
      sex = ifelse(i == 1, "Female", "Male"),
      week = j
    ) %>%
    select(iter, sex, week, value)
}

r_long <- tidy_block(df, "r")
s_long <- tidy_block(df, "s")
```


Cumulative survival

```{r echo = FALSE}
# -------- r: arrival probability, both sexes on one figure --------
r_sum <- r_long %>%
  group_by(sex, week) %>%
  summarise(
    mean = mean(value),
    median = median(value),
    l95 = quantile(value, 0.025),
    u95 = quantile(value, 0.975),
    .groups = "drop"
  )

p_r <- ggplot(r_sum, aes(x = week, y = mean, color = sex, fill = sex, group = sex)) +
  geom_ribbon(aes(ymin = l95, ymax = u95), alpha = 0.20, linewidth = 0) +
  geom_line(size = 1) +
  labs(x = "Week", y = "Arrival probability (posterior mean & 95% CI)",
       title = "Arrival probability r by sex") +
  theme_bw() +
  theme(legend.position = "top")
p_r
```


Stopover duration

```{r echo = FALSE}
# ---- s -> expected stopover duration from each arrival week ----
# duration[w] = 1 + sum_{k=1..K-w} prod_{u=w..w+k-1} s[u]
# (stops at K-1 so staying past last week doesn't add observable time)
compute_duration_curve <- function(s_vec){
  s_vec <- pmin(s_vec, 0.999999)        # guard against s=1 exactly
  K <- length(s_vec)
  dur <- numeric(K)
  for(w in 1:K){
    if(w == K){
      dur[w] <- 1
    } else {
      dur[w] <- 1 + sum(cumprod(s_vec[w:(K-1)]))
    }
  }
  dur
}

K_weeks <- max(s_long$week)

duration_draws <- s_long %>%
  arrange(iter, sex, week) %>%
  group_by(iter, sex) %>%
  summarise(
    duration = list(compute_duration_curve(value)),
    .groups = "drop"
  ) %>%
  mutate(week = list(seq_len(K_weeks))) %>%
  unnest(c(week, duration))

duration_sum <- duration_draws %>%
  group_by(sex, week) %>%
  summarise(
    mean = mean(duration),
    median = median(duration),
    l95 = quantile(duration, 0.025),
    u95 = quantile(duration, 0.975),
    .groups = "drop"
  )

p_dur <- ggplot(duration_sum, aes(x = week, y = mean, color = sex, fill = sex, group = sex)) +
  geom_ribbon(aes(ymin = l95, ymax = u95), alpha = 0.20, linewidth = 0) +
  geom_line(size = 1) +
  labs(x = "Week", y = "Stopover duration (weeks)",
       title = "Expected stopover duration from arrival week (posterior mean & 95% CI)") +
  theme_bw() +
  theme(legend.position = "top")
p_dur
```

You can extend to time since marking (Pradel 2009) or even semi-Markov. See @guerin_advances_2017 for more. 

<!-- ## Recruitment -->

<!-- @pradel1997 -->

<!-- The purpose of the exercise is to estimate the accession to reproduction. The greater flamingo (Phoenicopterus ruber roseus) is a long-lived colonial waterbird that shows delayed maturity. No breeding attempt by a bird <3 yr old has ever been observed. The data used here come from a long term study in the Etang du Fangassier, part of the large complex of commercial salt pans of Salin de Giraud in the Camargue (southern France). They have been collected by the biological station of Tour du Valat and previously analyzed by Pradel et al. (1997). The data concern 7822 individuals ringed as young from 1977 to 1988 and resighted as breeders between 1983 and 1994. Of these, 1680 have been resighted breeding at least once. The observations as Pre-Breeder (chicks only) are coded 1. The observations as Breeder are coded 2. The capture histories are given in file FLAMINGO.TXT -->

<!-- Transition matrix: -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Gamma} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           z_t=J & z_t=1yNB & z_t=2yNB & z_t=B & z_t=D \\ \hdashline -->
<!--           0 & \phi_1 (1-\alpha_1) & 0 & \phi_1 \alpha_1 & 1 - \phi_1\\ -->
<!--           0 & 0 & \phi_2 (1-\alpha_2) & \phi_2 \alpha_2 & 1 - \phi_2\\ -->
<!--           0 & 0 & 0 & \phi_3 & 1 - \phi_3\\ -->
<!--           0 & 0 & 0 & \phi_B & 1 - \phi_B\\ -->
<!--           0 & 0 & 0 & 0 & 1 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t-1} = J \\ z_{t-1} = 1yNB \\ z_{t-1} = 2yNB \\ z_{t-1} = B \\ z_{t-1} = D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->

<!-- First-year and second-year individuals breed with probabilities $\alpha_1$ and $\alpha_2$. Then, everybody breeds from age 3. -->

<!-- Observation matrix: -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Omega} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           y_t = 1 & y_t = 2 & y_t = 3 & y_t = 4\\ \hdashline -->
<!--           1 & 0 & 0 & 0\\ -->
<!--           1 - p_1 & p_1 & 0 & 0\\ -->
<!--           1 - p_2 & 0 & p_2 & 0\\ -->
<!--           1 - p_3 & 0 & 0 & p_3\\ -->
<!--           1 & 0 & 0 & 0 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \\ 12 \\12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_t = J \\ z_t = 1yNB \\ z_t = 2yNB \\ z_t = B \\ z_t = D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->

<!-- Juveniles are never detected. -->




<!-- ## Tradeoffs {#casestudytradeoff} -->

<!-- @morano_life-history_2013, @shefferson_life_2003, and @cruz-flores_sex-specific_nodate -->

<!-- Case study with simulations as in Oikos paper, see Figure 1 and Table 2. Would be a nice example of the use of simulations. Another example could the statistical power analyses. -->

<!-- Also consider paper by Sarah on red-footed boobies.  -->

<!-- ## Breeding dynamics -->

<!-- @pradel_breeding_2012, @desprez_now_2011, @desprez_known_2013, and @pacoureau_population_2019 -->

<!-- ## Using data on dead recoveries -->

<!-- ### Ring recovery simple model -->

<!-- ### Combination of live captures and dead recoveries -->

<!-- Combine live recapture w/ dead recoveries by @lebreton1999. -->

<!-- Transition matrix -->


<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Gamma} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           z_t=A & z_t=JD & z_t=D \\ \hdashline -->
<!--           s & 1-s & 0\\ -->
<!--           0 & 0 & 1\\ -->
<!--           0 & 0 & 1 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t-1}=\text{alive} \\ z_{t-1}=\text{just dead} \\ z_{t-1}=\text{dead for good} -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->



<!-- Observation matrix -->

<!-- $$\begin{matrix} -->
<!-- & \\ -->
<!-- \mathbf{\Omega} = -->
<!--   \left ( \vphantom{ \begin{matrix} 12 \\ 12 \\ 12\end{matrix} } \right . -->
<!--           \end{matrix} -->
<!--           \hspace{-1.2em} -->
<!--           \begin{matrix} -->
<!--           y_t=1 & y_t=2 & y_t=3 \\ \hdashline -->
<!--           1 - p & 0 & p\\ -->
<!--           1 - r & r & 0\\ -->
<!--           1 & 0 & 0 -->
<!--           \end{matrix} -->
<!--           \hspace{-0.2em} -->
<!--           \begin{matrix} -->
<!--           & \\ -->
<!--           \left . \vphantom{ \begin{matrix} 12 \\ 12 \\ 12 \end{matrix} } \right ) -->
<!-- \begin{matrix} -->
<!-- z_{t}=A \\ z_{t}=JD \\ z_{t}=D -->
<!-- \end{matrix} -->
<!-- \end{matrix}$$ -->


<!-- ### Cause-specific mortalities -->

<!-- @koons2014, @fernandez-chacon_causes_2016 and @ruette_comparative_2015 -->

<!-- ## Actuarial senescence -->

<!-- @choquet_semi-markov_2011, @peron_evidence_2016 and @marzo2011. -->


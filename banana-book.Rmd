---
title: "Bayesian analysis of capture-recapture data with hidden Markov models"
subtitle: "Theory and case studies in R and NIMBLE"
author: "Olivier Gimenez"
date: "`r Sys.Date()`"
documentclass: krantz
bibliography: [book.bib]
#biblio-style: apalike
link-citations: yes
colorlinks: yes
lot: yes
lof: yes
fontsize: 12pt
site: bookdown::bookdown_site
description: "This is a textbook on the analysis of capture-recapture data with hidden Markov models (HMM) implemented in the Bayesian framework with R and NIMBLE."
url: 'https://oliviergimenez.github.io/banana-book/'
github-repo: oliviergimenez/banana-book
header-includes: 
  - \usepackage{tikz}
  - \usepackage{pgfplots}
  - \usepackage{blkarray}
  - \pgfplotsset{compat=1.18} 
  - \usepackage{tcolorbox}
  - \usepackage{arydshln}
  - \newtcolorbox{blackbox}{
    colback=white,
    colframe=purple,
    coltext=black,
    boxsep=5pt,
    arc=4pt}
  - \usepackage{subfig}
# Warning: Package pgfplots Warning: running in backwards compatibility mode (unsuitable tick labels; missing features). Consider writing \pgfplotsset{compat=1.18} into your preamble.
---

# Warning: Package pgfplots Warning: running in backwards compatibility mode (unsuitable tick labels; missing features). Consider writing \pgfplotsset{compat=1.18} into your preamble.

Placeholder


## License {-}

<!--chapter:end:index.Rmd-->


# Preface {-}

Placeholder


## Why this book? {-}
## Who should read this book? {-}
## What will you learn? {-}
## What won't you learn? {-}
## Prerequisites {-}
## How this book was written {-}
## About the author {-}
## Acknowledgements {-}

<!--chapter:end:0-preface.Rmd-->

```{r include=FALSE, cache=FALSE}
# packages
library(tidyverse)
theme_set(theme_light(base_size = 14))
library(nimble)
library(MCMCvis)
library(magick)
library(pdftools)
library(wesanderson)
library(RColorBrewer)
library(patchwork)
library(emo)
#library(nimbleEcology)
#library(basicMCMCplots)

# R options
options(width = 60)

# chunk options
knitr::opts_chunk$set(
  comment = "##",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
  )
```
\mainmatter

# (PART) Foundations {-}

# Introduction {-}

WORK IN PROGRESS

This first part `Foundations` is aimed at getting you up-to-speed with Bayesian statistics, NIMBLE, and hidden Markov models.

<!--chapter:end:introductionpartone.Rmd-->


# Bayesian statistics & MCMC {#crashcourse}

Placeholder


## Introduction
## Bayes' theorem
## What is the Bayesian approach?	
## Approximating posteriors via numerical integration {#numerical-approx}
## Markov chain Monte Carlo (MCMC)
### Monte Carlo integration
### Markov chains {#markovmodelmcmc}
### Metropolis algorithm {#metropolis-algorithm}
## Assessing convergence {#convergence-diag}
### Burn-in
### Chain length
### What if you have issues of convergence?
## Summary
## Suggested reading 

<!--chapter:end:1-bayesmcmc.Rmd-->


# NIMBLE tutorial {#intronimble}

Placeholder


## Introduction
## What is NIMBLE?
## Getting started {#start-nimble}
## Programming {#functions-in-nimble}
### NIMBLE functions
### Calling R/C++ functions {#callrfninnimble}
### User-defined distributions
## Under the hood {#under-the-hood}
## MCMC samplers
### Default samplers {#change-sampler}
### User-defined samplers
## Tips and tricks
### Precision vs standard deviation
### Indexing
### Faster compilation
### Updating MCMC chains
### Reproducibility {#tipreproducibility}
### Parallelization
### Incomplete and incorrect initialization
### Vectorization
## Summary
## Suggested reading

<!--chapter:end:2-nimble.Rmd-->


# Hidden Markov models {#hmmcapturerecapture}

Placeholder


## Introduction
## Longitudinal data
## A Markov model for longitudinal data
### Assumptions
### Transition matrix
### Initial states
### Likelihood
### Example
## Bayesian formulation
## NIMBLE implementation
## Hidden Markov models
### Capture-recapture data {#capturerecapturedata}
### Observation matrix
### Hidden Markov model
### Likelihood {#likelihoodhmm}
## Fitting HMM with NIMBLE {#fittinghmmnimble}
## Marginalization {#marginalization}
### Brute-force approach
### Forward algorithm {#forward-algorithm}
### NIMBLE implementation {#nimblemarginalization}
#### Do it yourself {#diymarginalisation}
#### Do it with `nimbleEcology`
## Pooled encounter histories {#pooled-likelihood}
## Decoding after marginalization {#decoding}
### Theory {#viterbi-theory}
### Implementation
### Compute first, average after {#compute-average}
### Average first, compute after
## Summary
## Suggested reading

<!--chapter:end:3-hmm.Rmd-->

```{r include=FALSE, cache=FALSE}
# packages
library(tidyverse)
theme_set(theme_light(base_size = 14))
library(nimble)
library(MCMCvis)
library(magick)
library(pdftools)
library(wesanderson)
library(RColorBrewer)
library(patchwork)
library(emo)
#library(nimbleEcology)
#library(basicMCMCplots)

# R options
options(width = 60)

# chunk options
knitr::opts_chunk$set(
  comment = "##",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
  )
```
# (PART) Transitions {-}

# Introduction {-}

WORK IN PROGRESS

This second part `Transitions` will teach you all about capture-recapture models for open populations, with reproducible R code to ease the learning process.

<!--chapter:end:introductionparttwo.Rmd-->


# Alive and dead {#survival}

Placeholder


## Introduction
## The Cormack-Jolly-Seber (CJS) model
## Capture-recapture data 
## Fitting the CJS model to the dipper data with NIMBLE
## CJS model derivatives {#cjsderivatives}
## Model comparison with WAIC {#waic}
## Goodness of fit {#gof}
### Posterior predictive checks
### Classical tests
### Design considerations
## Covariates {#covariates}
### Temporal covariates
#### Discrete 
#### Continuous
### Individual covariates
#### Discrete
#### Continuous 
### Several covariates
### Random effects
### Individual time-varying covariates
## Why Bayes? Incorporate prior information {#elicitprior}
### Prior elicitation
### Moment matching
## Summary
## Suggested reading

<!--chapter:end:4-survive.Rmd-->


# Sites and states {#dispersal}

Placeholder


## Introduction
## The Arnason-Schwarz (AS) model {#ASmodel}
### Theory
## Fitting the AS model {#ASmodelfitting}
### Geese data
### NIMBLE implementation
### Goodness of fit {#gofas}
## What if more than 2 sites?
### Dirichlet prior
### Multinomial logit {#multinomiallogit}
## Sites may be states {#states}
### Titis data 
### The AS model for states
### NIMBLE implementation
## Issue of local minima {#localminima}
## Uncertainty {#multievent}
### Breeding states {#breedingmultievent}
### Disease states {#diseasemultievent}
## Summary
## Suggested reading

<!--chapter:end:5-move.Rmd-->

```{r include=FALSE, cache=FALSE}
# packages
library(tidyverse)
theme_set(theme_light(base_size = 14))
library(nimble)
library(MCMCvis)
library(magick)
library(pdftools)
library(wesanderson)
library(RColorBrewer)
library(patchwork)
library(emo)
#library(nimbleEcology)
#library(basicMCMCplots)

# R options
options(width = 60)

# chunk options
knitr::opts_chunk$set(
  comment = "##",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
  )
```
# (PART) Case studies {-}

# Introduction {-}

This third part `Case studies` provides real-world case studies from the scientific literature that you can reproduce using material covered in previous chapters. These problems can either i) be used to cement and deepen your understanding of methods and models, ii) be adapted for your own purpose, or iii) serve as teaching projects. For each case study, I recall the ecological question, then build the model step by step and conclude by discussing the results. The code and data are available **say where**. 

<!--chapter:end:introductionpartthree.Rmd-->


# Covariates {#covariateschapter}

Placeholder


## Covariate selection with reversible jump MCMC
## Missing values {#naincov}
## Sex uncertainty
## Nonlinearities
## Spatial

<!--chapter:end:6-covariates.Rmd-->


# Lack of fit {#lackoffit}

Placeholder


## Individual heterogeneity
## Trap dep {#trapdep}
## Transience {#transience}
## Temporary emigration
## Memory model {#memorymodel}
## Posterior predictive check {#ppchecks}

<!--chapter:end:7-lackoffit.Rmd-->


# Life history {#tradeoffs}

Placeholder


## Access to reproduction
## Tradeoffs {#casestudytradeoff}
## Breeding dynamics
## Using data on dead recoveries
### Ring recovery simple model
### Combination of live captures and dead recoveries
### Cause-specific mortalities
## Stopover duration
## Actuarial senescence
## Uncertainty in age
## Uncertainty in age and size

<!--chapter:end:8-lifehistory.Rmd-->

```{r include=FALSE, cache=FALSE}
# packages
library(tidyverse)
theme_set(theme_light(base_size = 14))
library(nimble)
library(MCMCvis)
library(magick)
library(pdftools)
library(wesanderson)
library(RColorBrewer)
library(patchwork)
library(emo)
#library(nimbleEcology)
#library(basicMCMCplots)

# R options
options(width = 60)

# chunk options
knitr::opts_chunk$set(
  comment = "##",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
  )
```
# Conclusion {-}

I hope to have convinced you that hidden Markov models combined with the Bayesian framework are very flexible to analyse capture-recapture data. With your data, you may ask a myriad of questions. The limit is your imagination (and CPU time). 

Let me leave you with a few pieces of advice. This is not rocket science, just a few things based on my own experience of building HMM to analyse data with Bayesian statistics.

+ **Make your ecological question explicit.** First things first. Make sure you've spent some to time to make your ecological question explicit. This step will help you to stay on course, and make the right choices. For example, it's fine to use subsets of your data to address different questions.

+ Now in terms of modeling. **Think of observations and states first.** Don't jump on your keyboard right away. Spend some time thinking about your model with pen and paper. In particular make sure you have the observations and the states of your HMM. **Then write down the observation and transition matrices on paper.** Write down the transition matrix. You may act as if you had no imperfect detection. This is really what you're after, the ecological process (survival, dispersal, etc). Proceed with the observation matrix.

+ When it comes to model fitting with NIMBLE, **start simple**, with all parameters constant for example. Make sure convergence is reached. Then **add complexity one step at a time**. Time effect for example, or random effects, or uncertainty in the assignment of states.

+ **Consider doing simulations** to better understand your model. When it comes to model building, consider simulating data to better understand your model. You will always learn something on your model by seeing it an engine to generate data, instead of estimating its parameters. The nice thing with NIMBLE is that you can use your model to simulate data.

+ Another advice, quite general in programming, is to not try to optimize your code or to try to make it elegant right away. **Make your model work first, then think of optimization**.


<!--chapter:end:999-conclusions.Rmd-->

```{r include=FALSE, cache=FALSE}
# packages
library(tidyverse)
theme_set(theme_light(base_size = 14))
library(nimble)
library(MCMCvis)
library(magick)
library(pdftools)
library(wesanderson)
library(RColorBrewer)
library(patchwork)
library(emo)
#library(nimbleEcology)
#library(basicMCMCplots)

# R options
options(width = 60)

# chunk options
knitr::opts_chunk$set(
  comment = "##",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
  )
```
\backmatter

`r if (knitr:::is_html_output()) '
# References {-}
'`

<!--chapter:end:references.Rmd-->

